{% extends "base.html" %}
{% import 'macros/hidden_args.jinja2' as macros %}
{% set page_name = "objects" %}
{% block content %}
<style>
  /* Header en grille 3 colonnes */
  .obj-hdr       { cursor:pointer; user-select:none; }
  .obj-grid      { display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; }
  .obj-main      { min-width:0; display:flex; flex-direction:column; gap:.25rem; }

  /* Titre tr√®s compact dans un badge */
  .title-badge   { display:inline-block; max-width:100%; white-space:normal; line-height:1.1;
                   border:1px solid var(--bs-border-color); background:var(--bs-secondary-bg);
                   color:var(--bs-body-color); padding:.15rem .5rem; border-radius:999px;
                   font-weight:600; font-size:.9rem; } /* taille r√©duite */

  /* Chips sous le titre, √† droite, sans d√©bordement */
  .chips         { display:flex; flex-wrap:wrap; gap:.25rem; justify-content:flex-end; max-width:100%; }
  .chips .badge  { font-weight:600; font-size:.65rem; padding:.35em .55em; white-space:nowrap; }
  /* Ic√¥ne statut √† droite */
  .obj-status i  { font-size:1.2rem; }
  @media (max-width: 575.98px) {
    .card-body .fs-5,
    .card-body .fs-md-4 {
      font-size: 1rem !important;
    }
    .card-body .small.fw-bold {
      font-size: 0.75rem;
    }
  }
  .obj-grid > *:last-child {
  flex-shrink: 0;
}
.card.focus-ring {
  box-shadow: none !important;
  outline: none !important;
}
.card-header:focus {
  outline: none !important;
  box-shadow: none !important;
}
.thumb-acc-flag {
  position: absolute;
  right: 4px;   /* d√©bord √† droite */
  top:   4px;   /* d√©bord en haut */
  font-size: 0.65rem; /* plus petit */
  line-height: 1;
  z-index: 2;
  pointer-events: none; /* ne g√™ne pas les clics sur le header */
}
.bg-purple {
  background-color: #b48ef1 !important; /* violet bootstrap-like */
  color: #fff !important;
}
.bg-purple-subtle {
  background-color: #e9d8fd !important; /* violet clair */
  color: #4b0082 !important; /* indigo fonc√© pour le texte */
}
.text-purple {
  color: #b48ef1 !important;
}
.bg-grey {
  background-color: #6c757d !important;
  color: #fff !important;
}
.text-grey {
  color:  #6c757d !important;
}
</style>
<!-- Boutons flottants (identiques au reste) -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">üìÑ</button>
</div>
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">üîç</button>
</div>
{% if items|length == 0 %}
  <div class="alert alert-light border d-flex align-items-center" role="alert">
    <i class="bi bi-inbox me-2"></i>
    <div>Aucun objet ne correspond aux filtres.</div>
  </div>
{% endif %}
{% if items|length != 0 %}
<!-- Tuiles statistiques (align√©es sur print_history) -->
<div class="row row-cols-4 g-3 g-md-3 mb-4 text-center align-items-stretch">
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üì¶</div>
        <div class="small fw-bold">{{ available_count }}/{{ total_objects }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üõí</div>
        <div class="small fw-bold">{{ sold_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üè†</div>
        <div class="small fw-bold">{{ personal_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üéÅ</div>
        <div class="small fw-bold">{{ gifted_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üí∂</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_sold_price) }} {{ currencysymbol or '‚Ç¨' }}
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üìà</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_margin) }} {{ currencysymbol or '‚Ç¨' }}
        </div>
      </div>
    </div>
  </div>
  {# üéØ Prix souhait√© (total) #}
<div class="col">
  <div class="card border border-secondary-subtle shadow-sm h-100">
    <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
      <div class="fs-5 fs-md-4">üéØ</div>
      <div class="small fw-bold">
        {{ '%.2f'|format(sum_desired_price or 0) }} {{ currencysymbol or '‚Ç¨' }}
      </div>
    </div>
  </div>
</div>

{# üßÆ Marge th√©orique (total) #}
<div class="col">
  <div class="card border border-secondary-subtle shadow-sm h-100">
    <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
      <div class="fs-5 fs-md-4">üßÆ</div>
      <div class="small fw-bold">
        {{ '%.2f'|format(sum_theoretical_margin or 0) }} {{ currencysymbol or '‚Ç¨' }}
      </div>
    </div>
  </div>
</div>
</div>
{% endif %}

{# ------------------------------- #}
{# FLUX FUSIONN√â : GROUPES + PRINTS
   items = [{type: 'group'|'object', created_at, group|object}] #}
{# ------------------------------- #}

{% if items and items|length > 0 %}
  <div class="d-flex flex-column gap-1 mt-1">

    {% for it in items %}
      {% if it.type == 'group' %}
  {% set g = it.group %}

  <div class="card shadow-sm object-card" id="group_{{ g.id }}">
    {# === HEADER COLLAPSABLE identique aux objets === #}
    <div
      id="heading_group_{{ g.id }}"
      class="card-header obj-hdr"
      role="button"
      data-bs-toggle="collapse"
      data-bs-target="#group_body_{{ g.id }}"
      aria-expanded="false"
      aria-controls="group_body_{{ g.id }}"
    >
      <div class="obj-grid">
        {# GAUCHE ‚Äî statut groupe: ic√¥ne dossier + pastille nombre d‚Äôobjets #}
<div class="obj-status d-flex align-items-center justify-content-start me-1 flex-shrink-0">
  <span class="position-relative d-inline-block" style="font-size: 1rem; line-height: 1;">
    <span class="emoji-folder" style="position: relative; display: inline-block;">
      <i class="bi bi-folder-fill text-grey" aria-hidden="true"></i>
      <span class="badge bg-primary rounded-pill"
            style="
              position: absolute;
              top: 0;
              right: -0.4rem;
              transform: translate(50%, -50%);
              font-size: 0.6rem;
              padding: 0.15em 0.4em;
            ">
         {{ g.total }}
      </span>
    </span>
  </span>
</div>

        <!-- Colonne centre : titre + chips -->
<div class="obj-main d-flex flex-column align-items-center text-center px-1" style="max-width: 100%;">
  <!-- Badge nom du groupe -->
  <div class="w-100" style="max-width: 200px;">
    <div class="badge bg-grey text-white small fw-semibold text-break w-100" 
         style="white-space: normal; word-break: break-word;">
      {{ g.name }}
    </div>
  </div>

  <!-- Chips du groupe -->
  <div class="chips justify-content-center flex-wrap mt-1 gap-1 w-100" style="max-width: 220px;">
    <span class="badge rounded-pill bg-light text-dark border border-secondary fw-normal" 
          style="font-size: 0.65rem; padding: 0.2em 0.45em;">
      üì¶ {{ g.available }} / {{ g.total }}
    </span>

    {% set _sold = g.sum_sold_price or 0 %}
{% set _margin = g.sum_margin or 0 %}
{% set _pos = _margin >= 0 %}

{% if _sold != 0 %}
  <span class="badge rounded-pill bg-primary text-white border fw-normal" 
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    üí∂ {{ "%.2f"|format(_sold) }} {{ currencysymbol }}
  </span>
{% endif %}

{% if _margin != 0 %}
  <span class="badge rounded-pill {{ 'bg-success text-white' if _pos else 'bg-danger text-white' }} border fw-normal" 
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    {{ 'üìà' if _pos else 'üìâ' }} {{ '%.2f'|format(_margin) }} {{ currencysymbol }}
  </span>
{% endif %}
{% if g.sum_desired_price %}
  <span class="badge rounded-pill bg-purple text-white border fw-normal"
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    üéØ {{ '%.2f'|format(g.sum_desired_price) }} {{ currencysymbol }}
  </span>
{% endif %}

{% if g.sum_theoretical_margin is not none and g.sum_theoretical_margin != 0 %}
  {% set _pos_th = g.sum_theoretical_margin >= 0 %}
  <span class="badge rounded-pill {{ 'bg-success text-white' if _pos_th else 'bg-danger text-white' }} border fw-normal"
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    üßÆ {{ '%.2f'|format(g.sum_theoretical_margin) }} {{ currencysymbol }}
  </span>
{% endif %}
  </div>
</div>

        {# DROITE ‚Äî visuel du dernier print #}
		<div class="text-end flex-shrink-0">
  <div class="thumb position-relative" style="--thumb-size: 48px;">
    {% if g.preview_thumb %}
      <img src="{{ g.preview_thumb }}" alt="" class="thumb-img">
    {% else %}
      <div class="thumb-ph" title="Aucune image"></div>
    {% endif %}
  </div>
</div>
      </div>
    </div>

    {# === CORPS COLLAPSABLE : table des objets du groupe === #}
    <div id="group_body_{{ g.id }}" class="collapse" data-bs-parent="">
	<div class="d-flex align-items-center justify-content-end gap-2">
  <div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      Actions
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renameGroupModal_{{ g.id }}">
          üìù Renommer
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addGroupAccModal_{{ g.id }}">
          üß∞ Ajouter un accessoire √† tous
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#remGroupAccModal_{{ g.id }}">
          üß∫ Retirer un accessoire √† tous
        </a>
      </li>
	  <li>
  <a class="dropdown-item" href="#"
     data-bs-toggle="modal" data-bs-target="#setGroupWishPriceModal_{{ g.id }}">
    üéØ D√©finir prix souhait√© (groupe)
  </a>
</li>
    </ul>
  </div>
</div>
      <div class="d-flex flex-column gap-1 mt-1 card-body p-0">
        {% if g.objects and g.objects|length > 0 %}
                {% for o in g.objects %}
                  {% set _obj_accessories = obj_accessories if obj_accessories is defined else {} %}
                  {% set _obj_tags = obj_tags if obj_tags is defined else {} %}
                  {% set _args = args if args is defined else {} %}
                  {% include 'fragments/object_row.html' %}
                {% endfor %}
        {% else %}
          <div class="p-3 text-muted">Aucun objet (selon les filtres).</div>
        {% endif %}
      </div>
	  <div class="px-3 pt-2">
  <div class="mb-2">
    <strong>Tags (groupe) :</strong>
    <div class="d-flex flex-wrap gap-1 align-items-center">
      {% if g.tags and g.tags|length > 0 %}
        {% for tag in g.tags %}
          <span class="badge bg-primary">
            {{ tag }}
            <form class="d-inline" method="post"
                  action="{{ url_for('objects_group_remove_tag', group_id=g.id) }}"
                  data-requires-write>
              {{ macros.render_filtered_args(args) }}
              <input type="hidden" name="tag" value="{{ tag }}">
              <button type="submit" class="btn-close btn-close-white btn-sm ms-1"
                      aria-label="Supprimer le tag ¬´ {{ tag }} ¬ª"></button>
            </form>
          </span>
        {% endfor %}
      {% else %}
        <span class="text-muted">Aucun</span>
      {% endif %}
    </div>
  </div>

  <form class="input-group mt-1" style="max-width: 300px;"
        method="post"
        action="{{ url_for('objects_group_add_tag', group_id=g.id) }}"
        data-requires-write>
    {{ macros.render_filtered_args(args) }}
    <input type="text" class="form-control form-control-sm"
           name="tag" placeholder="Nouveau tag‚Ä¶ (s√©pare par , ou ;)">
    <button class="btn btn-sm btn-success" type="submit">‚úö Ajouter</button>
  </form>
</div>
    </div>
  </div>
  
  <div class="modal fade" id="setGroupWishPriceModal_{{ g.id }}" tabindex="-1"
     aria-labelledby="setGroupWishPriceLabel_{{ g.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post"
          action="{{ url_for('objects_group_set_desired_price_all', group_id=g.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="setGroupWishPriceLabel_{{ g.id }}">
          üéØ Prix de vente souhait√© ‚Äî Groupe #{{ g.id }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted">
          Objets cibl√©s‚ÄØ: <b>{{ g.available }}</b> disponible(s).
        </div>

        <label class="form-label">Prix souhait√© ({{ currencysymbol or '‚Ç¨' }})</label>
        <input type="number" step="0.01" min="0" name="desired_price"
               class="form-control" placeholder="Laisser vide pour supprimer sur tout le groupe">

        <div class="form-check mt-3">
          <input class="form-check-input" type="checkbox" value="1" id="onlyEmpty_{{ g.id }}" name="only_if_empty" checked>
          <label class="form-check-label" for="onlyEmpty_{{ g.id }}">
            Ne pas √©craser les prix d√©j√† d√©finis
          </label>
        </div>

        <div class="form-text mt-2">
          Appliqu√© uniquement aux objets <b>disponibles</b>.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Appliquer au groupe</button>
      </div>
    </form>
  </div>
</div>
  
	  {# --- MODALE: Renommer groupe --- #}
<div class="modal fade" id="renameGroupModal_{{ g.id }}" tabindex="-1" aria-labelledby="renameGroupLabel_{{ g.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_rename_group') }}">
      {{ macros.render_filtered_args(args) }}
      <input type="hidden" name="group_id" value="{{ g.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="renameGroupLabel_{{ g.id }}">üìù Renommer le groupe #{{ g.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" name="group_name" value="{{ g.name }}" placeholder="Nouveau nom">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>

{# --- MODALE: Ajouter un accessoire √† tous les objets du groupe --- #}
<div class="modal fade" id="addGroupAccModal_{{ g.id }}"
     data-group-size="{{ g.total }}" tabindex="-1" aria-labelledby="addGroupAccLabel_{{ g.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('objects_group_add_accessory_all', group_id=g.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="addGroupAccLabel_{{ g.id }}">‚ûï Ajouter un accessoire √† tous (Groupe #{{ g.id }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- Recherche accessoire -->
        <div class="mb-3">
          <label class="form-label">Accessoire</label>
          <input type="text" class="form-control" id="grpAccSearch_{{ g.id }}" placeholder="Rechercher un accessoire (nom)‚Ä¶">
          <div class="list-group mt-2" id="grpAccResults_{{ g.id }}" style="max-height: 240px; overflow:auto;"></div>
          <input type="hidden" name="accessory_id" id="grpAccId_{{ g.id }}">
        </div>

        <!-- S√©lection courante -->
        <div id="grpAccSelected_{{ g.id }}" class="d-none">
          <div class="d-flex align-items-center gap-2">
            <img id="grpAccSelectedImg_{{ g.id }}" src="{{ url_for('static', filename='placeholder.png') }}" width="40" height="40" class="rounded border" style="object-fit:cover;">
            <div class="flex-grow-1">
              <div class="fw-semibold" id="grpAccSelectedName_{{ g.id }}"></div>
              <div class="text-muted small">Stock dispo : <span id="grpAccAvail_{{ g.id }}">0</span></div>
            </div>
          </div>
        </div>

        <!-- Quantit√© -->
        <div class="mt-3">
          <label class="form-label">Quantit√© (par objet)</label>
          <input type="number" class="form-control" name="qty" id="grpAccQty_{{ g.id }}" min="1" value="1" required>
          <div class="form-text">La quantit√© ne peut pas d√©passer le stock disponible au moment de l‚Äôajout, objet par objet.</div>
        </div>
      </div>
		<div id="grpAccInfo_{{ g.id }}" class="mt-2 small text-muted"></div>
		<div id="grpAccWarn_{{ g.id }}" class="mt-2 small text-danger d-none"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary" id="grpAccSubmitBtn_{{ g.id }}" disabled>Ajouter √† tous</button>
      </div>
    </form>
  </div>
</div>

{# --- MODALE: Retirer un accessoire √† tous les objets du groupe --- #}
<div class="modal fade" id="remGroupAccModal_{{ g.id }}" tabindex="-1" aria-labelledby="remGroupAccLabel_{{ g.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('objects_group_remove_accessory_all', group_id=g.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="remGroupAccLabel_{{ g.id }}">‚ûñ Retirer un accessoire √† tous (Groupe #{{ g.id }})</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- Recherche accessoire -->
        <div class="mb-3">
          <label class="form-label">Accessoire</label>
          <input type="text" class="form-control" id="grpRemAccSearch_{{ g.id }}" placeholder="Rechercher un accessoire (nom)‚Ä¶">
          <div class="list-group mt-2" id="grpRemAccResults_{{ g.id }}" style="max-height: 240px; overflow:auto;"></div>
          <input type="hidden" name="accessory_id" id="grpRemAccId_{{ g.id }}">
        </div>

        <!-- Option: tout retirer -->
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" value="1" id="grpRemAll_{{ g.id }}">
          <label class="form-check-label" for="grpRemAll_{{ g.id }}">
            Supprimer enti√®rement l‚Äôaccessoire pour chaque objet du groupe
          </label>
        </div>

        <!-- Quantit√© -->
        <div class="mt-2" id="grpRemQtyWrap_{{ g.id }}">
          <label class="form-label">Quantit√© √† retirer (par objet)</label>
          <input type="number" class="form-control" name="qty" id="grpRemAccQty_{{ g.id }}" min="1" value="1">
          <div class="form-text">Laisser vide (ou cocher ci-dessus) pour supprimer enti√®rement.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-danger" id="grpRemAccSubmitBtn_{{ g.id }}" disabled>Retirer de tous</button>
      </div>
    </form>
  </div>
</div>
      {% else %}
        {# ---- Rendu d'un PRINT isol√© (mini-table 1 ligne pour r√©utiliser object_row) ---- #}
        {% set o = it.object %}
        
              {% set _obj_accessories = obj_accessories if obj_accessories is defined else {} %}
              {% set _obj_tags = obj_tags if obj_tags is defined else {} %}
              {% set _args = args if args is defined else {} %}
              {% include 'fragments/object_row.html' %}
      {% endif %}
    {% endfor %}

  </div>
{% else %}
  <div class="mt-4 text-muted">Aucun r√©sultat.</div>
{% endif %}

<!-- Offcanvas filtres -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2">
      {{ macros.render_filtered_args(args, ['search','sale_filter','source_type','available','page']) }}
      <div class="col-12 col-md-4">
        <label class="form-label">Recherche</label>
        <input type="text" name="search" class="form-control" value="{{ filters.search or '' }}" placeholder="Nom de l‚Äôobjet‚Ä¶">
      </div>
	    <div class="col-6 col-md-3">
    <label for="sale_filter" class="form-label mb-1">Vente</label>
    <select id="sale_filter" name="sale_filter" class="form-select">
      {% set curr_sale = args.get('sale_filter','') %}
      {% if not curr_sale %}
        {# r√©tro-compat: si ancien sold_filter/available pr√©sents #}
        {% set old_sold = args.get('sold_filter','') %}
        {% set old_av   = args.get('available','') %}
        {% if old_sold == 'yes' %}{% set curr_sale = 'vendus' %}
        {% elif old_av == 'yes' %}{% set curr_sale = 'dispo' %}
        {% endif %}
      {% endif %}
      <option value="" {{ '' == curr_sale and 'selected' or '' }}>Tous</option>
      <option value="dispo"  {{ 'dispo'  == curr_sale and 'selected' or '' }}>Disponibles</option>
      <option value="perso"  {{ 'perso'  == curr_sale and 'selected' or '' }}>Perso</option>
      <option value="vendus" {{ 'vendus' == curr_sale and 'selected' or '' }}>Vendus</option>
      <option value="offert" {{ 'offert' == curr_sale and 'selected' or '' }}>Offerts</option>
    </select>
  </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Source</label>
        <select name="source_type" class="form-select">
          <option value="">‚Äî Indiff√©rent ‚Äî</option>
          <option value="print" {% if filters.source_type=='print' %}selected{% endif %}>Print</option>
          <option value="group" {% if filters.source_type=='group' %}selected{% endif %}>Groupe</option>
        </select>
      </div>
      <div class="col-12 col-md-2 align-self-end text-end">
        <button class="btn btn-primary" type="submit">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- Offcanvas pagination -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <input type="number" min="1" max="{{ total_pages }}" name="page" value="{{ page }}"
               class="form-control form-control-sm" style="width: 56px;">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
{% set endpoint = 'objects_page' %}
{% set pages = total_pages %}
{% include 'components/pagination.html' %}
<div style="height: 4rem;"></div>
{% endblock %}

{% block scripts %}
<script src="{{  asset_url('js/print_history.js') }}"></script>
<script>
document.addEventListener('shown.bs.modal', function (e) {
  const modal = e.target;
  if (!modal.id || !modal.id.startsWith('sellModal_')) return;

  const priceInput = modal.querySelector('input[name="sold_price"]');
  const personalCb = modal.querySelector('input[name="sold_personal"]');

  const setPersonalEnabled = () => {
    const v = (priceInput?.value || "").trim();
    // Vide => route interpr√®te 0.0 ‚áí on autorise la case
    const num = v === "" ? 0 : Number(v);
    const enable = !Number.isNaN(num) && num === 0;
    if (personalCb) {
      personalCb.disabled = !enable;
      if (!enable) personalCb.checked = false;
    }
  };

  // init
  setPersonalEnabled();
  priceInput?.addEventListener('input', setPersonalEnabled);

  // logique existante de date par d√©faut (on la laisse)
  const inputDate = modal.querySelector('input[name="sold_date"]');
  if (inputDate && !inputDate.value) {
    const today = new Date().toISOString().slice(0, 10);
    inputDate.value = today;
  }
});
  // Smooth scroll quand on ouvre un item, m√™me logique que tes autres pages
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".card-header[data-bs-toggle='collapse']").forEach(header => {
      header.addEventListener("click", () => {
        const targetSelector = header.getAttribute("data-bs-target");
        const target = document.querySelector(targetSelector);
        if (!target.classList.contains("show")) {
          setTimeout(() => {
            const y = header.getBoundingClientRect().top + window.scrollY - 20;
            window.scrollTo({ top: y, behavior: "smooth" });
          }, 350);
        }
      });
    });
  });

  // Raccourcis F/P si ton JS global n'est pas charg√© ici
  (function(){
    function uiBusy(){
      const a = document.activeElement;
      const tag = a && a.tagName;
      return (tag === 'INPUT' || tag === 'TEXTAREA' || (a && a.isContentEditable))
             || document.querySelector('.select2-container--open')
             || document.querySelector('.swal2-container.swal2-shown')
             || document.querySelector('.modal.show');
    }
    function toggleOffcanvas(id){
      const el = document.getElementById(id); if(!el) return;
      let oc = bootstrap.Offcanvas.getInstance(el); if(!oc) oc = new bootstrap.Offcanvas(el);
      if (el.classList.contains('show')) oc.hide(); else oc.show();
    }
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey || e.metaKey || e.altKey) return;
      if (uiBusy()) return;
      const k = (e.key||'').toLowerCase();
      if (k==='f'){ e.preventDefault(); toggleOffcanvas('filtersOffcanvas'); }
      if (k==='p'){ e.preventDefault(); toggleOffcanvas('paginationOffcanvas'); }
    });
  })();

 function escapeHtml(str) {
    return (str || '').replace(/[&<>\"']/g, s => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'" : '&#39;' }[s]
    ));
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.object-delete-btn');
    if (!btn) return;

    e.preventDefault();
    const id   = btn.getAttribute('data-object-id');
    const name = btn.getAttribute('data-object-name') || ('Objet #' + id);

    const doSubmit = () => {
      const form = document.getElementById('deleteForm_' + id);
      if (form) form.submit();
    };

    if (window.Swal) {
      const classes = (typeof getSwalThemeClasses === 'function') ? getSwalThemeClasses() : {};
      Swal.fire({
        title: "Supprimer l‚Äôobjet ?",
        html: `Confirmer la suppression de <strong>${escapeHtml(name)}</strong> ?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Supprimer",
        cancelButtonText: "Annuler",
        reverseButtons: true,
        customClass: classes
      }).then(res => {
        if (res.isConfirmed) doSubmit();
      });
    } else {
      // Fallback si Swal n‚Äôest pas charg√©
      if (confirm('Supprimer "' + name + '" ?')) doSubmit();
    }
  });
(function() {
  // Debounce helper
  function debounce(fn, ms) {
    let t; return function(...args) {
      clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  // Pour chaque objet, on ‚Äúbranche‚Äù la modale d‚Äôajout et celle de retrait
  document.querySelectorAll('[id^="addAccModal_"]').forEach(modalEl => {
    const oid = modalEl.id.split('_')[1];

    const input   = document.getElementById(`accSearch_${oid}`);
    const results = document.getElementById(`accResults_${oid}`);
    const accId   = document.getElementById(`accId_${oid}`);
    const qtyIn   = document.getElementById(`accQty_${oid}`);
    const submit  = document.getElementById(`accSubmitBtn_${oid}`);

    const selWrap = document.getElementById(`accSelected_${oid}`);
    const selImg  = document.getElementById(`accSelectedImg_${oid}`);
    const selName = document.getElementById(`accSelectedName_${oid}`);
    const availEl = document.getElementById(`accAvail_${oid}`);

    let currentMax = 1;

    function setMaxQty(max) {
      currentMax = Math.max(1, Number(max) || 1);
      qtyIn.max = String(currentMax);
      if (Number(qtyIn.value || 1) > currentMax) qtyIn.value = String(currentMax);
    }

    function renderResults(items) {
      results.innerHTML = "";
      if (!items.length) {
        results.innerHTML = '<div class="list-group-item text-muted">Aucun accessoire disponible</div>';
        return;
      }
      items.forEach(it => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action d-flex align-items-center gap-2";
        a.innerHTML = `
          <img src="${it.image_url}" width="32" height="32" class="rounded border" style="object-fit:cover;">
          <div class="flex-grow-1">
            <div class="fw-semibold">${it.name}</div>
            <div class="small text-muted">Stock: ${it.quantity}</div>
          </div>
        `;
        a.addEventListener("click", () => {
          accId.value = it.id;
          selImg.src = it.image_url;
          selName.textContent = it.name;
          availEl.textContent = it.quantity;
          selWrap.classList.remove("d-none");
          setMaxQty(it.quantity);
          submit.disabled = false;
        });
        results.appendChild(a);
      });
    }

    const doSearch = debounce(async function() {
      const q = (input.value || "").trim();
      try {
        const r = await fetch(`/api/accessories/search?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        renderResults(data || []);
      } catch(e) {
        results.innerHTML = '<div class="list-group-item text-danger">Erreur de recherche</div>';
      }
    }, 200);

    input.addEventListener("input", doSearch);

    qtyIn.addEventListener("input", () => {
      let v = Number(qtyIn.value || 1);
      if (v < 1) v = 1;
      if (v > currentMax) v = currentMax;
      qtyIn.value = String(v);
    });

    // Reset √† l'ouverture
    modalEl.addEventListener("show.bs.modal", () => {
      input.value = "";
      results.innerHTML = "";
      accId.value = "";
      qtyIn.value = "1";
      setMaxQty(1);
      submit.disabled = true;
      selWrap.classList.add("d-none");
      doSearch(); // charger top 30 par d√©faut
    });
  });

  // Modale de retrait d‚Äôaccessoire (une g√©n√©rique par objet)
  document.querySelectorAll(".acc-remove-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const oid = btn.getAttribute("data-object-id");
      const accId = btn.getAttribute("data-accessory-id");
      const qty = Number(btn.getAttribute("data-qty") || "1");

      const modal = document.getElementById(`rmAccModal_${oid}`);
      const idEl  = document.getElementById(`rmAccId_${oid}`);
      const txtEl = document.getElementById(`rmAccText_${oid}`);
      const wrap  = document.getElementById(`rmAccQtyWrap_${oid}`);
      const qtyEl = document.getElementById(`rmAccQty_${oid}`);

      idEl.value = accId;
      if (qty > 1) {
        wrap.classList.remove("d-none");
        qtyEl.max = String(qty);
        qtyEl.value = "1";
        txtEl.textContent = `Retirer une partie ou la totalit√© (max ${qty}) ?`;
      } else {
        wrap.classList.add("d-none");
        qtyEl.value = "1";
        txtEl.textContent = "Confirmer la suppression de cet accessoire ?";
      }

      const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
      bsModal.show();
    });
  });
})();
document.addEventListener('DOMContentLoaded', () => {
  const usp = new URLSearchParams(location.search);
  const focusId = usp.get('focus_object_id');
  if (!focusId) return;

  const card     = document.getElementById('object_' + focusId);
  const header   = document.getElementById('heading_' + focusId);
  const collapse = document.getElementById('obj_' + focusId);

  if (!card) return;

  // Calcule un offset pour navbar fixe/sticky si pr√©sente
  function computeOffset() {
    const nav = document.querySelector('.navbar.fixed-top, .navbar.sticky-top');
    return (nav ? nav.offsetHeight : 0) + 12; // 12px de marge de confort
  }

  function scrollToCard() {
    const y = card.getBoundingClientRect().top + window.scrollY - computeOffset();
    window.scrollTo({ top: y, behavior: 'smooth' });
    // Accessibilit√© : donner le focus clavier au header cliquable
    if (header) { header.setAttribute('tabindex', '-1'); header.focus({preventScroll:true}); }
  }

  // Si l'accord√©on n'est pas ouvert, on √©coute la fin de l'animation
  const isOpen = collapse && collapse.classList.contains('show');

  if (collapse && !isOpen && window.bootstrap?.Collapse) {
    collapse.addEventListener('shown.bs.collapse', function onShown() {
      collapse.removeEventListener('shown.bs.collapse', onShown);
      // utiliser rAF pour laisser le layout se stabiliser avant le scroll
      requestAnimationFrame(scrollToCard);
    }, { once: true });
    new bootstrap.Collapse(collapse, { toggle: true });
  } else {
    // D√©j√† ouvert ou pas d'accord√©on -> on scrolle tout de suite
    requestAnimationFrame(scrollToCard);
  }
});
$(document).on('select2:open', function (e) {
    // Petite latence pour laisser le DOM du dropdown se rendre
    setTimeout(function () {
      const input = document.querySelector('.select2-container--open .select2-search__field');
      if (input) input.focus();
    }, 0);
  });
</script>
<script>
// --- Helpers communs ---
function debounce(fn, ms) {
  let t; return function(...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms); };
}
function fmtEUR(x){ try { return new Intl.NumberFormat('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(x||0)); } catch{ return (Number(x||0)).toFixed(2); } }

document.querySelectorAll('[id^="addGroupAccModal_"]').forEach(modalEl => {
  const gid = modalEl.id.split('_')[1];
  const groupSize = parseInt(modalEl.getAttribute('data-group-size') || '0', 10) || 0;

  const input   = document.getElementById(`grpAccSearch_${gid}`);
  const results = document.getElementById(`grpAccResults_${gid}`);
  const accId   = document.getElementById(`grpAccId_${gid}`);
  const qtyIn   = document.getElementById(`grpAccQty_${gid}`);
  const submit  = document.getElementById(`grpAccSubmitBtn_${gid}`);

  const selWrap = document.getElementById(`grpAccSelected_${gid}`);
  const selImg  = document.getElementById(`grpAccSelectedImg_${gid}`);
  const selName = document.getElementById(`grpAccSelectedName_${gid}`);
  const availEl = document.getElementById(`grpAccAvail_${gid}`);

  const infoEl  = document.getElementById(`grpAccInfo_${gid}`);
  const warnEl  = document.getElementById(`grpAccWarn_${gid}`);

  let currentStock = 0;          // stock total accessoire
  let maxPerObject = 1;          // borne dynamique = floor(stock / groupSize)

  function updateInfo() {
    const q = Math.max(1, Number(qtyIn.value || 1));
    const totalNeeded = q * groupSize;
    const ok = totalNeeded <= currentStock;

    infoEl.innerHTML = `Groupe‚ÄØ: <b>${groupSize}</b> objet(s). Besoin total‚ÄØ: <b>${totalNeeded}</b>. Stock dispo‚ÄØ: <b>${currentStock}</b>.`;
    warnEl.classList.toggle('d-none', ok);
    warnEl.textContent = ok ? '' : `Stock insuffisant : au maximum ${maxPerObject} par objet pour ${groupSize} objets.`

    submit.disabled = !accId.value || !ok || q < 1;
  }

  function setMaxQty() {
    maxPerObject = groupSize > 0 ? Math.floor((currentStock || 0) / groupSize) : 0;
    // Si le stock ne permet pas au moins 1 par objet, on bloque.
    if (maxPerObject < 1) {
      qtyIn.value = "1";
      updateInfo();
      return;
    }
    // borne HTML
    qtyIn.min = "1";
    qtyIn.max = String(maxPerObject);
    // ajuste la valeur si > max
    let v = Math.max(1, Number(qtyIn.value || 1));
    if (v > maxPerObject) v = maxPerObject;
    qtyIn.value = String(v);
    updateInfo();
  }

  function renderResults(items) {
    results.innerHTML = "";
    if (!items.length) {
      results.innerHTML = '<div class="list-group-item text-muted">Aucun accessoire</div>';
      return;
    }
    items.forEach(it => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = "list-group-item list-group-item-action d-flex align-items-center gap-2";
      const pu = (it.unit_price != null) ? fmtEUR(it.unit_price) + "¬†‚Ç¨" : "‚Äî";
      a.innerHTML = `
        <img src="${it.image_url}" width="32" height="32" class="rounded border" style="object-fit:cover;">
        <div class="flex-grow-1">
          <div class="fw-semibold">${it.name}</div>
          <div class="small text-muted">Stock‚ÄØ: ${it.quantity} ‚Äî PU‚ÄØ: ${pu}</div>
        </div>
      `;
      a.addEventListener("click", e => {
        e.preventDefault();
        accId.value = it.id;
        selImg.src = it.image_url;
        selName.textContent = it.name;
        availEl.textContent = it.quantity;
        selWrap.classList.remove("d-none");

        currentStock = Number(it.quantity || 0);
        setMaxQty(); // calcule maxPerObject et met √† jour l‚ÄôUI
      });
      results.appendChild(a);
    });
  }

  const doSearch = debounce(async function() {
    const q = (input.value || "").trim();
    try {
      const r = await fetch(`/api/accessories/search?q=${encodeURIComponent(q)}`);
      const data = await r.json();
      renderResults(data || []);
    } catch(e) {
      results.innerHTML = '<div class="list-group-item text-danger">Erreur de recherche</div>';
    }
  }, 200);

  input.addEventListener("input", doSearch);

  qtyIn.addEventListener("input", () => {
    // borne c√¥t√© client
    let v = Math.max(1, Number(qtyIn.value || 1));
    if (maxPerObject >= 1 && v > maxPerObject) v = maxPerObject;
    qtyIn.value = String(v);
    updateInfo();
  });

  // Reset √† l‚Äôouverture
  modalEl.addEventListener("show.bs.modal", () => {
    input.value = ""; results.innerHTML = "";
    accId.value = ""; selWrap.classList.add("d-none");
    qtyIn.value = "1";
    currentStock = 0; maxPerObject = 1;
    infoEl.textContent = ""; warnEl.textContent = ""; warnEl.classList.add('d-none');
    submit.disabled = true;
  });
});

// --- INITIALISATION des modales Groupe (retrait) ---
document.querySelectorAll('[id^="remGroupAccModal_"]').forEach(modalEl => {
  const gid = modalEl.id.split('_')[1];

  const input   = document.getElementById(`grpRemAccSearch_${gid}`);
  const results = document.getElementById(`grpRemAccResults_${gid}`);
  const accId   = document.getElementById(`grpRemAccId_${gid}`);
  const qtyIn   = document.getElementById(`grpRemAccQty_${gid}`);
  const allCb   = document.getElementById(`grpRemAll_${gid}`);
  const qtyWrap = document.getElementById(`grpRemQtyWrap_${gid}`);
  const submit  = document.getElementById(`grpRemAccSubmitBtn_${gid}`);

  function renderResults(items) {
    results.innerHTML = "";
    if (!items.length) {
      results.innerHTML = '<div class="list-group-item text-muted">Aucun accessoire</div>';
      return;
    }
    items.forEach(it => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = "list-group-item list-group-item-action d-flex align-items-center gap-2";
		const pu = (it.unit_price != null) ? fmtEUR(it.unit_price) + " ‚Ç¨" : "‚Äî";
      a.innerHTML = `
        <img src="${it.image_url}" width="32" height="32" class="rounded border" style="object-fit:cover;">
        <div class="flex-grow-1">
          <div class="fw-semibold">${it.name}</div>
          <div class="small text-muted">Stock : ${it.quantity} ‚Äî PU : ${pu}</div>
        </div>
      `;
      a.addEventListener("click", e => {
        e.preventDefault();
        accId.value = it.id;
        submit.disabled = false;
      });
      results.appendChild(a);
    });
  }

  const doSearch = debounce(async function() {
    const q = (input.value || "").trim();
    try {
      const r = await fetch(`/api/accessories/search?q=${encodeURIComponent(q)}`);
      const data = await r.json();
      renderResults(data || []);
    } catch(e) {
      results.innerHTML = '<div class="list-group-item text-danger">Erreur de recherche</div>';
    }
  }, 200);

  input.addEventListener("input", doSearch);

  // coche "tout retirer" masque le champ qty et vide sa valeur pour envoyer qty vide => suppression compl√®te c√¥t√© backend
  allCb.addEventListener("change", () => {
    if (allCb.checked) {
      qtyWrap.classList.add("d-none");
      qtyIn.value = "";
    } else {
      qtyWrap.classList.remove("d-none");
      if (!qtyIn.value) qtyIn.value = "1";
    }
  });

  modalEl.addEventListener("show.bs.modal", () => {
    input.value = "";
    results.innerHTML = "";
    accId.value = "";
    qtyIn.value = "1";
    allCb.checked = false;
    qtyWrap.classList.remove("d-none");
    submit.disabled = true;
  });
});
$(function() {
  // Ajouter un tag √† un objet
  $(document).on('click', '.obj-add-tag-btn', function () {
    const btn = $(this);
    const objectId = btn.data('object-id');
    const input = btn.siblings('.obj-add-tag-input');
    const tag = (input.val() || '').trim();
    if (!tag) return;

    $.post(`/objects/${objectId}/tags/add`, { tag })
      .done(() => {
        const currentPage = new URLSearchParams(window.location.search).get('page') || '1';
        window.location.href = `/objects?page=${currentPage}&focus_object_id=${objectId}`;
      })
      .fail(() => alert("Erreur lors de l‚Äôajout du tag."));
  });

  // Supprimer un tag d‚Äôun objet
  $(document).on('click', '.obj-remove-tag', function () {
    const btn = $(this);
    const objectId = btn.data('object-id');
    const tag = btn.data('tag');

    $.post(`/objects/${objectId}/tags/remove`, { tag })
      .done(() => {
        const currentPage = new URLSearchParams(window.location.search).get('page') || '1';
        window.location.href = `/objects?page=${currentPage}&focus_object_id=${objectId}`;
      })
      .fail(() => alert("Erreur lors de la suppression du tag."));
  });
});
</script>
{% endblock %}
