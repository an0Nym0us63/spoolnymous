{% extends "base.html" %}
{% import 'macros/hidden_args.jinja2' as macros %}

{% block content %}
<style>
  /* Header en grille 3 colonnes */
  .obj-hdr       { cursor:pointer; user-select:none; }
  .obj-grid      { display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; }
  .obj-main      { min-width:0; display:flex; flex-direction:column; gap:.25rem; }

  /* Titre trÃ¨s compact dans un badge */
  .title-badge   { display:inline-block; max-width:100%; white-space:normal; line-height:1.1;
                   border:1px solid var(--bs-border-color); background:var(--bs-secondary-bg);
                   color:var(--bs-body-color); padding:.15rem .5rem; border-radius:999px;
                   font-weight:600; font-size:.9rem; } /* taille rÃ©duite */

  /* Chips sous le titre, Ã  droite, sans dÃ©bordement */
  .chips         { display:flex; flex-wrap:wrap; gap:.25rem; justify-content:flex-end; max-width:100%; }
  .chips .badge  { font-weight:600; font-size:.65rem; padding:.35em .55em; white-space:nowrap; }
  /* IcÃ´ne statut Ã  droite */
  .obj-status i  { font-size:1.2rem; }
  @media (max-width: 575.98px) {
    .card-body .fs-5,
    .card-body .fs-md-4 {
      font-size: 1rem !important;
    }
    .card-body .small.fw-bold {
      font-size: 0.75rem;
    }
  }
  .obj-grid > *:last-child {
  flex-shrink: 0;
}
</style>
<a href="{{ url_for('accessories_list') }}" class="btn btn-sm btn-outline-secondary">
  ğŸ§° Accessoires
</a>
<!-- Boutons flottants (identiques au reste) -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">ğŸ“„</button>
</div>
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">ğŸ”</button>
</div>
{% if objects|length == 0 %}
  <div class="alert alert-light border d-flex align-items-center" role="alert">
    <i class="bi bi-inbox me-2"></i>
    <div>Aucun objet ne correspond aux filtres.</div>
  </div>
{% endif %}
{% if objects|length != 0 %}
<!-- Tuiles statistiques (alignÃ©es sur print_history) -->
<div class="row row-cols-3 g-2 g-md-2 mb-3 text-center align-items-stretch">
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">ğŸ“¦</div>
        <div class="small fw-bold">{{ total_objects }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">ğŸ›’</div>
        <div class="small fw-bold">{{ sold_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">ğŸ</div>
        <div class="small fw-bold">{{ gifted_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">âœ…</div>
        <div class="small fw-bold">{{ available_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">ğŸ’¶</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_sold_price) }} {{ currencysymbol or 'â‚¬' }}
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">ğŸ“ˆ</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_positive_margin) }} {{ currencysymbol or 'â‚¬' }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="accordion" id="objectsAccordion">
  {% for o in objects %}
  {% set collapse_id = "obj_" ~ o.id %}
  <div class="card mb-2">
    <div class="card-header obj-hdr"
     id="heading_{{ o.id }}" role="button"
     data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}"
     aria-expanded="false" aria-controls="{{ collapse_id }}">

  <div class="obj-grid">
    <!-- Colonne gauche : statut (vente / offert / dispo / indispo) -->
    <div class="obj-status d-flex align-items-center justify-content-start me-1 flex-shrink-0">
      {% if o.sold_price is not none %}
        {% if o.sold_price == 0 %}
          <i class="bi bi-gift-fill text-info" title="Offert"></i>
        {% else %}
          <i class="bi bi-bag-check-fill text-success" title="Vendu"></i>
        {% endif %}
      {% else %}
        {% if o.available %}
          <i class="bi bi-box2-fill text-warning" title="Disponible (en stock)"></i>
        {% else %}
          <i class="bi bi-slash-circle-fill text-secondary" title="Indisponible"></i>
        {% endif %}
      {% endif %}
    </div>

    <!-- Colonne centre : titre + chips -->
<div class="obj-main d-flex flex-column align-items-center text-center px-1" style="max-width: 100%;">
  <div class="w-100" style="max-width: 200px;">
    {% if o.sold_price is not none %}
      {% if o.sold_price == 0 %}
        <div class="badge bg-info text-dark small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% else %}
        <div class="badge bg-success text-white small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% endif %}
    {% else %}
      {% if o.available %}
        <div class="badge bg-warning text-dark small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% else %}
        <div class="badge bg-secondary text-light small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% endif %}
    {% endif %}
  </div>

  <div class="chips justify-content-center flex-wrap mt-1 gap-1 w-100" style="max-width: 220px;">
    <span class="badge rounded-pill bg-light text-dark border border-secondary fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
      ğŸ› ï¸ {{ "%.2f"|format(o.cost_total or 0) }} {{ currencysymbol or 'â‚¬' }}
    </span>

    {% if o.sold_price is not none %}
      {% if o.sold_price == 0 %}
        <span class="badge rounded-pill bg-info text-dark border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">ğŸ Offert</span>
      {% else %}
        <span class="badge rounded-pill bg-primary text-white border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
          ğŸ’° {{ "%.2f"|format(o.sold_price) }} {{ currencysymbol or 'â‚¬' }}
        </span>
        {% set _total  = (o.cost_total or 0) %}
        {% set _margin = (o.margin if (o.margin is not none) else (o.sold_price - _total)) %}
        {% set _pos    = _margin >= 0 %}
        <span class="badge rounded-pill {{ 'bg-success text-white' if _pos else 'bg-danger text-white' }} border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
          {{ 'ğŸ“ˆ' if _pos else 'ğŸ“‰' }} {{ '%.2f'|format(_margin) }} {{ currencysymbol or 'â‚¬' }}
        </span>
      {% endif %}
    {% endif %}
  </div>
</div>

    <!-- Colonne droite : thumbnail avec composant global `.thumb` -->
    <div class="text-end flex-shrink-0">
      <div class="thumb" style="--thumb-size: 48px;">
        {% if o.thumbnail %}
          <img src="{{ o.thumbnail }}" alt="" class="thumb-img">
        {% else %}
          <div class="thumb-ph" title="Aucune image"></div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

    <div id="{{ collapse_id }}" class="collapse" aria-labelledby="heading_{{ o.id }}" data-bs-parent="#objectsAccordion">
      <div class="card-body">
		<div class="d-flex justify-content-end mb-2" style="z-index: 1;" data-requires-write>
  <div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      Actions
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renameModal_{{ o.id }}">
          ğŸ“ Renommer
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#sellModal_{{ o.id }}">
          ğŸ’³ Vente / don
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#commentModal_{{ o.id }}">
          ğŸ’¬ Modifier le commentaire
        </a>
      </li>
	  <li>
  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addAccModal_{{ o.id }}">
    â• Ajouter accessoire
  </a>
</li>
      {% if o.parent_type == 'print' %}
        <li>
          <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_print_id={{ o.parent_id }}&focus_print_id={{ o.parent_id }}">
            ğŸ” Voir la rÃ©fÃ©rence
          </a>
        </li>
      {% else %}
        <li>
          <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_group_id={{ o.parent_id }}&focus_group_id={{ o.parent_id }}">
            ğŸ” Voir la rÃ©fÃ©rence
          </a>
        </li>
      {% endif %}
      <li>
        <a href="#"
           class="dropdown-item text-danger object-delete-btn"
           data-object-id="{{ o.id }}"
           data-object-name="{{ o.name|e }}">
          ğŸ—‘ Supprimer
        </a>
        <form id="deleteForm_{{ o.id }}" class="d-none m-0 p-0"
              method="post" action="{{ url_for('objects_delete', object_id=o.id) }}">
          {{ macros.render_filtered_args(args) }}
        </form>
      </li>
    </ul>
  </div>
</div>
{% if o.thumbnail %}
	  <div class="text-center">
      <div class="thumb" style="--thumb-size: 200px;">
        <img src="{{o.thumbnail }}"
             alt="Print Image" class="thumb-img" />
      </div>
      </div>
      {% endif %}
	  {% if o.comment %}
	  <div class="text-center mt-2">
  <span class="badge d-inline-block bg-warning bg-opacity-10 border border-warning rounded-pill px-3 py-1"
        style="font-size: 0.65rem; max-width: 90vw; white-space: normal; word-break: break-word;">
    <span class="text-warning">ğŸ“ƒ</span> <span class="text-muted">{{ o.comment }}</span>
  </span>
  </div>
  {% endif %}
       <div class="row text-muted small gx-3 gy-2 mb-3 row-cols-2 row-cols-md-3">
  <div class="col">
    <strong>ğŸ› ï¸</strong>
    {{ '%.2f'|format(o.cost_fabrication or 0) }} {{ currencysymbol or 'â‚¬' }}
  </div>
  <div class="col">
    <strong>ğŸ§°</strong>
    {{ '%.2f'|format(o.cost_accessories or 0) }} {{ currencysymbol or 'â‚¬' }}
  </div>
  <div class="col">
    <strong>ğŸ“¦</strong>
    {{ '%.2f'|format(o.cost_total or 0) }} {{ currencysymbol or 'â‚¬' }}
  </div>
  <div class="col">
    <strong>ğŸ’°</strong>
    {% if o.sold_price is not none %}
      {{ '%.2f'|format(o.sold_price) }} {{ currencysymbol or 'â‚¬' }}
    {% else %}
      <span class="text-muted fst-italic">non vendu</span>
    {% endif %}
  </div>
  <div class="col">
    <strong>ğŸ“ˆ</strong>
    {% if o.sold_price %}
      {% set _margin = o.margin if o.margin is not none else (o.sold_price - (o.cost_total or 0)) %}
      {{ '%.2f'|format(_margin) }} {{ currencysymbol or 'â‚¬' }}
    {% else %}
      <span class="text-muted fst-italic">n/a</span>
    {% endif %}
  </div>
  <div class="col">
    <strong>ğŸ—“ï¸</strong>
    {% if o.created_at %}
      {{ o.created_at[:10].split('-') | reverse | join('/') }}
    {% else %}
      ?
    {% endif %}
  </div>
  <div class="col">
    <strong>ğŸ›ï¸</strong>
    {% if o.sold_date %}
      {{ o.sold_date[:10].split('-') | reverse | join('/') }}
    {% else %}
      <span class="text-muted fst-italic">non vendu</span>
    {% endif %}
  </div>
</div>

{% set accs = obj_accessories.get(o.id, []) %}
{% if accs %}
  <div class="mb-3">
    <div class="fw-semibold mb-2">ğŸ§° Accessoires</div>
    <div class="d-flex flex-wrap gap-3">
      {% for a in accs %}
        <div class="text-center" style="width:86px;">
          <div class="position-relative">
            <div class="rounded border overflow-hidden d-flex align-items-center justify-content-center"
     style="width: 86px; height: 86px;">
  <img
    src="{{ url_for('static', filename=a.image_path) if a.image_path else url_for('static', filename='placeholder.png') }}"
    alt="{{ a.accessory_name }}"
    style="max-width: 100%; max-height: 100%; object-fit: contain;">
</div>
            <button type="button"
                    class="btn-close position-absolute top-0 end-0 bg-white rounded-circle shadow-sm acc-remove-btn"
                    title="Retirer"
                    data-object-id="{{ o.id }}"
                    data-accessory-id="{{ a.accessory_id }}"
                    data-qty="{{ a.quantity }}"
                    style="transform: scale(.8);">
            </button>
          </div>
          <div class="small mt-1 text-truncate" title="{{ a.accessory_name }}">{{ a.accessory_name }}</div>
          <div class="small text-muted">Ã— {{ a.quantity }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<!-- Tags -->
{% set tags = obj_tags.get(o.id, []) %}
{% if tags %}
  <div class="d-flex flex-wrap gap-1">
    {% for tag in tags %}
      <span class="badge bg-light text-dark border border-secondary-subtle fw-normal small">
        #{{ tag }}
      </span>
    {% endfor %}
  </div>
{% endif %}
      </div>
    </div>
  </div>
  <div class="modal fade" id="addAccModal_{{ o.id }}" tabindex="-1" aria-labelledby="addAccLabel_{{ o.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('objects_add_accessory', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="addAccLabel_{{ o.id }}">â• Ajouter un accessoire Ã  Â« {{ o.name }} Â»</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- Recherche + liste -->
        <div class="mb-3">
          <label class="form-label">Accessoire</label>
          <input type="text" class="form-control" id="accSearch_{{ o.id }}" placeholder="Rechercher un accessoire (nom)â€¦">
          <div class="list-group mt-2" id="accResults_{{ o.id }}" style="max-height: 240px; overflow:auto;"></div>
          <input type="hidden" name="accessory_id" id="accId_{{ o.id }}">
        </div>

        <!-- SÃ©lection courante -->
        <div id="accSelected_{{ o.id }}" class="d-none">
          <div class="d-flex align-items-center gap-2">
            <img id="accSelectedImg_{{ o.id }}" src="{{ url_for('static', filename='placeholder.png') }}" alt="" width="40" height="40" class="rounded border" style="object-fit:cover;">
            <div class="flex-grow-1">
              <div class="fw-semibold" id="accSelectedName_{{ o.id }}"></div>
              <div class="text-muted small">Stock dispo : <span id="accAvail_{{ o.id }}">0</span></div>
            </div>
          </div>
        </div>

        <!-- QuantitÃ© -->
        <div class="mt-3">
          <label class="form-label">QuantitÃ©</label>
          <input type="number" class="form-control" name="qty" id="accQty_{{ o.id }}" min="1" value="1" required>
          <div class="form-text">La quantitÃ© ne peut pas dÃ©passer le stock disponible.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary" id="accSubmitBtn_{{ o.id }}" disabled>Ajouter</button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="rmAccModal_{{ o.id }}" tabindex="-1" aria-labelledby="rmAccLabel_{{ o.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_remove_accessory', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <input type="hidden" name="accessory_id" id="rmAccId_{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="rmAccLabel_{{ o.id }}">Retirer lâ€™accessoire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p id="rmAccText_{{ o.id }}" class="mb-3"></p>
        <div id="rmAccQtyWrap_{{ o.id }}" class="d-none">
          <label class="form-label">QuantitÃ© Ã  retirer</label>
          <input type="number" class="form-control" name="qty" id="rmAccQty_{{ o.id }}" min="1" value="1">
          <div class="form-text">Vous ne pouvez pas dÃ©passer la quantitÃ© liÃ©e Ã  lâ€™objet.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-danger">Retirer</button>
      </div>
    </form>
  </div>
</div>
  <div class="modal fade" id="renameModal_{{ o.id }}" tabindex="-1" aria-labelledby="renameLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_rename', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="renameLabel_{{ o.id }}">Renommer lâ€™objet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" name="name" value="{{ o.name }}" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="sellModal_{{ o.id }}" tabindex="-1" aria-labelledby="sellLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_sell', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="sellLabel_{{ o.id }}">Vente / don</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Prix de vente</label>
          <div class="input-group">
            <input type="number" name="sold_price" class="form-control" min="0" step="0.01"
       value="{% if o.sold_price is not none %}{{ '%.2f'|format(o.sold_price) }}{% endif %}"
       placeholder="0.00">
            <span class="input-group-text">{{ currencysymbol or 'â‚¬' }}</span>
          </div>
          <div class="form-text">Mettre <strong>0</strong> pour un don / cadeau.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Date de vente</label>
          <input type="date" name="sold_date" class="form-control"
       value="{{ (o.sold_date[:10]) if o.sold_date else '' }}">
          <div class="form-text">Par dÃ©faut : aujourdâ€™hui.</div>
        </div>

        <div class="mb-0">
          <label class="form-label">Commentaire (optionnel)</label>
          <textarea name="sold_comment" class="form-control" rows="3"
          placeholder="DÃ©tails de la vente / du donâ€¦">{{ o.comment or '' }}</textarea>
        </div>
      </div>
      <div class="modal-footer">
  <!-- Soumet le mÃªme formulaire vers la route d'annulation -->
  <button type="submit"
          class="btn btn-outline-danger me-auto"
          formmethod="post"
          formaction="{{ url_for('objects_unsell', object_id=o.id) }}">
    âŒ Annuler la vente
  </button>

  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
  <button type="submit" class="btn btn-primary">Enregistrer</button>
</div>
    </form>
  </div>
</div>

<div class="modal fade" id="commentModal_{{ o.id }}" tabindex="-1" aria-labelledby="commentLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_update_comment', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="commentLabel_{{ o.id }}">Modifier le commentaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <textarea name="comment" class="form-control" rows="5"
                  placeholder="Saisissez un commentaire pour cet objetâ€¦">{{ o.comment or '' }}</textarea>
        <div class="form-text">Laissez vide pour effacer le commentaire.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
  {% endfor %}
</div>

<!-- Offcanvas filtres -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2">
      {{ macros.render_filtered_args(args, ['search','sale_filter','source_type','available','page']) }}
      <div class="col-12 col-md-4">
        <label class="form-label">Recherche</label>
        <input type="text" name="search" class="form-control" value="{{ filters.search or '' }}" placeholder="Nom de lâ€™objetâ€¦">
      </div>
	    <div class="col-6 col-md-3">
    <label for="sale_filter" class="form-label mb-1">Vente</label>
    <select id="sale_filter" name="sale_filter" class="form-select">
      {% set curr_sale = args.get('sale_filter','') %}
      {% if not curr_sale %}
        {# rÃ©tro-compat: si ancien sold_filter/available prÃ©sents #}
        {% set old_sold = args.get('sold_filter','') %}
        {% set old_av   = args.get('available','') %}
        {% if old_sold == 'yes' %}{% set curr_sale = 'vendus' %}
        {% elif old_av == 'yes' %}{% set curr_sale = 'dispo' %}
        {% endif %}
      {% endif %}
      <option value="" {{ '' == curr_sale and 'selected' or '' }}>Tous</option>
      <option value="vendus" {{ 'vendus' == curr_sale and 'selected' or '' }}>Vendus</option>
      <option value="dispo"  {{ 'dispo'  == curr_sale and 'selected' or '' }}>Disponibles</option>
      <option value="offert" {{ 'offert' == curr_sale and 'selected' or '' }}>Offerts</option>
    </select>
  </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Source</label>
        <select name="source_type" class="form-select">
          <option value="">â€” IndiffÃ©rent â€”</option>
          <option value="print" {% if filters.source_type=='print' %}selected{% endif %}>Print</option>
          <option value="group" {% if filters.source_type=='group' %}selected{% endif %}>Groupe</option>
        </select>
      </div>
      <div class="col-12 col-md-2 align-self-end text-end">
        <button class="btn btn-primary" type="submit">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- Offcanvas pagination -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <input type="number" min="1" max="{{ total_pages }}" name="page" value="{{ page }}"
               class="form-control form-control-sm" style="width: 56px;">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
<div style="height: 4rem;"></div>
{% endblock %}

{% block scripts %}
<script>
 document.addEventListener('shown.bs.modal', function (e) {
    const modal = e.target;
    if (!modal.id || !modal.id.startsWith('sellModal_')) return;
    const input = modal.querySelector('input[name="sold_date"]');
    if (input && !input.value) {
      const today = new Date().toISOString().slice(0, 10);
      input.value = today;
    }
  });
  // Smooth scroll quand on ouvre un item, mÃªme logique que tes autres pages
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".card-header[data-bs-toggle='collapse']").forEach(header => {
      header.addEventListener("click", () => {
        const targetSelector = header.getAttribute("data-bs-target");
        const target = document.querySelector(targetSelector);
        if (!target.classList.contains("show")) {
          setTimeout(() => {
            const y = header.getBoundingClientRect().top + window.scrollY - 20;
            window.scrollTo({ top: y, behavior: "smooth" });
          }, 350);
        }
      });
    });
  });

  // Raccourcis F/P si ton JS global n'est pas chargÃ© ici
  (function(){
    function uiBusy(){
      const a = document.activeElement;
      const tag = a && a.tagName;
      return (tag === 'INPUT' || tag === 'TEXTAREA' || (a && a.isContentEditable))
             || document.querySelector('.select2-container--open')
             || document.querySelector('.swal2-container.swal2-shown')
             || document.querySelector('.modal.show');
    }
    function toggleOffcanvas(id){
      const el = document.getElementById(id); if(!el) return;
      let oc = bootstrap.Offcanvas.getInstance(el); if(!oc) oc = new bootstrap.Offcanvas(el);
      if (el.classList.contains('show')) oc.hide(); else oc.show();
    }
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey || e.metaKey || e.altKey) return;
      if (uiBusy()) return;
      const k = (e.key||'').toLowerCase();
      if (k==='f'){ e.preventDefault(); toggleOffcanvas('filtersOffcanvas'); }
      if (k==='p'){ e.preventDefault(); toggleOffcanvas('paginationOffcanvas'); }
    });
  })();

 function escapeHtml(str) {
    return (str || '').replace(/[&<>\"']/g, s => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'" : '&#39;' }[s]
    ));
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.object-delete-btn');
    if (!btn) return;

    e.preventDefault();
    const id   = btn.getAttribute('data-object-id');
    const name = btn.getAttribute('data-object-name') || ('Objet #' + id);

    const doSubmit = () => {
      const form = document.getElementById('deleteForm_' + id);
      if (form) form.submit();
    };

    if (window.Swal) {
      const classes = (typeof getSwalThemeClasses === 'function') ? getSwalThemeClasses() : {};
      Swal.fire({
        title: "Supprimer lâ€™objet ?",
        html: `Confirmer la suppression de <strong>${escapeHtml(name)}</strong> ?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Supprimer",
        cancelButtonText: "Annuler",
        reverseButtons: true,
        customClass: classes
      }).then(res => {
        if (res.isConfirmed) doSubmit();
      });
    } else {
      // Fallback si Swal nâ€™est pas chargÃ©
      if (confirm('Supprimer "' + name + '" ?')) doSubmit();
    }
  });
(function() {
  // Debounce helper
  function debounce(fn, ms) {
    let t; return function(...args) {
      clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  // Pour chaque objet, on â€œbrancheâ€ la modale dâ€™ajout et celle de retrait
  document.querySelectorAll('[id^="addAccModal_"]').forEach(modalEl => {
    const oid = modalEl.id.split('_')[1];

    const input   = document.getElementById(`accSearch_${oid}`);
    const results = document.getElementById(`accResults_${oid}`);
    const accId   = document.getElementById(`accId_${oid}`);
    const qtyIn   = document.getElementById(`accQty_${oid}`);
    const submit  = document.getElementById(`accSubmitBtn_${oid}`);

    const selWrap = document.getElementById(`accSelected_${oid}`);
    const selImg  = document.getElementById(`accSelectedImg_${oid}`);
    const selName = document.getElementById(`accSelectedName_${oid}`);
    const availEl = document.getElementById(`accAvail_${oid}`);

    let currentMax = 1;

    function setMaxQty(max) {
      currentMax = Math.max(1, Number(max) || 1);
      qtyIn.max = String(currentMax);
      if (Number(qtyIn.value || 1) > currentMax) qtyIn.value = String(currentMax);
    }

    function renderResults(items) {
      results.innerHTML = "";
      if (!items.length) {
        results.innerHTML = '<div class="list-group-item text-muted">Aucun accessoire disponible</div>';
        return;
      }
      items.forEach(it => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action d-flex align-items-center gap-2";
        a.innerHTML = `
          <img src="${it.image_url}" width="32" height="32" class="rounded border" style="object-fit:cover;">
          <div class="flex-grow-1">
            <div class="fw-semibold">${it.name}</div>
            <div class="small text-muted">Stock: ${it.quantity}</div>
          </div>
        `;
        a.addEventListener("click", () => {
          accId.value = it.id;
          selImg.src = it.image_url;
          selName.textContent = it.name;
          availEl.textContent = it.quantity;
          selWrap.classList.remove("d-none");
          setMaxQty(it.quantity);
          submit.disabled = false;
        });
        results.appendChild(a);
      });
    }

    const doSearch = debounce(async function() {
      const q = (input.value || "").trim();
      try {
        const r = await fetch(`/api/accessories/search?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        renderResults(data || []);
      } catch(e) {
        results.innerHTML = '<div class="list-group-item text-danger">Erreur de recherche</div>';
      }
    }, 200);

    input.addEventListener("input", doSearch);

    qtyIn.addEventListener("input", () => {
      let v = Number(qtyIn.value || 1);
      if (v < 1) v = 1;
      if (v > currentMax) v = currentMax;
      qtyIn.value = String(v);
    });

    // Reset Ã  l'ouverture
    modalEl.addEventListener("show.bs.modal", () => {
      input.value = "";
      results.innerHTML = "";
      accId.value = "";
      qtyIn.value = "1";
      setMaxQty(1);
      submit.disabled = true;
      selWrap.classList.add("d-none");
      doSearch(); // charger top 30 par dÃ©faut
    });
  });

  // Modale de retrait dâ€™accessoire (une gÃ©nÃ©rique par objet)
  document.querySelectorAll(".acc-remove-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const oid = btn.getAttribute("data-object-id");
      const accId = btn.getAttribute("data-accessory-id");
      const qty = Number(btn.getAttribute("data-qty") || "1");

      const modal = document.getElementById(`rmAccModal_${oid}`);
      const idEl  = document.getElementById(`rmAccId_${oid}`);
      const txtEl = document.getElementById(`rmAccText_${oid}`);
      const wrap  = document.getElementById(`rmAccQtyWrap_${oid}`);
      const qtyEl = document.getElementById(`rmAccQty_${oid}`);

      idEl.value = accId;
      if (qty > 1) {
        wrap.classList.remove("d-none");
        qtyEl.max = String(qty);
        qtyEl.value = "1";
        txtEl.textContent = `Retirer une partie ou la totalitÃ© (max ${qty}) ?`;
      } else {
        wrap.classList.add("d-none");
        qtyEl.value = "1";
        txtEl.textContent = "Confirmer la suppression de cet accessoire ?";
      }

      const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
      bsModal.show();
    });
  });
})();
</script>
{% endblock %}
