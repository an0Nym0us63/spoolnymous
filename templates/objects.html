{% extends "base.html" %}
{% import 'macros/hidden_args.jinja2' as macros %}

{# -------------------------------------------------------------- #}
{#  Page Objects ‚Äî version styl√©e / accessible / compacte        #}
{# -------------------------------------------------------------- #}

{% block content %}

<style>
  /* Micro-design local √† la page (√©vite d‚Äôalourdir le global) */
  .obj-card{border:1px solid var(--bs-border-color);border-radius:1rem;overflow:hidden}
  .obj-card + .obj-card{margin-top:.5rem}
  .obj-hdr{cursor:pointer;user-select:none}
  .obj-thumb{width:42px;height:42px;object-fit:cover;border-radius:.5rem}
  .obj-thumb--ph{width:42px;height:42px;border-radius:.5rem;background:repeating-linear-gradient(45deg,#0000,#0000 6px,#0001 6px,#0001 12px);opacity:.2}
  .chev{transition:transform .25s ease}
  .chev.rotate{transform:rotate(180deg)}
  .chip{--p:.35rem;display:inline-flex;align-items:center;gap:.35rem;padding:.25rem var(--p);border-radius:999px;border:1px solid var(--bs-border-color);font-size:.8rem;background:var(--bs-body-bg)}
  .chip i{opacity:.7}
  .kv{margin:0;padding:0;list-style:none}
  .kv li{display:flex;justify-content:space-between;gap:1rem;padding:.2rem 0;border-bottom:1px dashed var(--bs-border-color-translucent)}
  .kv li:last-child{border-bottom:0}
  .badge-soft{--bg:var(--bs-secondary-bg);background:var(--bg);border:1px solid var(--bs-border-color);color:var(--bs-body-color)}
  .name-xl{font-weight:600;letter-spacing:.2px}
  .name-sub{font-size:.85rem;color:var(--bs-secondary-color)}
</style>

<!-- Boutons flottants (identiques au reste) -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">üìÑ</button>
</div>
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">üîç</button>
</div>

{% if objects|length == 0 %}
  <div class="alert alert-light border d-flex align-items-center" role="alert">
    <i class="bi bi-inbox me-2"></i>
    <div>Aucun objet ne correspond aux filtres.</div>
  </div>
{% endif %}

<div class="accordion" id="objectsAccordion">
  {% for o in objects %}
  {% set collapse_id = "obj_" ~ o.id %}
  <div class="obj-card">
    <div class="obj-hdr d-flex align-items-center justify-content-between px-3 py-2"
         id="heading_{{ o.id }}" role="button"
         data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}"
         aria-expanded="false" aria-controls="{{ collapse_id }}">

      <div class="d-flex align-items-center gap-2">
        {% if o.thumbnail %}
          <img src="{{ o.thumbnail }}" alt="" class="obj-thumb">
        {% else %}
          <div class="obj-thumb--ph d-inline-block"></div>
        {% endif %}

        <div>
          <div class="name-xl">{{ o.name }}</div>
          {% if o.translated_name %}
            <div class="name-sub">{{ o.translated_name }}</div>
          {% endif %}
          <div class="small text-muted mt-1">
            <span class="me-2"><i class="bi bi-link-45deg me-1"></i>Source : {{ 'Print' if o.parent_type == 'print' else 'Groupe' }} #{{ o.parent_id }}</span>
            <span><i class="bi bi-calendar-event me-1"></i>Cr√©√© le {{ o.created_at | datetimeformat('fr')}}</span>
          </div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        {% if o.sold_price is not none %}
          <span class="badge bg-success d-inline-flex align-items-center"><i class="bi bi-bag-check me-1"></i>Vendu</span>
        {% else %}
          <span class="badge {{ 'bg-primary' if o.available else 'bg-secondary' }} d-inline-flex align-items-center">
            <i class="bi bi-circle-fill me-1" style="font-size:.5rem"></i>{{ 'Disponible' if o.available else 'Indispo' }}
          </span>
        {% endif %}
        <span class="chip" title="Co√ªt fabrication">
          <i class="bi bi-tools"></i>
          {{ "%.2f"|format(o.cost_fabrication or 0) }} {{ currencysymbol or '‚Ç¨' }}
        </span>
        <span class="chip" title="Co√ªt accessoires">
          <i class="bi bi-plug"></i>
          {{ "%.2f"|format(o.cost_accessory or 0) }} {{ currencysymbol or '‚Ç¨' }}
        </span>
        <span class="chip" title="Co√ªt total">
          <i class="bi bi-cash-coin"></i>
          {{ "%.2f"|format(o.cost_total or 0) }} {{ currencysymbol or '‚Ç¨' }}
        </span>
        <i class="bi bi-chevron-down chev ms-1"></i>
      </div>
    </div>

    <div id="{{ collapse_id }}" class="collapse" aria-labelledby="heading_{{ o.id }}" data-bs-parent="#objectsAccordion">
      <div class="card-body p-3">
        <div class="dropdown float-end mt-1" data-requires-write>
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            Actions
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renameModal_{{ o.id }}">
                üìù Renommer
              </a>
            </li>
            {% if o.parent_type == 'print' %}
              <li>
                <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_print_id={{ o.parent_id }}&focus_print_id={{ o.parent_id }}">
                  üîé Voir la r√©f√©rence
                </a>
              </li>
            {% else %}
              <li>
                <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_group_id={{ o.parent_id }}&focus_group_id={{ o.parent_id }}">
                  üîé Voir la r√©f√©rence
                </a>
              </li>
            {% endif %}
            <li>
              <a href="#"
                 class="dropdown-item text-danger object-delete-btn"
                 data-object-id="{{ o.id }}"
                 data-object-name="{{ o.name|e }}">
                üóë Supprimer
              </a>
              <form id="deleteForm_{{ o.id }}" class="d-none m-0 p-0"
                    method="post" action="{{ url_for('objects_delete', object_id=o.id) }}">
                {{ macros.render_filtered_args(args) }}
              </form>
            </li>
          </ul>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-8">
            <div class="mb-2">
              <div class="small text-muted mb-1">Tags</div>
              <div class="d-flex flex-wrap gap-1">
                {% set tags = obj_tags.get(o.id, []) %}
                {% if tags %}
                  {% for t in tags %}
                    <span class="badge bg-primary">{{ t }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted">Aucun</span>
                {% endif %}
              </div>
            </div>

            <div class="mt-2">
              {% if o.comment %}
                <div class="small text-muted mb-1">Commentaire</div>
                <div class="border rounded p-2">{{ o.comment }}</div>
              {% endif %}
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="small text-muted mb-1">Infos</div>
            <ul class="kv mb-2">
              <li><span>Disponible</span><span>{{ 'Oui' if o.available else 'Non' }}</span></li>
              <li><span>Vendu</span><span>{% if o.sold_price is not none %}Oui ({{ "%.2f"|format(o.sold_price) }} {{ currencysymbol or '‚Ç¨' }}){% else %}Non{% endif %}</span></li>
              {% if o.sold_date %}<li><span>Vendu le</span><span>{{ o.sold_date }}</span></li>{% endif %}
              <li><span>M√†J</span><span>{{ o.updated_at | datetimeformat('fr')}}</span></li>
              <li><span>Marge</span><span>{% if o.margin is defined and o.margin is not none %}{{ '%.2f'|format(o.margin) }} {{ currencysymbol or '‚Ç¨' }}{% else %}‚Äî{% endif %}</span></li>
              {% if o.translated_name %}<li><span>Nom traduit</span><span>{{ o.translated_name }}</span></li>{% endif %}
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Modal renommage (avec champ nom traduit) #}
  <div class="modal fade" id="renameModal_{{ o.id }}" tabindex="-1" aria-labelledby="renameLabel_{{ o.id }}">
    <div class="modal-dialog">
      <form class="modal-content" method="post" action="{{ url_for('objects_rename', object_id=o.id) }}">
        {{ macros.render_filtered_args(args) }}
        <div class="modal-header">
          <h5 class="modal-title" id="renameLabel_{{ o.id }}">Renommer l‚Äôobjet</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" name="name" value="{{ o.name }}" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Nom traduit (optionnel)</label>
            <input type="text" class="form-control" name="translated_name" value="{{ o.translated_name or '' }}">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-primary">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  {% endfor %}
</div>

<!-- Offcanvas filtres -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2">
      {{ macros.render_filtered_args(args, ['search','sold_filter','source_type','available','page']) }}
      <div class="col-12 col-md-4">
        <label class="form-label">Recherche</label>
        <input type="text" name="search" class="form-control" value="{{ filters.search or '' }}" placeholder="Nom de l‚Äôobjet‚Ä¶">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Vente</label>
        <select name="sold_filter" class="form-select">
          <option value="">‚Äî Tous ‚Äî</option>
          <option value="yes" {% if filters.sold_filter=='yes' %}selected{% endif %}>Vendus</option>
          <option value="no"  {% if filters.sold_filter=='no'  %}selected{% endif %}>Non vendus</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Dispo</label>
        <select name="available" class="form-select">
          <option value="">‚Äî Toutes ‚Äî</option>
          <option value="yes" {% if filters.available=='yes' %}selected{% endif %}>Disponibles</option>
          <option value="no"  {% if filters.available=='no'  %}selected{% endif %}>Indispo</option>
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Source</label>
        <select name="source_type" class="form-select">
          <option value="">‚Äî Indiff√©rent ‚Äî</option>
          <option value="print" {% if filters.source_type=='print' %}selected{% endif %}>Print</option>
          <option value="group" {% if filters.source_type=='group' %}selected{% endif %}>Groupe</option>
        </select>
      </div>
      <div class="col-12 col-md-2 align-self-end text-end">
        <button class="btn btn-primary" type="submit">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- Offcanvas pagination -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <input type="number" min="1" max="{{ total_pages }}" name="page" value="{{ page }}"
               class="form-control form-control-sm" style="width: 56px;">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Smooth scroll + rotation chevron
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".obj-hdr[data-bs-toggle='collapse']").forEach(header => {
      header.addEventListener("click", () => {
        const targetSelector = header.getAttribute("data-bs-target");
        const target = document.querySelector(targetSelector);
        const chev = header.querySelector('.chev');
        if (!target.classList.contains("show")) {
          setTimeout(() => {
            const y = header.getBoundingClientRect().top + window.scrollY - 20;
            window.scrollTo({ top: y, behavior: "smooth" });
          }, 350);
        }
        if (chev) chev.classList.toggle('rotate');
      });
    });
  });

  // Raccourcis F/P
  (function(){
    function uiBusy(){
      const a = document.activeElement;
      const tag = a && a.tagName;
      return (tag === 'INPUT' || tag === 'TEXTAREA' || (a && a.isContentEditable))
             || document.querySelector('.select2-container--open')
             || document.querySelector('.swal2-container.swal2-shown')
             || document.querySelector('.modal.show');
    }
    function toggleOffcanvas(id){
      const el = document.getElementById(id); if(!el) return;
      let oc = bootstrap.Offcanvas.getInstance(el); if(!oc) oc = new bootstrap.Offcanvas(el);
      if (el.classList.contains('show')) oc.hide(); else oc.show();
    }
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey || e.metaKey || e.altKey) return;
      if (uiBusy()) return;
      const k = (e.key||'').toLowerCase();
      if (k==='f'){ e.preventDefault(); toggleOffcanvas('filtersOffcanvas'); }
      if (k==='p'){ e.preventDefault(); toggleOffcanvas('paginationOffcanvas'); }
    });
  })();

  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, s => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]
    ));
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.object-delete-btn');
    if (!btn) return;

    e.preventDefault();
    const id   = btn.getAttribute('data-object-id');
    const name = btn.getAttribute('data-object-name') || ('Objet #' + id);

    const doSubmit = () => {
      const form = document.getElementById('deleteForm_' + id);
      if (form) form.submit();
    };

    if (window.Swal) {
      const classes = (typeof getSwalThemeClasses === 'function') ? getSwalThemeClasses() : {};
      Swal.fire({
        title: "Supprimer l‚Äôobjet ?",
        html: `Confirmer la suppression de <strong>${escapeHtml(name)}</strong> ?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Supprimer",
        cancelButtonText: "Annuler",
        reverseButtons: true,
        customClass: classes
      }).then(res => {
        if (res.isConfirmed) doSubmit();
      });
    } else {
      // Fallback si Swal n‚Äôest pas charg√©
      if (confirm('Supprimer "' + name + '" ?')) doSubmit();
    }
  });
</script>
{% endblock %}