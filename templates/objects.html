{% extends "base.html" %}
{% import 'macros/hidden_args.jinja2' as macros %}
{% set page_name = "objects" %}
{% block content %}
<style>
  /* Header en grille 3 colonnes */
  .obj-hdr       { cursor:pointer; user-select:none; }
  .obj-grid      { display:grid; grid-template-columns:auto 1fr auto; gap:.6rem; align-items:center; }
  .obj-main      { min-width:0; display:flex; flex-direction:column; gap:.25rem; }

  /* Titre tr√®s compact dans un badge */
  .title-badge   { display:inline-block; max-width:100%; white-space:normal; line-height:1.1;
                   border:1px solid var(--bs-border-color); background:var(--bs-secondary-bg);
                   color:var(--bs-body-color); padding:.15rem .5rem; border-radius:999px;
                   font-weight:600; font-size:.9rem; } /* taille r√©duite */

  /* Chips sous le titre, √† droite, sans d√©bordement */
  .chips         { display:flex; flex-wrap:wrap; gap:.25rem; justify-content:flex-end; max-width:100%; }
  .chips .badge  { font-weight:600; font-size:.65rem; padding:.35em .55em; white-space:nowrap; }
  /* Ic√¥ne statut √† droite */
  .obj-status i  { font-size:1.2rem; }
  @media (max-width: 575.98px) {
    .card-body .fs-5,
    .card-body .fs-md-4 {
      font-size: 1rem !important;
    }
    .card-body .small.fw-bold {
      font-size: 0.75rem;
    }
  }
  .obj-grid > *:last-child {
  flex-shrink: 0;
}
.card.focus-ring {
  box-shadow: none !important;
  outline: none !important;
}
.card-header:focus {
  outline: none !important;
  box-shadow: none !important;
}
.thumb-acc-flag {
  position: absolute;
  right: 4px;   /* d√©bord √† droite */
  top:   4px;   /* d√©bord en haut */
  font-size: 0.65rem; /* plus petit */
  line-height: 1;
  z-index: 2;
  pointer-events: none; /* ne g√™ne pas les clics sur le header */
}
.bg-purple {
  background-color: #b48ef1 !important; /* violet bootstrap-like */
  color: #fff !important;
}
.bg-purple-subtle {
  background-color: #e9d8fd !important; /* violet clair */
  color: #4b0082 !important; /* indigo fonc√© pour le texte */
}
.text-purple {
  color: #b48ef1 !important;
}
</style>
<!-- Boutons flottants (identiques au reste) -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas" aria-controls="paginationOffcanvas">üìÑ</button>
</div>
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas" aria-controls="filtersOffcanvas">üîç</button>
</div>
{% if items|length == 0 %}
  <div class="alert alert-light border d-flex align-items-center" role="alert">
    <i class="bi bi-inbox me-2"></i>
    <div>Aucun objet ne correspond aux filtres.</div>
  </div>
{% endif %}
{% if items|length != 0 %}
<!-- Tuiles statistiques (align√©es sur print_history) -->
<div class="row row-cols-4 g-3 g-md-3 mb-4 text-center align-items-stretch">
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üì¶</div>
        <div class="small fw-bold">{{ total_objects }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üõí</div>
        <div class="small fw-bold">{{ sold_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üè†</div>
        <div class="small fw-bold">{{ personal_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üéÅ</div>
        <div class="small fw-bold">{{ gifted_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">‚úÖ</div>
        <div class="small fw-bold">{{ available_count }}</div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üí∂</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_sold_price) }} {{ currencysymbol or '‚Ç¨' }}
        </div>
      </div>
    </div>
  </div>
  <div class="col">
    <div class="card border border-secondary-subtle shadow-sm h-100">
      <div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
        <div class="fs-5 fs-md-4">üìà</div>
        <div class="small fw-bold">
          {{ '%.2f'|format(sum_positive_margin) }} {{ currencysymbol or '‚Ç¨' }}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{# ------------------------------- #}
{# FLUX FUSIONN√â : GROUPES + PRINTS
   items = [{type: 'group'|'object', created_at, group|object}] #}
{# ------------------------------- #}

{% if items and items|length > 0 %}
  <div class="d-flex flex-column gap-3 mt-3">

    {% for it in items %}
      {% if it.type == 'group' %}
  {% set g = it.group %}
  <div class="card shadow-sm object-card"> {# ajoute la m√™me classe que tes prints si tu en as une #}
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between gap-3">

        {# GAUCHE : ic√¥ne groupe (m√™me gabarit que l‚Äôavatar des objets) #}
        <div class="flex-shrink-0 d-flex align-items-center justify-content-center rounded bg-light" style="width:48px;height:48px;">
          <i class="bi bi-{{ g.icon }}"></i>
        </div>

        {# CENTRE : nom + chips #}
        <div class="flex-grow-1">
          <div class="fw-semibold">
            {{ g.name }}
          </div>
          <div class="mt-1 d-flex flex-wrap gap-2">
            <span class="badge rounded-pill text-bg-secondary">
              ‚õî {{ g.unavailable }} / {{ g.total }}
            </span>
            <span class="badge rounded-pill text-bg-success">
              üí∂ {{ (g.sum_sold_price) | round(2) }} {{ currencysymbol }}
            </span>
            <span class="badge rounded-pill {{ 'text-bg-success' if (g.sum_positive_margin) >= 0 else 'text-bg-danger' }}">
              üìà {{ (g.sum_positive_margin) | round(2) }} {{ currencysymbol }}
            </span>
          </div>
        </div>

        {# DROITE : visuel du dernier print (m√™me gabarit que l‚Äôaper√ßu d‚Äôun objet) #}
        <div class="flex-shrink-0">
          {% if g.preview_thumb %}
            <img src="{{ g.preview_thumb }}" alt="preview" class="rounded" style="width:72px;height:72px;object-fit:cover;">
          {% else %}
            <div class="rounded bg-light d-flex align-items-center justify-content-center" style="width:72px;height:72px;">
              <i class="bi bi-image text-muted"></i>
            </div>
          {% endif %}
        </div>

      </div>
    </div>

    {# Tableau des objets du groupe (inchang√©) #}
    <div class="card-footer p-0">
      
            {% for o in g.objects %}
              {% set _obj_accessories = obj_accessories if obj_accessories is defined else {} %}
              {% set _obj_tags = obj_tags if obj_tags is defined else {} %}
              {% set _args = args if args is defined else {} %}
              {% include 'fragments/object_row.html' %}
            {% endfor %}
    </div>
  </div>
      {% else %}
        {# ---- Rendu d'un PRINT isol√© (mini-table 1 ligne pour r√©utiliser object_row) ---- #}
        {% set o = it.object %}
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            {# on peut masquer thead si tu veux (ou le laisser pour accessibilit√©) #}
            <thead class="d-none">
              <tr>
                <th>Objet</th><th>√âtat</th><th>Prix</th><th>Cr√©√©</th><th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% set _obj_accessories = obj_accessories if obj_accessories is defined else {} %}
              {% set _obj_tags = obj_tags if obj_tags is defined else {} %}
              {% set _args = args if args is defined else {} %}
              {% include 'fragments/object_row.html' %}
            </tbody>
          </table>
        </div>
      {% endif %}
    {% endfor %}

  </div>
{% else %}
  <div class="mt-4 text-muted">Aucun r√©sultat.</div>
{% endif %}

<!-- Offcanvas filtres -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Filtres</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2">
      {{ macros.render_filtered_args(args, ['search','sale_filter','source_type','available','page']) }}
      <div class="col-12 col-md-4">
        <label class="form-label">Recherche</label>
        <input type="text" name="search" class="form-control" value="{{ filters.search or '' }}" placeholder="Nom de l‚Äôobjet‚Ä¶">
      </div>
	    <div class="col-6 col-md-3">
    <label for="sale_filter" class="form-label mb-1">Vente</label>
    <select id="sale_filter" name="sale_filter" class="form-select">
      {% set curr_sale = args.get('sale_filter','') %}
      {% if not curr_sale %}
        {# r√©tro-compat: si ancien sold_filter/available pr√©sents #}
        {% set old_sold = args.get('sold_filter','') %}
        {% set old_av   = args.get('available','') %}
        {% if old_sold == 'yes' %}{% set curr_sale = 'vendus' %}
        {% elif old_av == 'yes' %}{% set curr_sale = 'dispo' %}
        {% endif %}
      {% endif %}
      <option value="" {{ '' == curr_sale and 'selected' or '' }}>Tous</option>
      <option value="dispo"  {{ 'dispo'  == curr_sale and 'selected' or '' }}>Disponibles</option>
      <option value="perso"  {{ 'perso'  == curr_sale and 'selected' or '' }}>Perso</option>
      <option value="vendus" {{ 'vendus' == curr_sale and 'selected' or '' }}>Vendus</option>
      <option value="offert" {{ 'offert' == curr_sale and 'selected' or '' }}>Offerts</option>
    </select>
  </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Source</label>
        <select name="source_type" class="form-select">
          <option value="">‚Äî Indiff√©rent ‚Äî</option>
          <option value="print" {% if filters.source_type=='print' %}selected{% endif %}>Print</option>
          <option value="group" {% if filters.source_type=='group' %}selected{% endif %}>Groupe</option>
        </select>
      </div>
      <div class="col-12 col-md-2 align-self-end text-end">
        <button class="btn btn-primary" type="submit">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- Offcanvas pagination -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <input type="number" min="1" max="{{ total_pages }}" name="page" value="{{ page }}"
               class="form-control form-control-sm" style="width: 56px;">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>
<div style="height: 4rem;"></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/print_history.js') }}"></script>
<script>
document.addEventListener('shown.bs.modal', function (e) {
  const modal = e.target;
  if (!modal.id || !modal.id.startsWith('sellModal_')) return;

  const priceInput = modal.querySelector('input[name="sold_price"]');
  const personalCb = modal.querySelector('input[name="sold_personal"]');

  const setPersonalEnabled = () => {
    const v = (priceInput?.value || "").trim();
    // Vide => route interpr√®te 0.0 ‚áí on autorise la case
    const num = v === "" ? 0 : Number(v);
    const enable = !Number.isNaN(num) && num === 0;
    if (personalCb) {
      personalCb.disabled = !enable;
      if (!enable) personalCb.checked = false;
    }
  };

  // init
  setPersonalEnabled();
  priceInput?.addEventListener('input', setPersonalEnabled);

  // logique existante de date par d√©faut (on la laisse)
  const inputDate = modal.querySelector('input[name="sold_date"]');
  if (inputDate && !inputDate.value) {
    const today = new Date().toISOString().slice(0, 10);
    inputDate.value = today;
  }
});
  // Smooth scroll quand on ouvre un item, m√™me logique que tes autres pages
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".card-header[data-bs-toggle='collapse']").forEach(header => {
      header.addEventListener("click", () => {
        const targetSelector = header.getAttribute("data-bs-target");
        const target = document.querySelector(targetSelector);
        if (!target.classList.contains("show")) {
          setTimeout(() => {
            const y = header.getBoundingClientRect().top + window.scrollY - 20;
            window.scrollTo({ top: y, behavior: "smooth" });
          }, 350);
        }
      });
    });
  });

  // Raccourcis F/P si ton JS global n'est pas charg√© ici
  (function(){
    function uiBusy(){
      const a = document.activeElement;
      const tag = a && a.tagName;
      return (tag === 'INPUT' || tag === 'TEXTAREA' || (a && a.isContentEditable))
             || document.querySelector('.select2-container--open')
             || document.querySelector('.swal2-container.swal2-shown')
             || document.querySelector('.modal.show');
    }
    function toggleOffcanvas(id){
      const el = document.getElementById(id); if(!el) return;
      let oc = bootstrap.Offcanvas.getInstance(el); if(!oc) oc = new bootstrap.Offcanvas(el);
      if (el.classList.contains('show')) oc.hide(); else oc.show();
    }
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey || e.metaKey || e.altKey) return;
      if (uiBusy()) return;
      const k = (e.key||'').toLowerCase();
      if (k==='f'){ e.preventDefault(); toggleOffcanvas('filtersOffcanvas'); }
      if (k==='p'){ e.preventDefault(); toggleOffcanvas('paginationOffcanvas'); }
    });
  })();

 function escapeHtml(str) {
    return (str || '').replace(/[&<>\"']/g, s => (
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'" : '&#39;' }[s]
    ));
  }

  document.addEventListener('click', function (e) {
    const btn = e.target.closest('.object-delete-btn');
    if (!btn) return;

    e.preventDefault();
    const id   = btn.getAttribute('data-object-id');
    const name = btn.getAttribute('data-object-name') || ('Objet #' + id);

    const doSubmit = () => {
      const form = document.getElementById('deleteForm_' + id);
      if (form) form.submit();
    };

    if (window.Swal) {
      const classes = (typeof getSwalThemeClasses === 'function') ? getSwalThemeClasses() : {};
      Swal.fire({
        title: "Supprimer l‚Äôobjet ?",
        html: `Confirmer la suppression de <strong>${escapeHtml(name)}</strong> ?`,
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Supprimer",
        cancelButtonText: "Annuler",
        reverseButtons: true,
        customClass: classes
      }).then(res => {
        if (res.isConfirmed) doSubmit();
      });
    } else {
      // Fallback si Swal n‚Äôest pas charg√©
      if (confirm('Supprimer "' + name + '" ?')) doSubmit();
    }
  });
(function() {
  // Debounce helper
  function debounce(fn, ms) {
    let t; return function(...args) {
      clearTimeout(t); t = setTimeout(() => fn.apply(this, args), ms);
    };
  }

  // Pour chaque objet, on ‚Äúbranche‚Äù la modale d‚Äôajout et celle de retrait
  document.querySelectorAll('[id^="addAccModal_"]').forEach(modalEl => {
    const oid = modalEl.id.split('_')[1];

    const input   = document.getElementById(`accSearch_${oid}`);
    const results = document.getElementById(`accResults_${oid}`);
    const accId   = document.getElementById(`accId_${oid}`);
    const qtyIn   = document.getElementById(`accQty_${oid}`);
    const submit  = document.getElementById(`accSubmitBtn_${oid}`);

    const selWrap = document.getElementById(`accSelected_${oid}`);
    const selImg  = document.getElementById(`accSelectedImg_${oid}`);
    const selName = document.getElementById(`accSelectedName_${oid}`);
    const availEl = document.getElementById(`accAvail_${oid}`);

    let currentMax = 1;

    function setMaxQty(max) {
      currentMax = Math.max(1, Number(max) || 1);
      qtyIn.max = String(currentMax);
      if (Number(qtyIn.value || 1) > currentMax) qtyIn.value = String(currentMax);
    }

    function renderResults(items) {
      results.innerHTML = "";
      if (!items.length) {
        results.innerHTML = '<div class="list-group-item text-muted">Aucun accessoire disponible</div>';
        return;
      }
      items.forEach(it => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action d-flex align-items-center gap-2";
        a.innerHTML = `
          <img src="${it.image_url}" width="32" height="32" class="rounded border" style="object-fit:cover;">
          <div class="flex-grow-1">
            <div class="fw-semibold">${it.name}</div>
            <div class="small text-muted">Stock: ${it.quantity}</div>
          </div>
        `;
        a.addEventListener("click", () => {
          accId.value = it.id;
          selImg.src = it.image_url;
          selName.textContent = it.name;
          availEl.textContent = it.quantity;
          selWrap.classList.remove("d-none");
          setMaxQty(it.quantity);
          submit.disabled = false;
        });
        results.appendChild(a);
      });
    }

    const doSearch = debounce(async function() {
      const q = (input.value || "").trim();
      try {
        const r = await fetch(`/api/accessories/search?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        renderResults(data || []);
      } catch(e) {
        results.innerHTML = '<div class="list-group-item text-danger">Erreur de recherche</div>';
      }
    }, 200);

    input.addEventListener("input", doSearch);

    qtyIn.addEventListener("input", () => {
      let v = Number(qtyIn.value || 1);
      if (v < 1) v = 1;
      if (v > currentMax) v = currentMax;
      qtyIn.value = String(v);
    });

    // Reset √† l'ouverture
    modalEl.addEventListener("show.bs.modal", () => {
      input.value = "";
      results.innerHTML = "";
      accId.value = "";
      qtyIn.value = "1";
      setMaxQty(1);
      submit.disabled = true;
      selWrap.classList.add("d-none");
      doSearch(); // charger top 30 par d√©faut
    });
  });

  // Modale de retrait d‚Äôaccessoire (une g√©n√©rique par objet)
  document.querySelectorAll(".acc-remove-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const oid = btn.getAttribute("data-object-id");
      const accId = btn.getAttribute("data-accessory-id");
      const qty = Number(btn.getAttribute("data-qty") || "1");

      const modal = document.getElementById(`rmAccModal_${oid}`);
      const idEl  = document.getElementById(`rmAccId_${oid}`);
      const txtEl = document.getElementById(`rmAccText_${oid}`);
      const wrap  = document.getElementById(`rmAccQtyWrap_${oid}`);
      const qtyEl = document.getElementById(`rmAccQty_${oid}`);

      idEl.value = accId;
      if (qty > 1) {
        wrap.classList.remove("d-none");
        qtyEl.max = String(qty);
        qtyEl.value = "1";
        txtEl.textContent = `Retirer une partie ou la totalit√© (max ${qty}) ?`;
      } else {
        wrap.classList.add("d-none");
        qtyEl.value = "1";
        txtEl.textContent = "Confirmer la suppression de cet accessoire ?";
      }

      const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
      bsModal.show();
    });
  });
})();
document.addEventListener('DOMContentLoaded', () => {
  const usp = new URLSearchParams(location.search);
  const focusId = usp.get('focus_object_id');
  if (!focusId) return;

  const card     = document.getElementById('object_' + focusId);
  const header   = document.getElementById('heading_' + focusId);
  const collapse = document.getElementById('obj_' + focusId);

  if (!card) return;

  // Calcule un offset pour navbar fixe/sticky si pr√©sente
  function computeOffset() {
    const nav = document.querySelector('.navbar.fixed-top, .navbar.sticky-top');
    return (nav ? nav.offsetHeight : 0) + 12; // 12px de marge de confort
  }

  function scrollToCard() {
    const y = card.getBoundingClientRect().top + window.scrollY - computeOffset();
    window.scrollTo({ top: y, behavior: 'smooth' });
    // Accessibilit√© : donner le focus clavier au header cliquable
    if (header) { header.setAttribute('tabindex', '-1'); header.focus({preventScroll:true}); }
  }

  // Si l'accord√©on n'est pas ouvert, on √©coute la fin de l'animation
  const isOpen = collapse && collapse.classList.contains('show');

  if (collapse && !isOpen && window.bootstrap?.Collapse) {
    collapse.addEventListener('shown.bs.collapse', function onShown() {
      collapse.removeEventListener('shown.bs.collapse', onShown);
      // utiliser rAF pour laisser le layout se stabiliser avant le scroll
      requestAnimationFrame(scrollToCard);
    }, { once: true });
    new bootstrap.Collapse(collapse, { toggle: true });
  } else {
    // D√©j√† ouvert ou pas d'accord√©on -> on scrolle tout de suite
    requestAnimationFrame(scrollToCard);
  }
});
</script>
{% endblock %}
