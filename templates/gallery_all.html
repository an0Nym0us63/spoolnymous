{% extends "base.html" %}
{% block styles %}
<style>
:root{
  --thumb-size: 180px;
  --tile-bg: #111; /* couleur de fond des tuiles (clair: #f5f5f5) */
}

body.gallery-page{ overflow-y:auto; background:var(--bs-body-bg); }

.gallery-header{
  position:sticky; top:0; z-index:1030;
  backdrop-filter:blur(6px);
  background: color-mix(in oklab, var(--bs-body-bg) 85%, transparent);
  border-bottom:1px solid rgba(255,255,255,.08);
}

/* Grille principale (cards album) */
.g-grid{
  --g-thumb-size: 220px;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--g-thumb-size), 1fr));
  gap:1rem;
}

/* Carte d‚Äôalbum */
.album-card{ cursor:pointer; }
.meta-line{ min-height:28px; }
.album-title{ font-size:.95rem; line-height:1.2; }
.album-count{ font-size:.75rem; }

/* Tuile carr√©e */
.patchwork{
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;          /* carr√© responsive */
  border-radius: .75rem;
  overflow: hidden;
  background: var(--tile-bg, #111);
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}

/* Une seule image, pleine tuile */
.patchwork.single img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover; object-position:center;
  display:block;
}

/* (Optionnel) micro-hover pour un peu de relief */
.album-card .patchwork{ transition: transform .12s ease; }
.album-card:hover .patchwork{ transform: translateY(-2px); }

/* Lightbox */
.lightbox{ position:fixed; inset:0; z-index:2000; display:none; background:rgba(0,0,0,.92); }
.lightbox.open{ display:grid; place-items:center; }
.lightbox img{ max-width:92vw; max-height:86vh; object-fit:contain; box-shadow:0 0 0 1px rgba(255,255,255,.08); border-radius:.5rem; }
.lb-toolbar{ position:fixed; top:.5rem; left:.5rem; right:.5rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
.lb-actions{ display:flex; gap:.5rem; }
.lb-index{ color:#fff; opacity:.8; font-size:.9rem; }
.lb-nav{ position:fixed; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
.lb-nav .btn{ pointer-events:all; border-radius:999px; }
/* Lightbox : titre adaptatif */
.lb-toolbar{
  flex-wrap: nowrap; /* desktop : une ligne */
}

#lbName{
  max-width: 70vw;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.lb-index{
  flex-shrink: 0; /* √©vite que le compteur se comprime trop */
}

/* En mobile : stack vertical */
@media (max-width: 576px){
  .lb-toolbar{
    flex-wrap: wrap;          /* permet le retour √† la ligne */
    gap: .25rem;
  }
  #lbName{
    max-width: 100%;
    white-space: normal;
    text-overflow: clip;
    line-height: 1.2;
  }
  .lb-index{
    width: 100%;
    text-align: left;        /* ou center si tu veux */
    font-size: .8rem;
    opacity: .7;
  }
}
/* ===== Mobile : 2 colonnes fixes qui s'adaptent √† la largeur ===== */
@media (max-width: 576px){
  /* Bordures du container plus fines pour gagner de la place */
  .container{ padding-left: .5rem; padding-right: .5rem; }

  /* Grille forc√©e √† 2 colonnes, quelles que soient les tailles pr√©vues au-dessus */
  .g-grid{
    /* on casse l'auto-fill/minmax desktop */
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: .6rem !important;
  }

  /* Tuile : carr√©, pas de d√©bord, coins doux */
  .patchwork{
    aspect-ratio: 1 / 1;
    border-radius: .6rem;
  }

  /* L√©gende compacte sous la vignette */
  .meta-line{ min-height: 22px; }

  /* 1 ligne tronqu√©e (ou 2 lignes si tu pr√©f√®res, voir variante) */
  .album-title{
    font-size: .84rem;
    line-height: 1.15;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .album-count{
    font-size: .68rem;
    padding: .1rem .35rem;
  }

  /* Neutralise l‚Äôeffet hover (inutile au tactile) */
  .album-card:hover .patchwork{ transform: none; }
}

/* Variante 2 lignes sur mobile (si titres souvent longs) */
/*
@media (max-width: 576px){
  .album-title{
    white-space: normal;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
  }
}
*/
q::placeholder{ opacity:.7; }
sentinel.empty{ color:var(--bs-secondary-color); }
.search-bar {
  top: 0;                 /* reste coll√©e en haut */
  z-index: 1050;          /* au-dessus de la galerie */
  backdrop-filter: blur(6px);
  border-bottom: 1px solid rgba(255,255,255,.1);
}
/* remplace .search-stick existant */
.search-stick{
  position: sticky;
  top: calc(var(--navbar-h, 56px) + .5rem);
  z-index: 1040;                      /* > contenu, < navbar si 1050 */
  background: var(--bs-body-bg);      /* ‚úÖ fond opaque => plus rien ne ‚Äúpasse derri√®re‚Äù */
  border-bottom: 1px solid var(--bs-border-color);
  box-shadow: 0 4px 12px rgba(0,0,0,.12);
  margin-bottom: .75rem;
}
.search-inner{
  display:flex; justify-content:center;
}
.search-input{ width: min(720px, 100%); }

/* look de l‚Äôinput group (sobri√©t√©, pas de gros aplat) */
.search-input .input-group-text{
  background: var(--bs-body-bg);
  border-color: var(--bs-border-color);
}
.search-input .form-control{
  background: var(--bs-body-bg);
  border-color: var(--bs-border-color);
}
.search-input .btn{
  border-color: var(--bs-border-color);
}

/* Mobile : pleine largeur */
@media (max-width: 576px){
  .search-input{ width: 100%; }
}
</style>
{% endblock %}

{% block content %}
<main class="gallery-page">
  <!-- Search bar sticky -->
  <div id="searchBar" class="search-bar">
    <div class="input-group">
      <span class="input-group-text bg-dark-subtle"><i class="bi bi-search"></i></span>
      <input id="q" type="search" class="form-control" placeholder="Rechercher un print, un groupe, un tag‚Ä¶">
      <button id="qClear" class="btn btn-outline-secondary" type="button" title="Effacer">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <!-- Gallery -->
  <div class="container py-3">
    <div id="grid" class="g-grid"></div>
    <div id="sentinel" class="py-4 text-center text-secondary">Chargement‚Ä¶</div>
  </div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lb-toolbar">
    <div class="lb-actions">
      <button id="lbClose" class="btn btn-light btn-sm" title="Fermer (Esc)"><i class="bi bi-x-lg"></i></button>
      <button id="lbDelete" class="btn btn-danger btn-sm" title="Supprimer" data-requires-write><i class="bi bi-trash3"></i></button>
      <span id="lbName" class="badge text-bg-dark"></span>
    </div>
    <div class="lb-index"><span id="lbIdx">1</span> / <span id="lbTotal">1</span></div>
  </div>
  <img id="lbImg" alt="">
  <div class="lb-nav px-2">
    <button id="lbPrev" class="btn btn-outline-light"><i class="bi bi-chevron-left"></i></button>
    <button id="lbNext" class="btn btn-outline-light"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function setNavbarOffset(){
  const nav = document.querySelector('.navbar');
  const apply = () => {
    const h = nav ? nav.offsetHeight : 56;
    document.documentElement.style.setProperty('--navbar-h', `${h}px`);
  };
  apply();
  window.addEventListener('resize', apply, { passive: true });
})();
// === √âTAT & DOM ==============================================================
const grid = document.getElementById('grid');
const sentinel = document.getElementById('sentinel');
const state = {
  page: 1, per: 60, loading: false, done: false,
  q: ''   // üëà ajout√©s
};
const params = new URLSearchParams(location.search);
const qInput = document.getElementById('q');
const qClear = document.getElementById('qClear');
const entRadios = { all: document.getElementById('entAll'),
                    prints: document.getElementById('entPrints'),
                    groups: document.getElementById('entGroups') };

state.q = params.get('q') || '';
qInput.value = state.q;

// Index d'albums (front) : key = "entity:id" ‚Üí { entity,id,title,cardEl,photos:[{url,name,base}] }
const albums = new Map();

// Lightbox custom (ids fournis par ton HTML)
const LB = {
  root: document.getElementById('lightbox'),
  img:  document.getElementById('lbImg'),
  name: document.getElementById('lbName'),
  idx:  document.getElementById('lbIdx'),
  total:document.getElementById('lbTotal'),
  btnPrev: document.getElementById('lbPrev'),
  btnNext: document.getElementById('lbNext'),
  btnClose: document.getElementById('lbClose'),
  btnDelete: document.getElementById('lbDelete'),
  albumKey: null,
  index: 0,
};

function parseAlbumKeyFromUrl(url){
  try{
    const parts = new URL(url, window.location.origin).pathname.split('/');
    const entity = parts[3]; // prints | groups
    const id = parseInt(parts[4], 10);
    if(!entity || Number.isNaN(id)) return null;
    return { key:`${entity}:${id}`, entity, id };
  }catch{ return null; }
}

function albumTitle(entity, id, itemTitle){
  return itemTitle || (entity === 'prints' ? `Print #${id}` : `Group #${id}`);
}

function buildUrl(){
  const u = new URL('/api/gallery/photos', window.location.origin);
  u.searchParams.set('page', state.page);
  u.searchParams.set('per', state.per);
  if (state.q) u.searchParams.set('q', state.q);
  return u;
}

function resetAndReload(){
  // reset pagination + UI
  state.page = 1;
  state.done = false;
  state.loading = false;

  albums.clear();
  grid.innerHTML = '';
  sentinel.classList.remove('empty');
  sentinel.textContent = 'Chargement‚Ä¶';

  // push √©tat dans l‚ÄôURL
  const usp = new URLSearchParams(location.search);
  if (state.q && state.q.trim()) usp.set('q', state.q.trim());
  else usp.delete('q');
  history.replaceState(null, '', `${location.pathname}?${usp.toString()}`);

  // relance le chargement
  loadNext();
}

function debounce(fn, ms=250){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

// === LIGHTBOX ================================================================
function lbOpen(albumKey, startIndex=0){
  const a = albums.get(albumKey);
  if(!a || !a.photos.length) return;
  LB.albumKey = albumKey;
  LB.index    = Math.min(Math.max(0, startIndex), a.photos.length-1);
  lbRender();
  LB.root.classList.add('open');
}

function lbClose(){ LB.root.classList.remove('open'); }

function lbMove(delta){
  const a = albums.get(LB.albumKey);
  if(!a) return;
  LB.index = (LB.index + delta + a.photos.length) % a.photos.length;
  lbRender();
}

function lbRender(){
  const a = albums.get(LB.albumKey);
  const p = a.photos[LB.index];
  const specific = p.base || p.name || '';
  LB.name.textContent = specific ? `${a.title} - ${specific}` : a.title;
  LB.img.src = p.url;
  LB.img.alt = specific || a.title || '';
  LB.idx.textContent = String(LB.index + 1);
  LB.total.textContent = String(a.photos.length);
}

qInput.addEventListener('input', debounce(()=>{
  state.q = qInput.value.trim();
  resetAndReload();
}, 250));

qClear.addEventListener('click', ()=>{
  if (!qInput.value) return;
  qInput.value = '';
  state.q = '';
  resetAndReload();
});

// Brancher les boutons + clavier
LB.btnPrev.addEventListener('click', ()=> lbMove(-1));
LB.btnNext.addEventListener('click', ()=> lbMove(+1));
LB.btnClose.addEventListener('click', lbClose);
LB.btnDelete.addEventListener('click', async ()=>{
  const a = albums.get(LB.albumKey);
  const p = a?.photos?.[LB.index];
  if (!p) return;

  const ask = async () => {
    if (window.Swal) {
      const r = await Swal.fire({
        title: 'Supprimer cette photo ?',
        text: p.base || p.name || '',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Supprimer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#d33',
        reverseButtons: true,
      });
      return r.isConfirmed;
    }
    // Fallback natif
    return confirm('Supprimer cette photo ?');
  };

  if (!(await ask())) return;

  // TODO: suppression serveur si besoin
  // await fetch('/api/gallery/photo/delete', { method:'POST', ... });

  // Mise √† jour locale
  a.photos.splice(LB.index, 1);
  if (!a.photos.length){
    a.cardEl.remove();
    albums.delete(LB.albumKey);
    lbClose();
    return;
  }
  updateAlbumUI(LB.albumKey);
  LB.index = Math.min(LB.index, a.photos.length - 1);
  lbRender();

  if (window.Swal) {
    Swal.fire({ toast:true, position:'top', timer:1500, showConfirmButton:false,
      icon:'success', title:'Photo supprim√©e' });
  }
});

document.addEventListener('keydown', (e)=>{
  if(!LB.root.classList.contains('open')) return;
  if(e.key === 'ArrowLeft') lbMove(-1);
  if(e.key === 'ArrowRight') lbMove(+1);
  if(e.key === 'Escape') lbClose();
});

// === RENDU ALBUMS ============================================================
function createAlbumCard(entity, id, title){
  const card = document.createElement('div');
  card.className = 'album-card';

  card.innerHTML = `
    <div class="patchwork"><!-- thumbs inject√©es --></div>
    <div class="mt-2 d-flex align-items-center gap-2 meta-line">
      <i class="bi bi-folder-fill d-none album-icon"></i>
      <span class="text-truncate album-title" title="${title}">${title}</span>
      <span class="badge text-bg-secondary ms-auto d-none album-count">0</span>
    </div>
  `;

  // Clic = ouvrir le diaporama (index 0 par d√©faut)
  card.addEventListener('click', ()=>{
    const key = card.dataset.key;
    const a = albums.get(key);
    if(!a) return;
    lbOpen(key, 0);
  });

  grid.appendChild(card);
  return card;
}

function renderPatchwork(card, photos){
  const box = card.querySelector('.patchwork');
  box.className = 'patchwork single';   // force le mode single

  if (!photos.length) { box.innerHTML = ''; return; }

  const cover = photos[0];
  const alt = cover.base || cover.name || '';
  box.innerHTML = `<img loading="lazy" src="${cover.url}" alt="${alt}">`;
}

function updateAlbumUI(key){
  const a = albums.get(key);
  if(!a) return;
  const icon = a.cardEl.querySelector('.album-icon');
  const countEl = a.cardEl.querySelector('.album-count');

  renderPatchwork(a.cardEl, a.photos);

  if(a.photos.length > 1){
    icon.classList.remove('d-none');
    countEl.classList.remove('d-none');
    countEl.textContent = String(a.photos.length);
  }else{
    icon.classList.add('d-none');
    countEl.classList.add('d-none');
  }
}

function addPhotoToAlbum(item){
  const parsed = parseAlbumKeyFromUrl(item.url || item.path || item.src);
  if(!parsed) return;
  const { key, entity, id } = parsed;

  if(!albums.has(key)){
    const title = albumTitle(entity, id, item.item_title);
    const cardEl = createAlbumCard(entity, id, title);
    cardEl.dataset.key = key;
    albums.set(key, { entity, id, title, cardEl, photos: [] });
  }
  const a = albums.get(key);

  if(!a.photos.some(p => p.url === item.url)){
    a.photos.push({ url:item.url, name:item.name, base:item.base_name });
    updateAlbumUI(key);
  }
}
(() => {
  let startX = 0, startY = 0, dx = 0, dy = 0, active = false, lockedAxis = null;
  const THRESH = 48;   // distance minimale pour changer d'image
  const LOCK = 10;     // distance pour ‚Äúlocker‚Äù l‚Äôaxe

  const onStart = (e) => {
    if (!LB.root.classList.contains('open')) return;
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY;
    dx = dy = 0; active = true; lockedAxis = null;
  };

  const onMove = (e) => {
    if (!active) return;
    const t = e.touches ? e.touches[0] : e;
    dx = t.clientX - startX;
    dy = t.clientY - startY;
    if (!lockedAxis && (Math.abs(dx) > LOCK || Math.abs(dy) > LOCK)) {
      lockedAxis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
    }
    if (lockedAxis === 'x') {
      // on consomme l‚Äô√©v√©nement pour √©viter le scroll de page
      e.preventDefault();
      // (optionnel) feedback visuel : translate l√©g√®re de l‚Äôimage
      LB.img.style.transform = `translateX(${dx * 0.08}px)`;
    }
  };

  const onEnd = () => {
    if (!active) return;
    active = false;
    LB.img.style.transform = '';
    if (lockedAxis === 'x') {
      if (dx > THRESH)      lbMove(-1);
      else if (dx < -THRESH) lbMove(+1);
    }
  };

  LB.root.addEventListener('touchstart', onStart, { passive: true });
  LB.root.addEventListener('touchmove',  onMove,  { passive: false }); // ‚ö†Ô∏è pour pouvoir preventDefault
  LB.root.addEventListener('touchend',   onEnd,   { passive: true });
})();
// === DATA LOADING ============================================================


async function loadNext(){
  if (state.loading || state.done) return;
  state.loading = true;
  sentinel.textContent = 'Chargement‚Ä¶';

  try {
    const response = await fetch(buildUrl(), { credentials: 'same-origin' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const data = await response.json();

    (data.items || []).forEach(addPhotoToAlbum);
    state.page += 1;
    state.done = !data.has_more;

    if (albums.size === 0 && state.done){
      sentinel.classList.add('empty');
      sentinel.textContent = state.q
        ? `Aucun r√©sultat pour ¬´ ${state.q} ¬ª`
        : 'Aucun √©l√©ment';
    } else {
      sentinel.classList.remove('empty');
      sentinel.textContent = state.done
        ? '‚Äî fin ‚Äî'
        : 'Descendez pour charger la suite‚Ä¶';
    }
  } catch (err) {
    console.error('[gallery] loadNext failed:', err);
    sentinel.classList.add('empty');
    sentinel.textContent = 'Erreur de chargement';
  } finally {
    state.loading = false;
  }
}
const io = new IntersectionObserver((entries)=>{
  if(entries.some(e=>e.isIntersecting)) loadNext();
});
io.observe(sentinel);

// Boot
loadNext();
</script>
{% endblock %}