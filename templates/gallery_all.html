{% extends "base.html" %}
{% block styles %}
<style>
:root{
  --thumb-size: 180px;
  --tile-bg: #111; /* couleur de fond des tuiles (clair: #f5f5f5) */
}

body.gallery-page{ overflow-y:auto; background:var(--bs-body-bg); }

.gallery-header{
  position:sticky; top:0; z-index:1030;
  backdrop-filter:blur(6px);
  background: color-mix(in oklab, var(--bs-body-bg) 85%, transparent);
  border-bottom:1px solid rgba(255,255,255,.08);
}

/* Grille principale (cards album) */
.g-grid{
  --g-thumb-size: 220px;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--g-thumb-size), 1fr));
  gap:1rem;
}

/* Carte d’album */
.album-card{ cursor:pointer; }
.meta-line{ min-height:28px; }
.album-title{ font-size:.95rem; line-height:1.2; }
.album-count{ font-size:.75rem; }

/* Tuile carrée */
.patchwork{
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;          /* carré responsive */
  border-radius: .75rem;
  overflow: hidden;
  background: var(--tile-bg, #111);
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}

/* Une seule image, pleine tuile */
.patchwork.single img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover; object-position:center;
  display:block;
}

/* (Optionnel) micro-hover pour un peu de relief */
.album-card .patchwork{ transition: transform .12s ease; }
.album-card:hover .patchwork{ transform: translateY(-2px); }

/* Lightbox */
.lightbox{ position:fixed; inset:0; z-index:2000; display:none; background:rgba(0,0,0,.92); }
.lightbox.open{ display:grid; place-items:center; }
.lightbox img{ max-width:92vw; max-height:86vh; object-fit:contain; box-shadow:0 0 0 1px rgba(255,255,255,.08); border-radius:.5rem; }
.lb-toolbar{ position:fixed; top:.5rem; left:.5rem; right:.5rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
.lb-actions{ display:flex; gap:.5rem; }
.lb-index{ color:#fff; opacity:.8; font-size:.9rem; }
.lb-nav{ position:fixed; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
.lb-nav .btn{ pointer-events:all; border-radius:999px; }
/* Lightbox : titre adaptatif */
.lb-toolbar{
  flex-wrap: nowrap; /* desktop : une ligne */
}

#lbName{
  max-width: 70vw;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.lb-index{
  flex-shrink: 0; /* évite que le compteur se comprime trop */
}

/* En mobile : stack vertical */
@media (max-width: 576px){
  .lb-toolbar{
    flex-wrap: wrap;          /* permet le retour à la ligne */
    gap: .25rem;
  }
  #lbName{
    max-width: 100%;
    white-space: normal;
    text-overflow: clip;
    line-height: 1.2;
  }
  .lb-index{
    width: 100%;
    text-align: left;        /* ou center si tu veux */
    font-size: .8rem;
    opacity: .7;
  }
}
/* ===== Mobile : 2 colonnes fixes qui s'adaptent à la largeur ===== */
@media (max-width: 576px){
  /* Bordures du container plus fines pour gagner de la place */
  .container{ padding-left: .5rem; padding-right: .5rem; }

  /* Grille forcée à 2 colonnes, quelles que soient les tailles prévues au-dessus */
  .g-grid{
    /* on casse l'auto-fill/minmax desktop */
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: .6rem !important;
  }

  /* Tuile : carré, pas de débord, coins doux */
  .patchwork{
    aspect-ratio: 1 / 1;
    border-radius: .6rem;
  }


  /* Neutralise l’effet hover (inutile au tactile) */
  .album-card:hover .patchwork{ transform: none; }
}

/* Variante 2 lignes sur mobile (si titres souvent longs) */
/*
@media (max-width: 576px){
  .album-title{
    white-space: normal;
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
  }
}
*/
q::placeholder{ opacity:.7; }
sentinel.empty{ color:var(--bs-secondary-color); }
.search-inner{
  display:flex; justify-content:center;
}
.search-input{ width: min(720px, 100%); }

/* look de l’input group (sobriété, pas de gros aplat) */
.search-input .input-group-text{
  background: var(--bs-body-bg);
  border-color: var(--bs-border-color);
}
.search-input .form-control{
  background: var(--bs-body-bg);
  border-color: var(--bs-border-color);
}
.search-input .btn{
  border-color: var(--bs-border-color);
}

/* Mobile : pleine largeur */
@media (max-width: 576px){
  .search-input{ width: 100%; }
}
.swal2-container { z-index: 3000 !important; }
  .mw-link{
    display:inline-flex; align-items:center;
    margin-left:.35rem; opacity:.85; text-decoration:none;
  }
  .mw-link:hover{ opacity:1; }
  .mw-link .bi{ font-size:.9rem; }
/* 1) La ligne méta plus petite et sans marge verticale */
.meta-line{
  margin-top: 0 !important;      /* écrase le mt-2 injecté */
  padding: .1rem .2rem;         /* resserré */
  font-size: .7rem;               /* plus petit */
  background: color-mix(in oklab, var(--tile-bg) 96%, transparent);
  border-top: 1px solid rgba(255,255,255,.08);
  border-bottom-left-radius: .75rem;
  border-bottom-right-radius: .75rem;
}

/* 2) La vignette (haut) garde les coins supérieurs */
.patchwork{
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
}

/* 3) Le conteneur global donne l’effet “tuile” (fond + ombre) */
.album-card{
  border-radius: .7rem;
  overflow: hidden;
  background: var(--tile-bg);
  box-shadow: 0 1px 3px rgba(0,0,0,.12);
}

/* 4) Resserre les éléments de la méta-ligne */
.meta-line .album-title{ font-size: inherit; line-height: 1.15; }
.meta-line .album-count{ font-size: .72em; padding: .1rem .35rem; }
.meta-line .mw-link{ font-size: .9em; opacity:.85; }
.meta-line .mw-link:hover{ opacity:1; }
/* === Compact tile style (aligné sur filaments_gallery) === */
.tile{
  border:1px solid var(--bs-border-color);
  border-radius:.75rem;
  overflow:hidden;
  background:var(--bs-body-bg);
  box-shadow:0 1px 3px rgba(0,0,0,.06);
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  cursor:pointer;
}
.tile:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.12);
  border-color:color-mix(in oklab, var(--bs-border-color) 60%, var(--bs-primary) 40%);
}
.thumb-wrap{
  position:relative;
  width:100%;
  aspect-ratio:1/1;
  background:#111827; /* placeholder sombre comme dans filaments */
}
.thumb{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover; object-position:center;
  display:block;
}
.badge-overlay{
  position:absolute; top:.4rem; right:.4rem;
  font-size:.85rem; background:rgba(0,0,0,.5);
  color:#fff; padding:.2rem .4rem; border-radius:.5rem;
}
.meta{ padding:.5rem .6rem; font-size:.85rem; }
.meta .line1{
  display:flex; align-items:center; gap:.35rem;
  white-space:nowrap; overflow:hidden;
}
.meta .line1 .text-truncate{ min-width:0; }
.meta .line2{
  font-size:.8rem; opacity:.8; margin-top:.15rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
/* badge compact (comme filaments) */
.badge-s{
  font-size:.68rem; padding:.15rem .35rem;
  background:var(--bs-secondary-bg); color:var(--bs-secondary-color);
  border-radius:.35rem;
}
/* === Cards compactes (aligné sur filaments) === */
.tile{
  border:1px solid var(--bs-border-color);
  border-radius:.75rem;
  background:var(--bs-body-bg);
  box-shadow:0 2px 6px rgba(0,0,0,.04);
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.tile:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.10);
  border-color:var(--bs-border-color);
}
.thumb-wrap{
  position:relative;
  width:100%;
  aspect-ratio:1/1;
  background:var(--bs-secondary-bg);
}
.thumb{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover; object-position:center;
  display:block;
}

/* Chip compteur en bas-gauche (façon filaments) */
.badge-chip{
  position:absolute; left:.5rem; bottom:.5rem;
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.2rem .45rem;
  font-size:.72rem; line-height:1;
  background:var(--bs-body-bg);
  color:var(--bs-body-color);
  border:1px solid var(--bs-border-color);
  border-radius:.5rem;
  box-shadow:0 1px 2px rgba(0,0,0,.06);
}
.badge-chip .bi{ opacity:.8; font-size:.8rem; }

/* Métadonnées sous l’image */
.meta{ padding:.5rem .6rem; font-size:.85rem; }
.meta .line1{
  display:flex; align-items:center; gap:.4rem;
  white-space:nowrap; overflow:hidden;
}
.meta .line1 .text-truncate{ min-width:0; }
.meta .line2{
  font-size:.8rem; opacity:.8; margin-top:.15rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* Lien MakerWorld calé à droite */
.mw-link{ margin-left:auto; display:inline-flex; align-items:center; }
.mw-link .mw-icon{ display:inline-flex; align-items:center; }
</style>
{% endblock %}

{% block content %}
<main class="gallery-page">
  <div class="container py-3">
    <!-- Search bar -->
    <div id="searchBar" class="mb-3">
      <div class="input-group">
        <span class="input-group-text bg-dark-subtle"><i class="bi bi-search"></i></span>
        <input id="q" type="search" class="form-control" placeholder="Rechercher un print, un groupe, un tag…">
        <button id="qClear" class="btn btn-outline-secondary" type="button" title="Effacer">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>
    </div>

    <!-- Gallery -->
    <div id="grid" class="g-grid"></div>
    <div id="sentinel" class="py-4 text-center text-secondary">Chargement…</div>
  </div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lb-toolbar">
    <div class="lb-actions">
      <button id="lbClose" class="btn btn-light btn-sm" title="Fermer (Esc)"><i class="bi bi-x-lg"></i></button>
      <button id="lbDelete" class="btn btn-danger btn-sm" title="Supprimer" data-requires-write><i class="bi bi-trash3"></i></button>
      <span id="lbName" class="badge text-bg-dark"></span>
    </div>
    <div class="lb-index"><span id="lbIdx">1</span> / <span id="lbTotal">1</span></div>
  </div>
  <img id="lbImg" alt="">
  <div class="lb-nav px-2">
    <button id="lbPrev" class="btn btn-outline-light"><i class="bi bi-chevron-left"></i></button>
    <button id="lbNext" class="btn btn-outline-light"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function setNavbarOffset(){
  const nav = document.querySelector('.navbar');
  const apply = () => {
    const h = nav ? nav.offsetHeight : 56;
    document.documentElement.style.setProperty('--navbar-h', `${h}px`);
  };
  apply();
  window.addEventListener('resize', apply, { passive: true });
})();
// === ÉTAT & DOM ==============================================================
const grid = document.getElementById('grid');
const sentinel = document.getElementById('sentinel');
const state = {
  page: 1, per: 60, loading: false, done: false,
  q: ''   // 👈 ajoutés
};
const params = new URLSearchParams(location.search);
const qInput = document.getElementById('q');
const qClear = document.getElementById('qClear');
const entRadios = { all: document.getElementById('entAll'),
                    prints: document.getElementById('entPrints'),
                    groups: document.getElementById('entGroups') };

state.q = params.get('q') || '';
qInput.value = state.q;

// Index d'albums (front) : key = "entity:id" → { entity,id,title,cardEl,photos:[{url,name,base}] }
const albums = new Map();

// Lightbox custom (ids fournis par ton HTML)
const LB = {
  root: document.getElementById('lightbox'),
  img:  document.getElementById('lbImg'),
  name: document.getElementById('lbName'),
  idx:  document.getElementById('lbIdx'),
  total:document.getElementById('lbTotal'),
  btnPrev: document.getElementById('lbPrev'),
  btnNext: document.getElementById('lbNext'),
  btnClose: document.getElementById('lbClose'),
  btnDelete: document.getElementById('lbDelete'),
  albumKey: null,
  index: 0,
};

function parseAlbumKeyFromUrl(url){
  try{
    const parts = new URL(url, window.location.origin).pathname.split('/');
    const entity = parts[3]; // prints | groups
    const id = parseInt(parts[4], 10);
    if(!entity || Number.isNaN(id)) return null;
    return { key:`${entity}:${id}`, entity, id };
  }catch{ return null; }
}

function albumTitle(entity, id, itemTitle){
  return itemTitle || (entity === 'prints' ? `Print #${id}` : `Group #${id}`);
}

function buildUrl(){
  const u = new URL('/api/gallery/photos', window.location.origin);
  u.searchParams.set('page', state.page);
  u.searchParams.set('per', state.per);
  if (state.q) u.searchParams.set('q', state.q);
  return u;
}

function resetAndReload(){
  // reset pagination + UI
  state.page = 1;
  state.done = false;
  state.loading = false;

  albums.clear();
  grid.innerHTML = '';
  sentinel.classList.remove('empty');
  sentinel.textContent = 'Chargement…';

  // push état dans l’URL
  const usp = new URLSearchParams(location.search);
  if (state.q && state.q.trim()) usp.set('q', state.q.trim());
  else usp.delete('q');
  history.replaceState(null, '', `${location.pathname}?${usp.toString()}`);

  // relance le chargement
  loadNext();
}

function debounce(fn, ms=250){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
}

// === LIGHTBOX ================================================================
function lbOpen(albumKey, startIndex=0){
  const a = albums.get(albumKey);
  if(!a || !a.photos.length) return;
  LB.albumKey = albumKey;
  LB.index    = Math.min(Math.max(0, startIndex), a.photos.length-1);
  lbRender();
  LB.root.classList.add('open');
}

function lbClose(){ LB.root.classList.remove('open'); }

function lbMove(delta){
  const a = albums.get(LB.albumKey);
  if(!a) return;
  LB.index = (LB.index + delta + a.photos.length) % a.photos.length;
  lbRender();
}

function lbRender(){
  const a = albums.get(LB.albumKey);
  const p = a.photos[LB.index];
  const specific = p.base || p.name || '';
  LB.name.textContent = specific ? `${a.title} - ${specific}` : a.title;
  LB.img.src = p.url;
  LB.img.alt = specific || a.title || '';
  LB.idx.textContent = String(LB.index + 1);
  LB.total.textContent = String(a.photos.length);
}

qInput.addEventListener('input', debounce(()=>{
  state.q = qInput.value.trim();
  resetAndReload();
}, 250));

qClear.addEventListener('click', ()=>{
  if (!qInput.value) return;
  qInput.value = '';
  state.q = '';
  resetAndReload();
});

// Brancher les boutons + clavier
LB.btnPrev.addEventListener('click', ()=> lbMove(-1));
LB.btnNext.addEventListener('click', ()=> lbMove(+1));
LB.btnClose.addEventListener('click', lbClose);
LB.btnDelete.addEventListener('click', async ()=>{
  const a = albums.get(LB.albumKey);
  const p = a?.photos?.[LB.index];
  if (!p) return;

  const ask = async () => {
    if (window.Swal) {
      const r = await Swal.fire({
        title: 'Supprimer cette photo ?',
        text: p.base || p.name || '',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Supprimer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#d33',
        reverseButtons: true,
      });
      return r.isConfirmed;
    }
    // Fallback natif
    return confirm('Supprimer cette photo ?');
  };

  if (!(await ask())) return;

  // TODO: suppression serveur si besoin
  // await fetch('/api/gallery/photo/delete', { method:'POST', ... });

  // Mise à jour locale
  a.photos.splice(LB.index, 1);
  if (!a.photos.length){
    a.cardEl.remove();
    albums.delete(LB.albumKey);
    lbClose();
    return;
  }
  updateAlbumUI(LB.albumKey);
  LB.index = Math.min(LB.index, a.photos.length - 1);
  lbRender();

  if (window.Swal) {
    Swal.fire({ toast:true, position:'top', timer:1500, showConfirmButton:false,
      icon:'success', title:'Photo supprimée' });
  }
});

document.addEventListener('keydown', (e)=>{
  if(!LB.root.classList.contains('open')) return;
  if(e.key === 'ArrowLeft') lbMove(-1);
  if(e.key === 'ArrowRight') lbMove(+1);
  if(e.key === 'Escape') lbClose();
});

// === RENDU ALBUMS ============================================================
function createAlbumCard(entity, id, title) {
  const card = document.createElement('div');
  card.className = 'album-card tile';
  card.dataset.entity = entity;
  card.dataset.id = id;
  card.dataset.key = `${entity}:${id}`;

card.innerHTML = `
  <div class="thumb-wrap">
    <img class="thumb" alt="">
    <span class="badge-chip d-none album-count">
      <i class="bi bi-collection"></i>
      <span class="count">0</span>
    </span>
  </div>
  <div class="meta">
    <div class="line1">
      <strong class="text-truncate album-title" title="${title}">${title}</strong>
      <a class="mw-link d-none" target="_blank" rel="noopener"
         title="Voir sur MakerWorld" aria-label="Voir sur MakerWorld">
        <div class="mw-icon"><i class="bi bi-globe2"></i></div>
      </a>
    </div>
    <div class="line2 text-truncate">${albumTitle(entity, id, title)}</div>
  </div>
`;

  // Clic carte = lightbox
  card.addEventListener('click', ()=>{ const a = albums.get(card.dataset.key); if(a) lbOpen(card.dataset.key, 0); });

  // ✅ 3) empêcher l’ouverture de la lightbox si on clique le lien
  const link = card.querySelector('.mw-link');
  link.addEventListener('click', (e)=> e.stopPropagation());

  grid.appendChild(card);
  return card;
}
function renderPatchwork(card, photos){
  const img = card.querySelector('.thumb-wrap .thumb');
  const chip = card.querySelector('.thumb-wrap .album-count');
  const countSpan = card.querySelector('.thumb-wrap .album-count .count');
  if (!img) return;

  if (!photos.length){
    img.removeAttribute('src');
    img.alt = '';
    if (chip) { chip.classList.add('d-none'); if (countSpan) countSpan.textContent = '0'; }
    return;
  }

  const cover = photos[0];
  img.src = cover.url;
  img.alt = cover.base || cover.name || '';

  if (chip && countSpan){
    const count = photos.length;
    if (count > 1){
      chip.classList.remove('d-none');
      countSpan.textContent = String(count);
    } else {
      chip.classList.add('d-none');
      countSpan.textContent = '0';
    }
  }
}

function updateAlbumUI(key){
  const a = albums.get(key);
  if(!a) return;
  const countEl = a.cardEl.querySelector('.album-count');

  renderPatchwork(a.cardEl, a.photos);

  if(a.photos.length > 1){
    icon.classList.remove('d-none');
    countEl.classList.remove('d-none');
	count = String(a.photos.length)
    countEl.textContent = `<i class="bi bi-images"></i> ×${count}`;
	;
  }else{
    icon.classList.add('d-none');
    countEl.classList.add('d-none');
  }
  const linkEl = a.cardEl.querySelector('.mw-link');
if (linkEl) {
  if (a.makerworldUrl) {
    linkEl.href = a.makerworldUrl;
    linkEl.classList.remove('d-none');
  } else {
    linkEl.removeAttribute('href');
    linkEl.classList.add('d-none');
  }
}
}

function addPhotoToAlbum(item){
  const parsed = parseAlbumKeyFromUrl(item.url || item.path || item.src);
  if(!parsed) return;
  const { key, entity, id } = parsed;

  if(!albums.has(key)){
    const title = albumTitle(entity, id, item.item_title);
    const cardEl = createAlbumCard(entity, id, title);
    cardEl.dataset.key = key;
    albums.set(key, { entity, id, title, cardEl, photos: [], makerworldUrl: null });
  }
  const a = albums.get(key);

  // ✅ 1) setter l’URL MakerWorld AVANT le rendu
  const mw = item.makerworld_url || item.makerworldUrl || null;
  if (mw && !a.makerworldUrl) {
    a.makerworldUrl = mw;
  }

  // Ajout de la photo si nouvelle
  if(!a.photos.some(p => p.url === item.url)){
    a.photos.push({ url:item.url, name:item.name, base:item.base_name });
  }

  // ✅ 2) mettre à jour l’UI après avoir set makerworldUrl et/ou ajouté la photo
  updateAlbumUI(key);
}
(() => {
  let startX = 0, startY = 0, dx = 0, dy = 0, active = false, lockedAxis = null;
  const THRESH = 48;   // distance minimale pour changer d'image
  const LOCK = 10;     // distance pour “locker” l’axe

  const onStart = (e) => {
    if (!LB.root.classList.contains('open')) return;
    const t = e.touches ? e.touches[0] : e;
    startX = t.clientX; startY = t.clientY;
    dx = dy = 0; active = true; lockedAxis = null;
  };

  const onMove = (e) => {
    if (!active) return;
    const t = e.touches ? e.touches[0] : e;
    dx = t.clientX - startX;
    dy = t.clientY - startY;
    if (!lockedAxis && (Math.abs(dx) > LOCK || Math.abs(dy) > LOCK)) {
      lockedAxis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
    }
    if (lockedAxis === 'x') {
      // on consomme l’événement pour éviter le scroll de page
      e.preventDefault();
      // (optionnel) feedback visuel : translate légère de l’image
      LB.img.style.transform = `translateX(${dx * 0.08}px)`;
    }
  };

  const onEnd = () => {
    if (!active) return;
    active = false;
    LB.img.style.transform = '';
    if (lockedAxis === 'x') {
      if (dx > THRESH)      lbMove(-1);
      else if (dx < -THRESH) lbMove(+1);
    }
  };

  LB.root.addEventListener('touchstart', onStart, { passive: true });
  LB.root.addEventListener('touchmove',  onMove,  { passive: false }); // ⚠️ pour pouvoir preventDefault
  LB.root.addEventListener('touchend',   onEnd,   { passive: true });
})();
// === DATA LOADING ============================================================


async function loadNext(){
  if (state.loading || state.done) return;
  state.loading = true;
  sentinel.textContent = 'Chargement…';

  try {
    const response = await fetch(buildUrl(), { credentials: 'same-origin' });
    if (!response.ok) throw new Error(`HTTP ${response.status}`);

    const data = await response.json();

    (data.items || []).forEach(addPhotoToAlbum);
    state.page += 1;
    state.done = !data.has_more;

    if (albums.size === 0 && state.done){
      sentinel.classList.add('empty');
      sentinel.textContent = state.q
        ? `Aucun résultat pour « ${state.q} »`
        : 'Aucun élément';
    } else {
      sentinel.classList.remove('empty');
      sentinel.textContent = state.done
        ? '— fin —'
        : 'Descendez pour charger la suite…';
    }
  } catch (err) {
    console.error('[gallery] loadNext failed:', err);
    sentinel.classList.add('empty');
    sentinel.textContent = 'Erreur de chargement';
  } finally {
    state.loading = false;
  }
}
const io = new IntersectionObserver((entries)=>{
  if(entries.some(e=>e.isIntersecting)) loadNext();
});
io.observe(sentinel);

// Boot
loadNext();
</script>
{% endblock %}