{% extends "base.html" %}

{% block styles %}
<style>
  :root { --thumb-size: 180px; }
  body.gallery-page { overflow-y: auto; background: var(--bs-body-bg); }

  .gallery-header {
    position: sticky; top: 0; z-index: 1030;
    backdrop-filter: blur(6px);
    background: color-mix(in oklab, var(--bs-body-bg) 85%, transparent);
    border-bottom: 1px solid rgba(255,255,255,.08);
  }

  /* au lieu de .grid / .thumb */
.g-grid {
  --g-thumb-size: 180px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--g-thumb-size), 1fr));
  gap: .75rem;
}

.g-thumb {
  position: relative;
  border-radius: .75rem;
  overflow: hidden;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.06);
  aspect-ratio: 1 / 1;
  cursor: zoom-in;
  min-width: var(--g-thumb-size);
  min-height: var(--g-thumb-size);
}

.g-thumb img {
  width: 100%; height: 100%;
  object-fit: cover; object-position: center; display: block;
}

.g-thumb .name {
  position: absolute; left: .5rem; bottom: .5rem;
  background: rgba(0,0,0,.55); color: #fff;
  padding: .15rem .5rem; border-radius: .35rem;
  font-size: .8rem; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  pointer-events: none;
}

.g-thumb .del { position: absolute; top: .35rem; right: .35rem; z-index: 2; }

.group-title { grid-column: 1 / -1; margin-top: 1.25rem; font-size: .9rem; color: var(--bs-secondary-color); display:flex; align-items:center; gap:.5rem; }
.group-title .dot { width:.5rem; height:.5rem; border-radius:50%; background:var(--bs-secondary-color); opacity:.6; }

  /* Lightbox */
  .lightbox { position: fixed; inset: 0; z-index: 2000; display: none; background: rgba(0,0,0,.92); }
  .lightbox.open { display: grid; place-items: center; }
  .lightbox img { max-width: 92vw; max-height: 86vh; object-fit: contain; box-shadow: 0 0 0 1px rgba(255,255,255,.08); border-radius: .5rem; }
  .lb-toolbar { position: fixed; top: .5rem; left: .5rem; right: .5rem; display: flex; align-items: center; justify-content: space-between; gap: .5rem; }
  .lb-actions { display: flex; gap: .5rem; }
  .lb-index { color: #fff; opacity: .8; font-size: .9rem; }
  .lb-nav { position: fixed; inset: 0; display: flex; align-items: center; justify-content: space-between; pointer-events: none; }
  .lb-nav .btn { pointer-events: all; border-radius: 999px; }

  @media (max-width: 576px) {
    :root { --thumb-size: 140px; }
    .lb-index { display: none; }
  }
.album-card{ width:220px; cursor:pointer; }
.album-photos{ display:none; }
.album-photos.show{ display:block; }
.album-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:.5rem; }
.album-grid .thumb{ display:block; border-radius:.5rem; overflow:hidden; }
.album-grid img{ width:100%; height:100%; object-fit:cover; display:block; }
#grid{ display:flex; flex-wrap:wrap; gap:1rem; }
</style>
{% endblock %}

{% block content %}
<main class="gallery-page">
   <div class="d-flex align-items-center gap-2">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="toggleGroup">
          <label class="form-check-label small" for="toggleGroup">Regrouper par item</label>
        </div>
      </div>

  <div class="container py-3">
    <div id="grid" class="g-grid"></div>
    <div id="sentinel" class="py-4 text-center text-secondary">Chargement…</div>
  </div>

</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lb-toolbar">
    <div class="lb-actions">
      <button id="lbClose" class="btn btn-light btn-sm" title="Fermer (Esc)"><i class="bi bi-x-lg"></i></button>
      <button id="lbDelete" class="btn btn-danger btn-sm" title="Supprimer" data-requires-write><i class="bi bi-trash3"></i></button>
      <span id="lbName" class="badge text-bg-dark"></span>
    </div>
    <div class="lb-index"><span id="lbIdx">1</span> / <span id="lbTotal">1</span></div>
  </div>
  <img id="lbImg" alt="">
  <div class="lb-nav px-2">
    <button id="lbPrev" class="btn btn-outline-light"><i class="bi bi-chevron-left"></i></button>
    <button id="lbNext" class="btn btn-outline-light"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Conteneurs existants
const grid = document.getElementById('grid');
const sentinel = document.getElementById('sentinel');

// État actuel (garde tes filtres/tri si tu en as)
const state = { page: 1, per: 60, loading: false, done: false };

// Index d'albums en pur front
// key = `${entity}:${id}` -> { cardEl, coverSet, count, photos: [{url,name,base}] , title }
const albums = new Map();

// Utilitaire: extrait entity/id depuis l'URL
function parseAlbumKeyFromUrl(url) {
  // /static/uploads/<entity>/<id>/<filename>
  try {
    const parts = new URL(url, window.location.origin).pathname.split('/');
    const entity = parts[3]; // prints | groups
    const id = parseInt(parts[4], 10);
    if (!entity || isNaN(id)) return null;
    return { key: `${entity}:${id}`, entity, id };
  } catch { return null; }
}

// Titre d'album (fallback lisible)
function albumTitle(entity, id) {
  return `${entity === 'prints' ? 'Print' : 'Group'} #${id}`;
}

// Crée une carte album (une seule par album)
function createAlbumCard(entity, id, title) {
  const card = document.createElement('div');
  card.className = 'album-card position-relative';
  card.innerHTML = `
    <div class="ratio ratio-1x1 rounded overflow-hidden shadow-sm bg-light">
      <img class="album-cover w-100 h-100 object-fit-cover" alt="${title}" />
    </div>
    <div class="mt-2 d-flex align-items-center gap-2">
      <i class="bi bi-folder2"></i>
      <span class="text-truncate album-title" title="${title}">${title}</span>
      <span class="badge text-bg-secondary ms-auto album-count">0</span>
    </div>
    <div class="album-photos collapse mt-2"></div>
  `;

  // Toggle expansion
  card.addEventListener('click', (ev) => {
    if (ev.target.closest('.album-photos')) return; // clic à l’intérieur, ne rien faire
    const body = card.querySelector('.album-photos');
    const open = body.classList.contains('show');
    document.querySelectorAll('.album-photos.show').forEach(el => el.classList.remove('show'));
    if (open) { body.classList.remove('show'); return; }
    body.classList.add('show');
  });

  grid.appendChild(card);
  return card;
}

// Met à jour la cover, le compteur, et la grille interne
function updateAlbumUI(key) {
  const a = albums.get(key);
  if (!a) return;
  const coverEl = a.cardEl.querySelector('.album-cover');
  const countEl = a.cardEl.querySelector('.album-count');
  const body = a.cardEl.querySelector('.album-photos');

  // Cover: première photo vue (ou garde celle déjà posée)
  if (!a.coverSet && a.photos.length) {
    coverEl.src = a.photos[0].url;
    a.coverSet = true;
  }

  // Compteur
  countEl.textContent = a.count.toString();

  // Corps (vignettes autres que la cover)
  const others = a.photos.slice(1); // évite la cover
  if (!others.length) {
    body.innerHTML = '<div class="text-muted small">Aucune autre photo</div>';
  } else {
    body.innerHTML = `
      <div class="album-grid">
        ${others.map(p => `
          <a href="${p.url}" class="thumb" target="_blank" title="${a.title}">
            <img src="${p.url}" alt="${p.name}">
          </a>
        `).join('')}
      </div>
    `;
  }
}

// Ajoute une photo dans l’album correspondant (création si besoin)
function addPhotoToAlbum(item) {
  const parsed = parseAlbumKeyFromUrl(item.url || item.path || item.src);
  if (!parsed) return;

  const { key, entity, id } = parsed;
  if (!albums.has(key)) {
    const title = item.item_title || albumTitle(entity, id);
    const cardEl = createAlbumCard(entity, id, title);
    albums.set(key, { entity, id, title, cardEl, coverSet: false, count: 0, photos: [] });
  }
  const a = albums.get(key);

  // Dédup (au cas où la pagination renverrait une photo déjà vue)
  if (!a.photos.some(p => p.url === item.url)) {
    a.photos.push({ url: item.url, name: item.name, base: item.base_name });
    a.count++;
    updateAlbumUI(key);
  }
}

// Construit l’URL existante (tu gardes ta façon actuelle)
function buildUrl() {
  const url = new URL(`/api/gallery/photos`, window.location.origin);
  url.searchParams.set('page', state.page);
  url.searchParams.set('per', state.per);
  // si tu as déjà q/sort/entity, ajoute-les ici
  return url;
}

async function loadNext() {
  if (state.loading || state.done) return;
  state.loading = true;
  sentinel.textContent = 'Chargement…';
  try {
    const res = await fetch(buildUrl());
    const data = await res.json();

    // data.items = [{url,name,base_name,item_title,entity,entity_id}, ...]
    (data.items || []).forEach(addPhotoToAlbum);

    state.page++;
    state.done = !data.has_more;
    sentinel.textContent = state.done ? '— fin —' : 'Descendez pour charger la suite…';
  } catch (e) {
    console.error(e);
    sentinel.textContent = 'Erreur de chargement';
  } finally {
    state.loading = false;
  }
}

// Infinite scroll
const io = new IntersectionObserver((entries) => {
  if (entries.some(e => e.isIntersecting)) loadNext();
});
io.observe(sentinel);

// Si tu as des filtres/tri/recherche existants, appelle reset() puis loadNext() sur changement
function reset() {
  state.page = 1; state.done = false;
  grid.innerHTML = '';
  albums.clear();
  loadNext();
}

// Premier chargement
loadNext();
</script>

{% endblock %}