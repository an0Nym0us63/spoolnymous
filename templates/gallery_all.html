{% extends "base.html" %}
{% block styles %}
<style>
:root{
  --thumb-size: 180px;
  --tile-bg: #111; /* couleur de fond des tuiles (clair: #f5f5f5) */
}

body.gallery-page{ overflow-y:auto; background:var(--bs-body-bg); }

.gallery-header{
  position:sticky; top:0; z-index:1030;
  backdrop-filter:blur(6px);
  background: color-mix(in oklab, var(--bs-body-bg) 85%, transparent);
  border-bottom:1px solid rgba(255,255,255,.08);
}

/* Grille principale (cards album) */
.g-grid{
  --g-thumb-size: 220px;
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--g-thumb-size), 1fr));
  gap:1rem;
}

/* Carte d’album */
.album-card{ cursor:pointer; }
.meta-line{ min-height:28px; }
.album-title{ font-size:.95rem; line-height:1.2; }
.album-count{ font-size:.75rem; }

/* Tuile carrée */
.patchwork{
  position: relative;
  width: 100%;
  aspect-ratio: 1 / 1;              /* carré responsive */
  border-radius: .75rem;
  overflow: hidden;
  background: var(--tile-bg);
  box-shadow: 0 1px 3px rgba(0,0,0,.08);
}

/* Pile de 1 à 3 images superposées */
.patchwork.stack img{
  position:absolute; inset:0;
  width:100%; height:100%;
  object-fit:cover; object-position:center;
  border-radius: .75rem;
  box-shadow: 0 0 0 1px rgba(0,0,0,.08);
  transition: transform .2s ease;
}

/* 1 = fond, 2 = milieu, 3 = au-dessus (visible) */
.patchwork.stack .layer-1{
  z-index:1;
  transform: translateY(12px) scale(.984);
  filter: brightness(.96);
}
.patchwork.stack .layer-2{
  z-index:2;
  transform: translateY(6px) scale(.992);
  filter: brightness(.98);
}
.patchwork.stack .layer-3{
  z-index:3;
  transform: translateY(0);
  filter: none;
}

/* Lightbox */
.lightbox{ position:fixed; inset:0; z-index:2000; display:none; background:rgba(0,0,0,.92); }
.lightbox.open{ display:grid; place-items:center; }
.lightbox img{ max-width:92vw; max-height:86vh; object-fit:contain; box-shadow:0 0 0 1px rgba(255,255,255,.08); border-radius:.5rem; }
.lb-toolbar{ position:fixed; top:.5rem; left:.5rem; right:.5rem; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
.lb-actions{ display:flex; gap:.5rem; }
.lb-index{ color:#fff; opacity:.8; font-size:.9rem; }
.lb-nav{ position:fixed; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none; }
.lb-nav .btn{ pointer-events:all; border-radius:999px; }

/* Mobile : 3 colonnes + pile plus compacte */
@media (max-width: 576px){
  .g-grid{
    grid-template-columns: repeat(3, 1fr) !important;
    gap: .6rem;
  }
  .meta-line{ min-height:22px; }
  .album-title{ font-size:.78rem; }
  .album-count{ font-size:.68rem; padding:.1rem .35rem; }
  .lb-index{ display:none; }

  .patchwork.stack .layer-1{ transform: translateY(8px)  scale(.988); }
  .patchwork.stack .layer-2{ transform: translateY(4px)  scale(.994); }
}
</style>
{% endblock %}

{% block content %}
<main class="gallery-page">
  <div class="container py-3">
    <div id="grid" class="g-grid"></div>
    <div id="sentinel" class="py-4 text-center text-secondary">Chargement…</div>
  </div>

</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lb-toolbar">
    <div class="lb-actions">
      <button id="lbClose" class="btn btn-light btn-sm" title="Fermer (Esc)"><i class="bi bi-x-lg"></i></button>
      <button id="lbDelete" class="btn btn-danger btn-sm" title="Supprimer" data-requires-write><i class="bi bi-trash3"></i></button>
      <span id="lbName" class="badge text-bg-dark"></span>
    </div>
    <div class="lb-index"><span id="lbIdx">1</span> / <span id="lbTotal">1</span></div>
  </div>
  <img id="lbImg" alt="">
  <div class="lb-nav px-2">
    <button id="lbPrev" class="btn btn-outline-light"><i class="bi bi-chevron-left"></i></button>
    <button id="lbNext" class="btn btn-outline-light"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// === ÉTAT & DOM ==============================================================
const grid = document.getElementById('grid');
const sentinel = document.getElementById('sentinel');
const state = { page:1, per:60, loading:false, done:false };

// Index d'albums (front) : key = "entity:id" → { entity,id,title,cardEl,photos:[{url,name,base}] }
const albums = new Map();

// Lightbox custom (ids fournis par ton HTML)
const LB = {
  root: document.getElementById('lightbox'),
  img:  document.getElementById('lbImg'),
  name: document.getElementById('lbName'),
  idx:  document.getElementById('lbIdx'),
  total:document.getElementById('lbTotal'),
  btnPrev: document.getElementById('lbPrev'),
  btnNext: document.getElementById('lbNext'),
  btnClose: document.getElementById('lbClose'),
  btnDelete: document.getElementById('lbDelete'),
  albumKey: null,
  index: 0,
};

function parseAlbumKeyFromUrl(url){
  try{
    const parts = new URL(url, window.location.origin).pathname.split('/');
    const entity = parts[3]; // prints | groups
    const id = parseInt(parts[4], 10);
    if(!entity || Number.isNaN(id)) return null;
    return { key:`${entity}:${id}`, entity, id };
  }catch{ return null; }
}

function albumTitle(entity, id, itemTitle){
  return itemTitle || (entity === 'prints' ? `Print #${id}` : `Group #${id}`);
}

function buildUrl(){
  const u = new URL('/api/gallery/photos', window.location.origin);
  u.searchParams.set('page', state.page);
  u.searchParams.set('per', state.per);
  return u;
}

// === LIGHTBOX ================================================================
function lbOpen(albumKey, startIndex=0){
  const a = albums.get(albumKey);
  if(!a || !a.photos.length) return;
  LB.albumKey = albumKey;
  LB.index    = Math.min(Math.max(0, startIndex), a.photos.length-1);
  lbRender();
  LB.root.classList.add('open');
}

function lbClose(){ LB.root.classList.remove('open'); }

function lbMove(delta){
  const a = albums.get(LB.albumKey);
  if(!a) return;
  LB.index = (LB.index + delta + a.photos.length) % a.photos.length;
  lbRender();
}

function lbRender(){
  const a = albums.get(LB.albumKey);
  const p = a.photos[LB.index];
  const specific = p.base || p.name || '';
  LB.name.textContent = specific ? `${a.title} - ${specific}` : a.title;
  LB.img.src = p.url;
  LB.img.alt = specific || a.title || '';
  LB.idx.textContent = String(LB.index + 1);
  LB.total.textContent = String(a.photos.length);
}

// Brancher les boutons + clavier
LB.btnPrev.addEventListener('click', ()=> lbMove(-1));
LB.btnNext.addEventListener('click', ()=> lbMove(+1));
LB.btnClose.addEventListener('click', lbClose);
LB.btnDelete.addEventListener('click', async ()=>{
  const a = albums.get(LB.albumKey);
  const p = a?.photos?.[LB.index];
  if(!p) return;
  if(!confirm('Supprimer cette photo ?')) return;
  // TODO: Appelle ton endpoint de suppression ici si besoin.
  a.photos.splice(LB.index, 1);
  if(!a.photos.length){
    // retire la carte
    a.cardEl.remove();
    albums.delete(LB.albumKey);
    lbClose();
    return;
  }
  updateAlbumUI(LB.albumKey);
  LB.index = Math.min(LB.index, a.photos.length - 1);
  lbRender();
});

document.addEventListener('keydown', (e)=>{
  if(!LB.root.classList.contains('open')) return;
  if(e.key === 'ArrowLeft') lbMove(-1);
  if(e.key === 'ArrowRight') lbMove(+1);
  if(e.key === 'Escape') lbClose();
});

// === RENDU ALBUMS ============================================================
function createAlbumCard(entity, id, title){
  const card = document.createElement('div');
  card.className = 'album-card';

  card.innerHTML = `
    <div class="patchwork"><!-- thumbs injectées --></div>
    <div class="mt-2 d-flex align-items-center gap-2 meta-line">
      <i class="bi bi-folder2 d-none album-icon"></i>
      <span class="text-truncate album-title" title="${title}">${title}</span>
      <span class="badge text-bg-secondary ms-auto d-none album-count">0</span>
    </div>
  `;

  // Clic = ouvrir le diaporama (index 0 par défaut)
  card.addEventListener('click', ()=>{
    const key = card.dataset.key;
    const a = albums.get(key);
    if(!a) return;
    lbOpen(key, 0);
  });

  grid.appendChild(card);
  return card;
}

function renderPatchwork(card, photos){
  const box = card.querySelector('.patchwork');
  box.className = 'patchwork stack';

  if (!photos.length) { box.innerHTML = ''; return; }

  // On prend jusqu'à 3 photos ; top = la 1ʳᵉ, dessous = 2ᵉ puis 3ᵉ
  const n = Math.min(3, photos.length);

  // indices du bas vers le haut : [2,1,0] (ou [1,0], [0])
  const indices = Array.from({length:n}, (_,i) => n - 1 - i);

  box.innerHTML = indices
    .map((idx, layerIdx) => {
      const p = photos[idx];
      const alt = p.base || p.name || '';
      return `<img loading="lazy" src="${p.url}" class="layer-${layerIdx+1}" alt="${alt}">`;
    })
    .join('');
}

function updateAlbumUI(key){
  const a = albums.get(key);
  if(!a) return;
  const icon = a.cardEl.querySelector('.album-icon');
  const countEl = a.cardEl.querySelector('.album-count');

  renderPatchwork(a.cardEl, a.photos);

  if(a.photos.length > 1){
    icon.classList.remove('d-none');
    countEl.classList.remove('d-none');
    countEl.textContent = String(a.photos.length);
  }else{
    icon.classList.add('d-none');
    countEl.classList.add('d-none');
  }
}

function addPhotoToAlbum(item){
  const parsed = parseAlbumKeyFromUrl(item.url || item.path || item.src);
  if(!parsed) return;
  const { key, entity, id } = parsed;

  if(!albums.has(key)){
    const title = albumTitle(entity, id, item.item_title);
    const cardEl = createAlbumCard(entity, id, title);
    cardEl.dataset.key = key;
    albums.set(key, { entity, id, title, cardEl, photos: [] });
  }
  const a = albums.get(key);

  if(!a.photos.some(p => p.url === item.url)){
    a.photos.push({ url:item.url, name:item.name, base:item.base_name });
    updateAlbumUI(key);
  }
}

// === DATA LOADING ============================================================
async function loadNext(){
  if(state.loading || state.done) return;
  state.loading = true;
  sentinel.textContent = 'Chargement…';
  try{
    const res = await fetch(buildUrl());
    const data = await res.json();
    (data.items || []).forEach(addPhotoToAlbum);
    state.page++;
    state.done = !data.has_more;
    sentinel.textContent = state.done ? '— fin —' : 'Descendez pour charger la suite…';
  }catch(e){
    console.error(e);
    sentinel.textContent = 'Erreur de chargement';
  }finally{
    state.loading = false;
  }
}

const io = new IntersectionObserver((entries)=>{
  if(entries.some(e=>e.isIntersecting)) loadNext();
});
io.observe(sentinel);

// Boot
loadNext();
</script>
{% endblock %}