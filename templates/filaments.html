{% extends 'base.html' %}

{% block content %}
{% import 'macros/hidden_args.jinja2' as macros %}

<style>
/* Badges sobres (gris) ‚Äî comme sur bobines */
.badge-sx {
  font-weight: 600;
  padding: .35rem .5rem;
  background: rgba(255,255,255,.08);
  color: #e9ecef;
  border-radius: .5rem;
}

/* Strip couleur pleine hauteur */
.color-strip { flex: 0 0 12px; align-self: stretch; }
.color-strip > div { width:100%; height:100%; display:block; }

/* Pastilles hex dans le d√©tail */
.hex-pill {
  display:inline-block; width:18px; height:18px; border-radius:4px;
  border:1px solid rgba(255,255,255,.25); vertical-align:-3px; margin-right:.25rem;
}

/* Responsive l√©ger */
@media (max-width: 576px){
  .badge-sx{ padding:.28rem .45rem; font-size:.85rem; }

  .btn-actions {
    padding: .25rem .5rem;
    border-radius: .5rem;
  }
 }
 /* Layout header */
.fil-header {
  display: grid;
  grid-template-columns: 12px 1fr auto;      /* strip | titre | badges */
  grid-template-areas: "strip title badges";
  gap: .5rem;
  align-items: center;
}
.color-strip { grid-area: strip; flex: 0 0 12px; align-self: stretch; }
.fil-title   { grid-area: title; min-width: 0; } /* le titre prend tout le reste */
.fil-badges  {
  grid-area: badges;
  display: flex; gap: .25rem; flex-wrap: wrap; justify-content: flex-end;
  align-items: center;
}

/* Titre : ne pas couper, autoriser retour √† la ligne propre */
.fil-title .line1,
.fil-title .line2 {
  white-space: normal; overflow: visible; text-overflow: clip;
  word-break: break-word; hyphens: auto;
}

/* Badges compacts */
.badge-sx { font-size: .78rem; padding: .18rem .35rem; line-height: 1.1; }
.fil-badges .badge-sx { max-width: 100%; }

/* Mobile : badges sous le titre, empil√©s et plus petits */
@media (max-width: 576px){
  .fil-header {
    grid-template-columns: 12px 1fr;
    grid-template-areas:
      "strip title"
      "strip badges";
    align-items: start;
  }
  .fil-badges {
  display: flex;
  flex-direction: column;  /* d√©j√† en colonne */
  align-items: flex-end;   /* badges coll√©s √† droite */
  justify-content: flex-start; /* ‚¨ÖÔ∏è aligne en haut */
  gap: .2rem;
}
  .badge-sx { font-size: .72rem; padding: .16rem .32rem; }
}
</style>

<!-- Boutons flottants (comme bobines) -->
<div class="position-fixed bottom-0 end-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#paginationOffcanvas"
          aria-controls="paginationOffcanvas">üìÑ</button>
</div>
<div class="position-fixed bottom-0 start-0 m-3" style="z-index:1030;">
  <button class="btn btn-sm btn-primary rounded-circle" type="button"
          data-bs-toggle="offcanvas" data-bs-target="#filtersOffcanvas"
          aria-controls="filtersOffcanvas">üîç</button>
</div>

<!-- OFFCANVAS FILTRES -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="filtersOffcanvas" aria-labelledby="filtersOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="filtersOffcanvasLabel">Filtres & Tri</h5>
    <div class="d-flex align-items-center gap-2 ms-auto">
      <a class="btn btn-link text-muted" id="resetFiltersBtn" href="{{ url_for(request.endpoint) }}" title="R√©initialiser les filtres">
        <i class="bi bi-arrow-counterclockwise fs-5"></i>
      </a>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
  </div>
  <div class="offcanvas-body">
    <form method="get" class="row g-2 align-items-end">
      {{ macros.render_filtered_args(args, ['search','color','sort','page','manufacturer','material']) }}

      <div class="col-md-4">
        <input type="text" name="search" class="form-control"
               placeholder="Recherche nom, mat√©riau, fabricant ou couleur"
               value="{{ search }}">
      </div>

      <input type="hidden" name="page" value="1">

      <div class="col-md-3">
        <select name="color" class="form-select select2" data-placeholder="Famille couleur">
          <option value=""></option>
          {% for fam in all_families or [] %}
            <option value="{{ fam }}" {% if fam == selected_family %}selected{% endif %}>{{ fam }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        {% if all_materials %}
          <select name="material" class="form-select select2" data-placeholder="Mat√©riau">
            <option value=""></option>
            {% for mat in all_materials %}
              <option value="{{ mat }}" {% if mat == material %}selected{% endif %}>{{ mat }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="material" class="form-control" placeholder="Mat√©riau" value="{{ material or '' }}">
        {% endif %}
      </div>

      <div class="col-md-3">
        {% if all_manufacturers %}
          <select name="manufacturer" class="form-select select2" data-placeholder="Fabricant">
            <option value=""></option>
            {% for manu in all_manufacturers %}
              <option value="{{ manu }}" {% if manu == manufacturer %}selected{% endif %}>{{ manu }}</option>
            {% endfor %}
          </select>
        {% else %}
          <input type="text" name="manufacturer" class="form-control" placeholder="Fabricant" value="{{ manufacturer or '' }}">
        {% endif %}
      </div>

      <div class="col-md-3">
        <select name="sort" class="form-select">
          <option value="default" {% if sort == 'default' %}selected{% endif %}>Trier par Mat√©riau/Fabricant/Nom</option>
          <option value="name"    {% if sort == 'name'    %}selected{% endif %}>Trier par Nom</option>
          <option value="price"   {% if sort == 'price'   %}selected{% endif %}>Trier par Prix</option>
          <option value="weight"  {% if sort == 'weight'  %}selected{% endif %}>Trier par Poids filament</option>
        </select>
      </div>

      <div class="col-12 d-flex justify-content-center align-self-end">
        <button type="submit" class="btn btn-primary">Appliquer</button>
      </div>
    </form>
  </div>
</div>

<!-- OFFCANVAS PAGINATION -->
<div class="offcanvas offcanvas-bottom h-auto" tabindex="-1" id="paginationOffcanvas" aria-labelledby="paginationOffcanvasLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="paginationOffcanvasLabel">Pagination</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
  </div>
  <div class="offcanvas-body text-center">
    <div class="d-inline-flex flex-wrap gap-1 align-items-center justify-content-center">
      {% if page > 1 %}
        <a href="{{ url_with_args(page=1) }}" class="btn btn-outline-primary btn-sm">&laquo;</a>
        <a href="{{ url_with_args(page=page-1) }}" class="btn btn-outline-primary btn-sm">&lsaquo;</a>
      {% endif %}

      <form method="get" class="d-inline-flex align-items-center mx-2">
        {{ macros.render_filtered_args(args, ['page']) }}
        <label for="pageInput" class="me-1">Page</label>
        <input type="number" min="1" max="{{ total_pages }}" id="pageInput" name="page"
               class="form-control form-control-sm" style="width:64px;" value="{{ page }}">
        <button type="submit" class="btn btn-sm btn-primary ms-1">Aller</button>
      </form>

      <span>/{{ total_pages }}</span>

      {% if page < total_pages %}
        <a href="{{ url_with_args(page=page+1) }}" class="btn btn-outline-primary btn-sm">&rsaquo;</a>
        <a href="{{ url_with_args(page=total_pages) }}" class="btn btn-outline-primary btn-sm">&raquo;</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- STATS (m√™me look que bobines) -->
<div class="row row-cols-3 g-2 mb-3 text-center align-items-stretch">
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
    <div class="fs-5 fs-md-4">üßµ</div><div class="small fw-bold">{{ total_filaments }}</div><div class="text-muted small">Filaments</div>
  </div></div></div>
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
    <div class="fs-5 fs-md-4">üè≠</div><div class="small fw-bold">{{ total_manufacturers }}</div><div class="text-muted small">Fabricants</div>
  </div></div></div>
  <div class="col"><div class="card border-0 shadow-sm h-100"><div class="card-body px-2 d-flex flex-column justify-content-center align-items-center py-1 py-md-2">
    <div class="fs-5 fs-md-4">‚öóÔ∏è</div><div class="small fw-bold">{{ total_materials }}</div><div class="text-muted small">Mat√©riaux</div>
  </div></div></div>
</div>
<div class="d-flex align-items-center gap-2">
    <button class="btn btn-primary" id="btn-add-filament" onclick="openFilamentModal()">
      <span class="me-1">Ajouter</span>
      <i class="bi bi-plus-lg"></i> <!-- si Bootstrap Icons, sinon retire l‚Äôic√¥ne -->
    </button>
  </div>
<!-- LISTE (accord√©ons *identiques* √† bobines) -->
<div class="accordion" id="filamentsCatalogAccordion">
  {% for fil in filaments %}
    <div class="accordion-item"
         style="border-radius: 0.75rem; margin-bottom: 0.3rem; background-color: #1e293b; box-shadow: 0 0 10px rgba(0,0,0,0.3);">

      <h2 class="accordion-header d-flex justify-content-between align-items-center"
          id="headingFilament{{ fil.id }}"
          style="border-radius: 0.75rem;">

        <div class="flex-grow-1">
          <button class="accordion-button collapsed py-1 sm:py-2 px-3 w-100 text-start"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseFilament{{ fil.id }}"
                  aria-expanded="false"
                  aria-controls="collapseFilament{{ fil.id }}"
                  style="border-radius: 0.75rem; font-size: 0.85rem;">
				<div class="fil-header w-100">
  <!-- Strip couleur -->
  <div class="color-strip">
    {% if fil.colors_array %}
      {% set colors = fil.colors_array.split(',') if fil.colors_array is string else fil.colors_array %}
      <div style="background: linear-gradient(180deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></div>
    {% elif fil.color %}
      <div style="background:#{{ fil.color|replace('#','') }};"></div>
    {% else %}
      <div style="background:#666;"></div>
    {% endif %}
  </div>

  <!-- Titre : Material ¬∑ Name / Manufacturer -->
  <div class="fil-title ps-2">
    <div class="line1">
      <span class="text-muted">{{ fil.material or '‚Äî' }}</span> ¬∑
      <span class="fw-semibold">{{ fil.name or '‚Äî' }}</span>
    </div>
    <div class="line2 small fst-italic text-muted">
      {{ fil.manufacturer or '‚Äî' }}
    </div>
  </div>

  <!-- Badges : prix / poids / profile_id (sans libell√©) -->
  <div class="fil-badges pe-2">
	<span class="badge badge-sx">
    üßµ {{ fil.spools_count or 0 }}
  </span>
  </div>
</div>
          </button>
        </div>
      </h2>

      <div id="collapseFilament{{ fil.id }}" class="accordion-collapse collapse"
           aria-labelledby="headingFilament{{ fil.id }}" data-bs-parent="#filamentsCatalogAccordion">
        <div class="accordion-body position-relative">
          <div class="d-flex justify-content-end mb-2">
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle"
                      type="button" id="actionsMenu-{{ fil.id }}"
                      data-bs-toggle="dropdown" aria-expanded="false" aria-label="Actions">
                <i class="bi bi-three-dots-vertical"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsMenu-{{ fil.id }}">
                <li>
                  <button class="dropdown-item" onclick='openFilamentModal({{ fil|tojson|safe }})'>
                    ‚úèÔ∏è √âditer
                  </button>
                </li>
                <li>
                  <button class="dropdown-item"
                          onclick='openSpoolModalForFilament({{ fil|tojson|safe }})'>
                    ‚ûï Cr√©er une bobine
                  </button>
                </li>
{% if (fil.spools_count or 0) > 0 %}
    <li>
      <button class="dropdown-item disabled text-muted" title="Impossible : des bobines sont rattach√©es" type="button">
        üóëÔ∏è Supprimer
      </button>
    </li>
  {% else %}
    <li>
      <button class="dropdown-item text-danger" type="button"
              data-bs-toggle="modal" data-bs-target="#deleteFilamentModal_{{ fil.id }}">
        üóëÔ∏è Supprimer
      </button>
    </li>
  {% endif %}
    <!-- autres actions √† venir -->
  </ul>
</div>
</div>
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Nom :</strong> {{ fil.name or '‚Äî' }}</li>
                <li><strong>Fabricant :</strong> {{ fil.manufacturer or '‚Äî' }}</li>
                <li><strong>Mat√©riau :</strong> {{ fil.material or '‚Äî' }}</li>
                <li><strong>Couleur(s) :</strong>
                  {% if fil.colors_array %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background: linear-gradient(90deg,{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %}, {% endif %}{% endfor %});"></span>
                    <span class="ms-2">{% for c in colors %}#{{ c|trim|replace('#','') }}{% if not loop.last %} / {% endif %}{% endfor %}</span>
                  {% elif fil.color %}
                    <span class="hex-pill" style="width:22px;height:22px;vertical-align:-5px;background:#{{ fil.color|replace('#','') }}"></span>
                    <span class="ms-2">#{{ fil.color|replace('#','') }}</span>
                  {% else %} ‚Äî {% endif %}
                </li>
				<li><strong>Type couleur :</strong>{{ (fil.multicolor_type or 'monochrome')|capitalize }}</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled mb-0">
                <li><strong>Prix :</strong> {{ fil.price is not none and (fil.price ~ ' ‚Ç¨') or '‚Äî' }}</li>
                <li><strong>Poids filament :</strong> {{ fil.filament_weight_g or '‚Äî' }} g</li>
                <li><strong>Tare bobine :</strong> {{ fil.spool_weight_g or '‚Äî' }} g</li>
                <li><strong>Cr√©√© le :</strong> {% if fil.created_at %}{{ fil.created_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>Mis √† jour :</strong> {% if fil.updated_at %}{{ fil.updated_at|datetimeformat }}{% else %}‚Äî{% endif %}</li>
                <li><strong>Profil ID :</strong> {{ fil.profile_id or '‚Äî' }}</li>
              </ul>
            </div>
            {% if fil.comment %}
            <div class="col-12">
              <div class="small text-muted"><strong>Commentaire :</strong><br>{{ fil.comment }}</div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
	
{% if (fil.spools_count or 0) == 0 %}
<div class="modal fade" id="deleteFilamentModal_{{ fil.id }}" tabindex="-1" aria-labelledby="deleteFilamentLabel_{{ fil.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{{ url_for('remove_filament_route', filament_id=fil.id) }}">
        {{ macros.render_filtered_args(args, ['search','color','material','manufacturer','sort','page']) }}
        <div class="modal-header">
          <h5 class="modal-title" id="deleteFilamentLabel_{{ fil.id }}">Supprimer le filament ¬´ {{ fil.name }} ¬ª ?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Cette action est <strong>d√©finitive</strong>. Aucune bobine n‚Äôest rattach√©e √† ce filament.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="submit" class="btn btn-danger">üóëÔ∏è Supprimer</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
  {% else %}
    <div class="alert alert-secondary">Aucun filament trouv√©.</div>
  {% endfor %}
</div>
<div class="modal fade" id="filamentModal" tabindex="-1" aria-labelledby="filamentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="filamentModalLabel">Ajouter un filament</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
		<button type="button" class="btn btn-outline-primary d-none" id="btn-open-import-modal">
  üì• Importer depuis le catalogue
</button>
        <form id="filamentForm">
          <input type="hidden" id="filament_id">

          <div class="mb-3">
            <label class="form-label">Nom</label>
            <input type="text" class="form-control" id="name" required>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Fabricant</label>
              <select id="manufacturer" placeholder="Choisir ou saisir..." class="form-select"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Mat√©riau</label>
              <select id="material" placeholder="Choisir ou saisir..." class="form-select"></select>
            </div>
          </div>

          <div class="mt-3">
            <label class="form-label">Type de couleur</label>
            <select id="multicolor_type" class="form-select">
              <option value="monochrome" selected>Monocouleur</option>
              <option value="coaxial">Coaxial</option>
              <option value="gradient">Gradient</option>
            </select>
          </div>

          <div id="monoColorBlock" class="mt-3">
            <label class="form-label d-block">Couleur</label>
            <input type="color" id="mono_color" value="#ffffff">
            <input type="text" id="mono_color_hex" class="form-control mt-2" placeholder="#RRGGBB" value="#ffffff">
          </div>

          <div id="multiColorBlock" class="mt-3" style="display:none">
            <label class="form-label d-block">Couleurs</label>
            <div id="multiColors"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addMultiColor()">Ajouter une couleur</button>
            <div class="form-text">L‚Äôordre n‚Äôa pas d‚Äôimportance pour la d√©tection de doublons.</div>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-md-6">
              <label class="form-label">Poids filament (g)</label>
              <input type="number" min="0" step="1" class="form-control" id="filament_weight_g" value="1000">
            </div>
            <div class="col-md-6">
              <label class="form-label">Poids bobine (g)</label>
              <input type="number" min="0" step="1" class="form-control" id="spool_weight_g" value="200">
            </div>
          </div>
		 <div class="col-md-4">
    <label class="form-label">Prix (‚Ç¨)</label>
    <input type="number" min="0" step="0.01" inputmode="decimal" class="form-control" id="price" placeholder="ex: 24.90">
  </div>
          <div class="mt-3">
            <label class="form-label">Profil (profile_id)</label>
            <input type="text" class="form-control" id="profile_id" placeholder="ex: 12">
          </div>

          <div class="mt-3">
            <label class="form-label">Commentaire</label>
            <textarea class="form-control" id="comment" rows="3"></textarea>
          </div>

          <div class="alert alert-danger mt-3 d-none" id="filamentError"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button class="btn btn-primary" id="filamentSaveBtn" onclick="saveFilament()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="importFilamentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Importer un filament depuis le catalogue</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- MARQUE -->
        <div class="mb-3">
          <label class="form-label">Marque</label>
          <select class="form-select" id="select-manufacturer" size="8"></select>
        </div>

        <!-- MAT√âRIAU -->
        <div class="mb-3">
          <label class="form-label">Mat√©riau</label>
          <select class="form-select" id="select-material" size="8" disabled></select>
        </div>

        <!-- NOM COMMERCIAL -->
        <div class="mb-3">
          <label class="form-label">Nom</label>
          <select class="form-select" id="select-name" size="10" disabled></select>
        </div>

        <div class="alert alert-info small" id="import-preview" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-primary" id="btn-import-apply" disabled>Utiliser ce filament</button>
      </div>
    </div>
  </div>
</div>
{% include 'fragments/modals_spool.html' %}
{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
(function(){
  let filamentModal, manufacturerTS, materialTS;

  function initModal(){
    const el = document.getElementById('filamentModal');
    if (!el) return;
    filamentModal = filamentModal || new bootstrap.Modal(el);

    // Options pour selects => construits depuis les sets backend
    const manufacturers = [{% for m in (all_manufacturers or [])|sort %}{value: "{{ m|e }}", text: "{{ m|e }}"},{% endfor %}];
    const materials = [{% for m in (all_materials or [])|sort %}{value: "{{ m|e }}", text: "{{ m|e }}"},{% endfor %}];

    function ensureTomSelect(id, options){
      if (window.TomSelect){
        return new TomSelect('#'+id, {
          create: true,
          persist: false,
          maxItems: 1,
          searchField: ['text', 'value'],
          sortField: {field: 'text', direction: 'asc'},
          options
        });
      } else {
        const sel = document.getElementById(id);
        sel.innerHTML = '';
        options.forEach(o=>{
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.text;
          sel.appendChild(opt);
        });
        return null; // fallback simple
      }
    }

manufacturerTS = ensureTomSelect('manufacturer', manufacturers);
materialTS = ensureTomSelect('material', materials);
window.manufacturerTS = manufacturerTS;
window.materialTS = materialTS;

    // Liens mono/multi
    document.getElementById('multicolor_type').addEventListener('change', onTypeChange);
    document.getElementById('mono_color').addEventListener('input', syncMonoHex);
    document.getElementById('mono_color_hex').addEventListener('input', syncMonoPicker);
  }

  function onTypeChange(){
    const t = document.getElementById('multicolor_type').value;
    const mono = document.getElementById('monoColorBlock');
    const multi = document.getElementById('multiColorBlock');
    if (t === 'monochrome'){
      mono.style.display = '';
      multi.style.display = 'none';
    } else {
      mono.style.display = 'none';
      multi.style.display = '';
      if (document.querySelectorAll('#multiColors .multi-color-item').length === 0){
        addMultiColor('#ffffff');
      }
    }
  }
  window.onFilamentTypeChange = onTypeChange;

  function syncMonoHex(){
    const v = document.getElementById('mono_color').value;
    document.getElementById('mono_color_hex').value = v;
  }
  function syncMonoPicker(){
    let v = document.getElementById('mono_color_hex').value.trim();
    if (v && v[0] !== '#') v = '#'+v;
    document.getElementById('mono_color').value = v;
  }

  window.addMultiColor = function(initial){
    const wrap = document.getElementById('multiColors');
    const div = document.createElement('div');
    div.className = 'multi-color-item d-flex align-items-center gap-2 mb-2';
    div.innerHTML = `
      <input type="color" class="form-control form-control-color flex-shrink-0" value="${initial || '#ffffff'}">
      <input type="text" class="form-control" placeholder="#RRGGBB" value="${initial || '#ffffff'}">
      <button type="button" class="btn btn-outline-danger btn-sm">Supprimer</button>
    `;
    const [picker, hexInput, removeBtn] = div.querySelectorAll('input,button');
    picker.addEventListener('input', () => hexInput.value = picker.value);
    hexInput.addEventListener('input', () => {
      let v = hexInput.value.trim();
      if (v && v[0] !== '#') v = '#'+v;
      picker.value = v;
    });
    removeBtn.addEventListener('click', () => div.remove());
    wrap.appendChild(div);
  }

  function getSelectValue(ts, id){
    if (ts && ts.getValue) return ts.getValue();
    const el = document.getElementById(id);
    return el.value;
  }

  function collectColors(){
    const type = document.getElementById('multicolor_type').value;
    if (type === 'monochrome'){
      let v = document.getElementById('mono_color_hex').value.trim();
      if (v && v[0] !== '#') v = '#'+v;
      return [v];
    } else {
      const items = document.querySelectorAll('#multiColors .multi-color-item input[type="text"]');
      const arr = [];
      items.forEach(i=>{
        let v = i.value.trim();
        if (v && v[0] !== '#') v = '#'+v;
        if (v) arr.push(v);
      });
      return arr;
    }
  }

  function showError(msg){
    const a = document.getElementById('filamentError');
    a.textContent = msg;
    a.classList.remove('d-none');
  }
  function clearError(){
    const a = document.getElementById('filamentError');
    a.textContent = '';
    a.classList.add('d-none');
  }

  window.openFilamentModal = function(filament){
    initModal();
    clearError();

    document.getElementById('filamentForm').reset();
    document.getElementById('filament_id').value = filament?.id || '';
    document.getElementById('filamentModalLabel').textContent = filament ? 'Modifier le filament' : 'Ajouter un filament';
	// ‚ûú AJOUTE CES 3 LIGNES ICI
const importBtn = document.getElementById('btn-open-import-modal');
if (importBtn) {
  const isEdit = !!(filament && filament.id);
  importBtn.classList.toggle('d-none', isEdit);
}
	document.getElementById('price').value = (filament?.price ?? '');

    // name
    document.getElementById('name').value = filament?.name || '';

    // manufacturer / material
    if (manufacturerTS){
      manufacturerTS.clear(); materialTS.clear();
      if (filament?.manufacturer) manufacturerTS.addItem(filament.manufacturer, true);
      if (filament?.material) materialTS.addItem(filament.material, true);
    } else {
      document.getElementById('manufacturer').value = filament?.manufacturer || '';
      document.getElementById('material').value = filament?.material || '';
    }

    // multicolor type & couleurs
    const t = (filament?.multicolor_type || 'monochrome').toLowerCase();
    document.getElementById('multicolor_type').value = ['monochrome','coaxial','gradient'].includes(t) ? t : 'monochrome';
    onTypeChange();

    if (t === 'monochrome'){
      const hex = (() => {
        if (!filament?.color) return '#ffffff';
        return filament.color[0] === '#' ? filament.color : ('#'+filament.color);
      })();
      document.getElementById('mono_color').value = hex;
      document.getElementById('mono_color_hex').value = hex;
    } else {
      const arr = (filament?.colors_array || '').split(',').filter(Boolean);
      const wrap = document.getElementById('multiColors');
      wrap.innerHTML = '';
      if (arr.length){
        arr.forEach(c=>{
          const h = (c && c[0] !== '#') ? ('#'+c) : (c || '#ffffff');
          addMultiColor(h);
        });
      } else {
        addMultiColor('#ffffff');
      }
    }

    // poids
    document.getElementById('filament_weight_g').value = filament?.filament_weight_g ?? 1000;
    document.getElementById('spool_weight_g').value = filament?.spool_weight_g ?? 200;

    // profile & comment
    document.getElementById('profile_id').value = filament?.profile_id ?? '';
    document.getElementById('comment').value = filament?.comment ?? '';

    filamentModal.show();
  }

  window.saveFilament = async function(){
    clearError();
    const id = document.getElementById('filament_id').value || null;

    const payload = {
      name: document.getElementById('name').value.trim(),
      manufacturer: getSelectValue(manufacturerTS, 'manufacturer')?.toString().trim(),
      material: getSelectValue(materialTS, 'material')?.toString().trim(),
      multicolor_type: document.getElementById('multicolor_type').value,
      colors: collectColors(),
      filament_weight_g: document.getElementById('filament_weight_g').value,
      spool_weight_g: document.getElementById('spool_weight_g').value,
      profile_id: document.getElementById('profile_id').value || null,
	  price: document.getElementById('price').value,
      comment: document.getElementById('comment').value || null,
    };

    if (!payload.name) return showError("Le nom est requis.");
    if (!payload.manufacturer) return showError("Le fabricant est requis.");
    if (!payload.material) return showError("Le mat√©riau est requis.");
    if (!payload.colors || payload.colors.length === 0) return showError("Au moins une couleur est requise.");
	const priceVal = document.getElementById('price').value.trim();
if (priceVal && isNaN(Number(priceVal.replace(',', '.')))) {
  return showError("Le prix doit √™tre un nombre (ex: 24.90).");
}

    try {
      const resp = await fetch(id ? `/api/filaments/${id}` : '/api/filaments', {
        method: id ? 'PUT' : 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (!resp.ok || !data.ok){
        if (data?.error === 'duplicate'){
          return showError(data.message || "Doublon d√©tect√© : m√™me fabricant, mat√©riau et combinaison de couleurs.");
        }
        return showError(data?.message || "Erreur lors de l'enregistrement.");
      }
      window.location.reload();
    } catch (e){
      showError("Erreur r√©seau : " + (e?.message || e));
    }
  }

  document.addEventListener('DOMContentLoaded', initModal);
})();

(function(){
  // ---------- √âl√©ments Import ----------
  const btnOpenImport = document.getElementById('btn-open-import-modal');
  const importModalEl = document.getElementById('importFilamentModal');
  const importModal = importModalEl ? bootstrap.Modal.getOrCreateInstance(importModalEl) : null;

  const selManuEl = document.getElementById('select-manufacturer');
const selMatEl  = document.getElementById('select-material');
const selNameEl = document.getElementById('select-name');
  const btnApply  = document.getElementById('btn-import-apply');
  const previewEl = document.getElementById('import-preview');

  let importManuTS = null, importMatTS = null, importNameTS = null;
  let CATALOG = [];  // liste brute du /catalog/filaments/import
  let idx = { manu: new Map(), // manu -> Set(materials)
              key: new Map()   // `${manu}|||${mat}|||${name}` -> filament
            };

  function normalizeHex(h){
    if(!h) return null;
    let s = String(h).trim().replace(/^#/, '');
    if (s.length === 3) s = s.split('').map(c => c + c).join('');
    if (s.length !== 6) return null;
    return '#' + s.toUpperCase();
  }

  async function loadCatalog(){
    if (CATALOG.length) return;
    const res = await fetch('/catalog/filaments/import');
    const data = await res.json();
    CATALOG = Array.isArray(data.filaments) ? data.filaments : [];

    idx.manu.clear(); idx.key.clear();
    for (const f of CATALOG){
      const manu = f.manufacturer || '';
      const mat  = f.material || '';
      const name = f.name || '';
      if(!idx.manu.has(manu)) idx.manu.set(manu, new Set());
      if (mat) idx.manu.get(manu).add(mat);
      idx.key.set(`${manu}|||${mat}|||${name}`, f);
    }
  }

  function ensureTomSelect(el, options){
    if (window.TomSelect){
      // d√©truire TS existant s'il existe (pour recharger options)
      if (el.tomselect) el.tomselect.destroy();
      return new TomSelect(el, {
        create: false,
        persist: false,
        maxItems: 1,
        searchField: ['text', 'value'],
        sortField: {field: 'text', direction: 'asc'},
        options,
		render: {
    option: function(data, escape) {
      return `<div>${escape(data.text)}</div>`;
    }
  }
      });
    } else {
      // Fallback natif : on remplit juste les <option>
      el.innerHTML = '';
      for (const o of options) {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        el.appendChild(opt);
      }
      return null;
    }
  }

  function toOptions(values){
    return Array.from(new Set(values)).sort((a,b)=>(a||'').localeCompare(b||'')).map(v => ({value: v, text: v || '‚Äî'}));
  }

  async function openImportModal(){
    await loadCatalog();

    // manufacturer
    importManuTS = ensureTomSelect(selManuEl, toOptions(CATALOG.map(f=>f.manufacturer||'')));
    if (importManuTS) importManuTS.clear(); else selManuEl.value = '';

    // material (d√©pend du manu)
    selMatEl.disabled = true;
    importMatTS = ensureTomSelect(selMatEl, []);
    if (importMatTS) importMatTS.clear(); else selMatEl.value = '';

    // name (d√©pend du couple manu/material)
    selNameEl.disabled = true;
    importNameTS = ensureTomSelect(selNameEl, []);
    if (importNameTS) importNameTS.clear(); else selNameEl.value = '';

    btnApply.disabled = true;
    previewEl.classList.add('d-none'); previewEl.textContent = '';

    importModal.show();
  }

  function onManufacturerChanged(){
    const manu = importManuTS ? importManuTS.getValue() : selManuEl.value;
    const materials = idx.manu.has(manu) ? Array.from(idx.manu.get(manu)) : [];
    selMatEl.disabled = (materials.length === 0);
    importMatTS = ensureTomSelect(selMatEl, toOptions(materials));
    if (importMatTS) importMatTS.clear(); else selMatEl.value = '';
    // reset names
    selNameEl.disabled = true;
    importNameTS = ensureTomSelect(selNameEl, []);
    if (importNameTS) importNameTS.clear(); else selNameEl.value = '';
    btnApply.disabled = true;
    previewEl.classList.add('d-none');
  }

  function onMaterialChanged(){
    const manu = importManuTS ? importManuTS.getValue() : selManuEl.value;
    const mat  = importMatTS  ? importMatTS.getValue()  : selMatEl.value;
    const names = CATALOG.filter(f => (f.manufacturer||'')===manu && (f.material||'')===mat).map(f => f.name || '');
    selNameEl.disabled = (names.length === 0);
    importNameTS = ensureTomSelect(selNameEl, toOptions(names));
    if (importNameTS) importNameTS.clear(); else selNameEl.value = '';
    btnApply.disabled = true;
    previewEl.classList.add('d-none');
  }

  function onNameChanged(){
    const manu = importManuTS ? importManuTS.getValue() : selManuEl.value;
    const mat  = importMatTS  ? importMatTS.getValue()  : selMatEl.value;
    const name = importNameTS ? importNameTS.getValue() : selNameEl.value;
    const f = idx.key.get(`${manu}|||${mat}|||${name}`);
    if (f){
      previewEl.classList.remove('d-none');
      previewEl.innerHTML = `
        <div><strong>${f.manufacturer}</strong> ‚Ä¢ ${f.material} ‚Ä¢ <em>${f.name}</em></div>
        <div class="small text-muted">√ò ${f.diameter ?? '‚Äî'} ‚Ä¢ poids ${f.weight ?? '‚Äî'}g ‚Ä¢ tare ${f.spool_weight ?? '‚Äî'}g</div>
      `;
      btnApply.disabled = false;
    } else {
      previewEl.classList.add('d-none'); previewEl.textContent = '';
      btnApply.disabled = true;
    }
  }

  // -------- Pr√©-remplissage de TA modale existante --------
  function applyToMainModal(){
    const manu = importManuTS ? importManuTS.getValue() : selManuEl.value;
    const mat  = importMatTS  ? importMatTS.getValue()  : selMatEl.value;
    const name = importNameTS ? importNameTS.getValue() : selNameEl.value;
    const f = idx.key.get(`${manu}|||${mat}|||${name}`);
    if (!f) return;

    // Titre/√©tat de la modale principale est d√©j√† g√©r√©e par openFilamentModal().
    // On remplit les champs existants identifi√©s dans ton code.
    document.getElementById('name').value = f.name || '';

   
    if (manufacturerTS) {
  manufacturerTS.clear();
  if (f.manufacturer) manufacturerTS.addItem(f.manufacturer, true);
}
if (materialTS) {
  materialTS.clear();
  if (f.material) materialTS.addItem(f.material, true);
}
    document.getElementById('comment').value     = 'Import√© depuis catalogue';


    // multicolor + couleurs (respecte tes valeurs 'monochrome' | 'coaxial' | 'gradient')
    const t = Array.isArray(f.color_hexes) && f.color_hexes.length ? (f.multi_color_direction || 'coaxial') : 'monochrome';
    document.getElementById('multicolor_type').value = ['monochrome','coaxial','gradient'].includes(String(t).toLowerCase()) ? String(t).toLowerCase() : 'monochrome';
    // d√©clenche l'affichage mono/multi via ta fonction existante
    if (typeof window.onFilamentTypeChange === 'function') window.onFilamentTypeChange();

    if (document.getElementById('multicolor_type').value === 'monochrome'){
      const hex = normalizeHex(f.color_hex || '') || '#ffffff';
      document.getElementById('mono_color').value = hex;
      document.getElementById('mono_color_hex').value = hex;
    } else {
      const wrap = document.getElementById('multiColors');
      wrap.innerHTML = '';
      const arr = (Array.isArray(f.color_hexes) ? f.color_hexes : []).map(h => normalizeHex(h) || '#ffffff');
      if (arr.length){
        arr.forEach(h => addMultiColor(h));
      } else {
        addMultiColor('#ffffff');
      }
    }

    // poids / tare / diam√®tre
    document.getElementById('filament_weight_g').value = f.weight ?? 1000;
    document.getElementById('spool_weight_g').value   = f.spool_weight ?? 200;
    document.getElementById('price').value   = f.price ?? 20;

    // optionnel: profile_id/comment si tu veux tracer l‚Äôorigine
    // document.getElementById('profile_id').value = document.getElementById('profile_id').value || '';
    // document.getElementById('comment').value = (document.getElementById('comment').value || '') + `\nImport catalogue: ${f.id}`;

    importModal.hide();
  }

  // ---------- Bindings ----------
  if (btnOpenImport && importModal){
    btnOpenImport.addEventListener('click', openImportModal);
  }
  selManuEl.addEventListener('change', onManufacturerChanged);
  selMatEl.addEventListener('change', onMaterialChanged);
  selNameEl.addEventListener('change', onNameChanged);
  btnApply.addEventListener('click', applyToMainModal);
})();
});
</script>
{% endblock %}

<div style="height:4rem;"></div>
{% endblock %}
