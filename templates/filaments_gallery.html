{% extends 'base.html' %}

{% block content %}
<style>
.gallery-grid {
  display: grid;
  /* 6 â†’ 5 â†’ 4 â†’ 3 â†’ 2 â†’ 2  (jamais 1) */
  grid-template-columns: repeat(6, minmax(0, 1fr));
  gap: 12px;
}
@media (max-width: 1400px) { .gallery-grid { grid-template-columns: repeat(5, 1fr); } }
@media (max-width: 1200px) { .gallery-grid { grid-template-columns: repeat(4, 1fr); } }
@media (max-width: 992px)  { .gallery-grid { grid-template-columns: repeat(3, 1fr); } }
@media (max-width: 768px)  { .gallery-grid { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 480px)  { .gallery-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } } 

.tile {
  position: relative;
  border-radius: .75rem;
  overflow: hidden;
  background: #0f172a;
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  cursor: pointer;
}
.tile .thumb {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  background: #111827;
  display: block;
}
.tile .meta {
  padding: .5rem .6rem;
  font-size: .85rem;
}
.meta .line1 {
  display: flex; align-items:center; gap:.35rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.meta .line2 {
  color: #9ca3af; font-size: .78rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.badge-s {
  font-size: .70rem; padding: .1rem .35rem;
  background: rgba(255,255,255,.08); border-radius: .5rem;
}
.chk-compare {
  position: absolute;
  top: 6px;
  right: 6px;
  padding: 2px;
  border-radius: 4px;
  background: transparent; /* plus aucun carrÃ© */
}
.compare-tray {
  position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
  background: rgba(15, 23, 42, .95);
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  border-radius: 1rem; padding: .5rem .75rem;
  display: none; gap: .5rem; align-items: center; z-index: 1050;
}
.compare-tray.show { display: flex; }
.compare-pill {
  display: inline-flex; align-items:center; gap:.35rem;
  background: rgba(255,255,255,.08); border-radius: .75rem;
  padding: .2rem .5rem; font-size: .8rem;
}
.compare-pill img {
  width: 22px; height: 22px; border-radius: .25rem; object-fit: cover;
}
.compare-btn { margin-left: .5rem; }
.compare-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:12px;
}
@media (max-width:1400px){ .compare-grid{ grid-template-columns: repeat(3,1fr);} }
@media (max-width:992px){  .compare-grid{ grid-template-columns: repeat(2,1fr);} }
@media (max-width:576px){  .compare-grid{ grid-template-columns: 1fr;} }

.compare-card{
  background:#0f172a;
  border:1px solid rgba(255,255,255,.1);
  border-radius:.75rem;
  overflow:hidden;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
}
.compare-card .thumb{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  display:block;
  background:#111827;
}
.compare-card .meta{
  padding:.5rem .6rem;
  font-size:.85rem;
}
.compare-card .line1{
  display:flex; align-items:center; gap:.35rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.compare-card .line2{
  color:#9ca3af; font-size:.78rem;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.compare-card .badge-s{
  font-size:.70rem; padding:.1rem .35rem;
  background:rgba(255,255,255,.08); border-radius:.5rem;
}
.compare-grid{
  display:grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap:12px;
}
@media (max-width: 1400px){ .compare-grid{ grid-template-columns: repeat(3, 1fr);} }
@media (max-width: 992px){  .compare-grid{ grid-template-columns: repeat(2, 1fr);} }
@media (max-width: 576px){  .compare-grid{ grid-template-columns: repeat(2, minmax(0,1fr));} } 
.compare-card{
  background:#0f172a;
  border:1px solid rgba(255,255,255,.1);
  border-radius:.65rem;
  overflow:hidden;
  box-shadow:0 4px 12px rgba(0,0,0,.25);
}
.compare-card .thumb{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  display:block;
  background:#111827;
}
.compare-card .meta{
  padding:.4rem .5rem;
  font-size:.8rem;
}
.compare-card .line1{ display:flex; align-items:center; gap:.35rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.compare-card .line2{ color:#9ca3af; font-size:.72rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.compare-card .badge-s{ font-size:.66rem; padding:.08rem .3rem; background:rgba(255,255,255,.08); border-radius:.45rem; }
.chk-compare input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #0d6efd; /* la couleur bootstrap primary */
}
.tile.no-active {
  opacity: 0.9;
  filter: grayscale(20%);
}
</style>
<div class="d-flex gap-2 align-items-center mb-2">
  <input id="galSearch" class="form-control form-control-sm" type="search"
         placeholder="Recherche (nom, matÃ©riau, marque, couleurâ€¦)" style="max-width: 360px;">
  <select id="galSort" class="form-select form-select-sm" style="max-width: 220px;">
    <option value="manufacturer">Trier par Marque</option>
    <option value="material">Trier par MatÃ©riau</option>
    <option value="name">Trier par Nom</option>
    <option value="color">Trier par Couleur</option>
  </select>
</div>
<div class="d-flex justify-content-between align-items-center mb-2">
  <div class="text-muted small">Clique une tuile pour ouvrir en grand. Coche pour comparer.</div>
</div>

<div class="gallery-grid">
  {% for f in filaments %}
    {# URL du swatch â€” par dÃ©faut .webp ; si tu as des .jpg/.png possibles, on peut tester cÃ´tÃ© JS #}
    {% set swatch_url = '/static/uploads/filaments/' ~ f.id ~ '.webp' %}
    <div class="tile  {% if (f.active_spools_count or 0) == 0 %}no-active{% endif %}"
     data-id="{{ f.id }}"
     data-name="{{ f.name or '' }}"
     data-translated_name="{{ f.translated_name or '' }}"
     data-manufacturer="{{ f.manufacturer or '' }}"
     data-material="{{ f.material or '' }}"
     data-colors="{{ f.color_families_str or '' }}"
     data-color-key="{{ f.color_key or '' }}"
     data-price="{{ f.price if f.price is not none else '' }}"
     data-weight="{{ f.filament_weight_g or '' }}"
     data-spoolw="{{ f.spool_weight_g or '' }}"
     data-profile="{{ f.profile_id or '' }}"
     data-transparent="{{ 1 if f.transparent == 1 else 0 }}"
     data-active="{{ f.active_spools_count or 0 }}"
     data-total="{{ f.spools_count or 0 }}"
     data-comment="{{ (f.comment or '')|e }}"
     data-swatch="{{ 1 if f.swatch == 1 else 0 }}"
     data-swatch-url="{{ f.swatch_url }}"
     onclick="if(event.target.type!=='checkbox'){ openFilamentLightbox(this); }">

      <img class="thumb"
           src="{{ swatch_url }}"
           alt="Swatch {{ f.name or '' }}"
           onerror="this.src='{{ asset_url('img/placeholder_swatch.png') }}'">

      <div class="chk-compare">
  <input class="js-compare" type="checkbox" onchange="onCompareToggle(this, {{ f.id }})">
</div>

      <div class="meta">
        <div class="line1">
          <span class="badge-s">{{ f.material or 'â€”' }}</span>
          <strong class="text-truncate">{{ f.name or 'â€”' }}</strong>
        </div>
        <div class="line2">
          {{ f.manufacturer or 'â€”' }}
		    {% if (f.active_spools_count or 0) == 0 %}
      <span class="badge-s text-warning ms-1" title="Aucune bobine active">ðŸ’¤</span>
    {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<!-- Panneau flottant de comparaison -->
<div id="compareTray" class="compare-tray">
  <div id="compareList" class="d-inline-flex flex-wrap gap-1"></div>
  <button class="btn btn-sm btn-primary compare-btn" onclick="openCompareModal()">Comparer</button>
  <button class="btn btn-sm btn-outline-secondary ms-1" onclick="clearCompare()">Vider</button>
</div>

<!-- Modal comparaison -->
<div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h5 class="modal-title">Comparer les filaments</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div id="compareTableWrap" class="table-responsive"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="filamentLightbox" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:rgba(15,23,42,.98); border:1px solid rgba(255,255,255,.1);">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="flbTitle">Swatch</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-0">
        <img id="flbImg" class="img-fluid w-100 d-block" src="" alt="Swatch" style="max-height:85vh; object-fit:contain;">
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="compareLightbox" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:rgba(15,23,42,.98); border:1px solid rgba(255,255,255,.1);">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="clbTitle">Swatch</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body p-0 position-relative">
        <img id="clbImg" class="img-fluid w-100 d-block" src="" alt="Swatch" style="max-height:80vh; object-fit:contain;">
        <!-- ContrÃ´les -->
        <button type="button" class="btn btn-dark position-absolute top-50 start-0 translate-middle-y opacity-75"
                style="border-radius:999px" onclick="prevCompare()" aria-label="PrÃ©cÃ©dent">
          â€¹
        </button>
        <button type="button" class="btn btn-dark position-absolute top-50 end-0 translate-middle-y opacity-75"
                style="border-radius:999px" onclick="nextCompare()" aria-label="Suivant">
          â€º
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ---------- Lightbox : rÃ©utilise openGalleryFromEntry de base.html ----------
function openFilamentLightbox(tile){
  const url   = tile.getAttribute('data-swatch-url');
  const name  = tile.getAttribute('data-name') || '';
  const manu  = tile.getAttribute('data-manufacturer') || '';
  const mat   = tile.getAttribute('data-material') || '';

  if (!url) return;

  // Titre: "Type â€“ Nom â€“ Marque"
  const title = `${mat || 'â€”'} \u2013 ${name || 'â€”'} \u2013 ${manu || 'â€”'}`;

  const imgEl   = document.getElementById('flbImg');
  const titleEl = document.getElementById('flbTitle');

  if (imgEl)   imgEl.src = url;
  if (titleEl) titleEl.textContent = title;

  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('filamentLightbox'));
  modal.show();
}

// ---------- SÃ©lection & comparaison ----------
const MAX_COMPARE = 6;
const compareSet  = new Map(); // id -> data

function onCompareToggle(checkbox, id){
  const tile = checkbox.closest('.tile');
  if (!tile) return;

  if (checkbox.checked){
    if (compareSet.size >= MAX_COMPARE){
      checkbox.checked = false;
      Swal.fire("Comparaison", `Tu peux sÃ©lectionner au max ${MAX_COMPARE} filaments.`, "info");
      return;
    }
    compareSet.set(String(id), collectTileData(tile));
  } else {
    compareSet.delete(String(id));
  }
  renderCompareTray();
}

function collectTileData(tile){
  const data = {
    id: tile.dataset.id,
    name: tile.dataset.name,
    translated_name: tile.dataset.translated_name,
    manufacturer: tile.dataset.manufacturer,
    material: tile.dataset.material,
    price: tile.dataset.price,
    weight: tile.dataset.weight,
    spoolw: tile.dataset.spoolw,
    profile: tile.dataset.profile,
    transparent: tile.dataset.transparent === '1',
    active: tile.dataset.active,
    total: tile.dataset.total,
    comment: tile.dataset.comment || '',
    swatch: tile.dataset.swatch === '1',
    swatch_url: tile.dataset.swatchUrl || tile.dataset.swatch_url || ''
  };
  return data;
}

function renderCompareTray(){
  const tray = document.getElementById('compareTray');
  const list = document.getElementById('compareList');
  if (!tray || !list) return;

  list.innerHTML = '';
  compareSet.forEach((d,id)=>{
    const pill = document.createElement('span');
    pill.className = 'compare-pill';
    pill.innerHTML = `
      <img src="${d.swatch_url}" onerror="this.style.display='none'">
      <span class="text-truncate" style="max-width:160px">${d.material||'â€”'} Â· ${d.name||'â€”'}</span>
      <button type="button" class="btn btn-sm btn-link text-danger p-0 ms-1" onclick="removeFromCompare('${id}')">
        <i class="bi bi-x-lg"></i>
      </button>
    `;
    list.appendChild(pill);
  });

  tray.classList.toggle('show', compareSet.size > 0);
}

function removeFromCompare(id){
  compareSet.delete(String(id));
  // dÃ©cocher la case si visible
  const tile = document.querySelector(`.tile[data-id="${CSS.escape(id)}"]`);
  if (tile){
    const chk = tile.querySelector('.js-compare');
    if (chk) chk.checked = false;
  }
  renderCompareTray();
}

function clearCompare(){
  compareSet.clear();
  document.querySelectorAll('.js-compare:checked').forEach(chk=> chk.checked = false);
  renderCompareTray();
}

let compareItems = [];   // ordre figÃ© au moment de lâ€™ouverture
let compareIndex = 0;    // index courant dans la lightbox

function openCompareModal(){
  if (compareSet.size < 2){
    Swal.fire("Comparaison", "SÃ©lectionne au moins 2 filaments.", "info");
    return;
  }
  // fige l'ordre au moment de lâ€™ouverture
  compareItems = Array.from(compareSet.values());

  const wrap = document.getElementById('compareTableWrap');
  if (!wrap) return;

  // grille de cartes ; clic => lightbox avec index
  let html = `<div class="compare-grid">`;
  html += compareItems.map((d, i) => {
    const title = `${(d.material||'â€”')} â€“ ${(d.name||'â€”')} â€“ ${(d.manufacturer||'â€”')}`;
    return `
      <div class="compare-card" role="button" onclick="openCompareLightbox(${i})">
        <img class="thumb" src="${d.swatch_url}" alt="${title}" onerror="this.style.display='none'">
        <div class="meta">
          <div class="line1">
            <span class="badge-s">${d.material || 'â€”'}</span>
            <strong class="text-truncate">${d.name || 'â€”'}</strong>
          </div>
          <div class="line2">${d.manufacturer || 'â€”'}</div>
        </div>
      </div>
    `;
  }).join('');
  html += `</div>`;

  wrap.innerHTML = html;

  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('compareModal'));
  modal.show();
}

/* -------- Lightbox de comparaison avec navigation -------- */
function openCompareLightbox(i){
  compareIndex = i;
  showCompareLightbox();
  const m = bootstrap.Modal.getOrCreateInstance(document.getElementById('compareLightbox'));
  m.show();
}

function showCompareLightbox(){
  const d = compareItems[compareIndex];
  if (!d) return;
  const title = `${(d.material||'â€”')} â€“ ${(d.name||'â€”')} â€“ ${(d.manufacturer||'â€”')}`;
  const imgEl = document.getElementById('clbImg');
  const ttlEl = document.getElementById('clbTitle');
  if (imgEl) imgEl.src = d.swatch_url || '';
  if (ttlEl) ttlEl.textContent = title;
}

function prevCompare(){
  if (!compareItems.length) return;
  compareIndex = (compareIndex - 1 + compareItems.length) % compareItems.length;
  showCompareLightbox();
}
function nextCompare(){
  if (!compareItems.length) return;
  compareIndex = (compareIndex + 1) % compareItems.length;
  showCompareLightbox();
}

// Navigation clavier (flÃ¨ches) quand la lightbox compare est ouverte
document.addEventListener('keydown', (e) => {
  const modalEl = document.getElementById('compareLightbox');
  const isShown = modalEl && modalEl.classList.contains('show');
  if (!isShown) return;
  if (e.key === 'ArrowLeft')  { e.preventDefault(); prevCompare(); }
  if (e.key === 'ArrowRight') { e.preventDefault(); nextCompare(); }
});

function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

(function(){
  const $q   = document.getElementById('galSearch');
  const $ord = document.getElementById('galSort');
  const $grid = document.querySelector('.gallery-grid');

  if (!$grid) return;

  let tiles = Array.from($grid.querySelectorAll('.tile'));

  const COLOR_ORDER = [
    "Noir","Blanc","Gris","Rouge","Rose","Orange","Jaune","Beige","Vert","Turquoise","Bleu","Violet","Marron",""
  ];
  const COLOR_RANK = Object.fromEntries(COLOR_ORDER.map((n,i)=>[n.toLowerCase(), i]));

  function normalize(s){ return (s||'').toString().toLowerCase(); }

  function matches(tile, tokens){
    if (!tokens.length) return true;
    const hay = [
      tile.dataset.name,
      tile.dataset.translated_name,
      tile.dataset.manufacturer,
      tile.dataset.material,
      tile.dataset.colors,   // ex: "vert-rouge"
    ].map(normalize).join(' ');
    return tokens.every(t => hay.includes(t));
  }

  function cmpLocale(a, b){
    return a.localeCompare(b, undefined, {sensitivity:'base'});
  }

  function sortTiles(mode){
    const by = (a,b) => 0;
    switch (mode){
      case 'manufacturer':
        tiles.sort((a,b)=>{
          const am = normalize(a.dataset.manufacturer), bm = normalize(b.dataset.manufacturer);
          if (am !== bm) return cmpLocale(am,bm);
          const an = normalize(a.dataset.name), bn = normalize(b.dataset.name);
          return cmpLocale(an,bn);
        });
        break;

      case 'material':
        tiles.sort((a,b)=>{
          const am = normalize(a.dataset.material), bm = normalize(b.dataset.material);
          if (am !== bm) return cmpLocale(am,bm);
          const an = normalize(a.dataset.name), bn = normalize(b.dataset.name);
          return cmpLocale(an,bn);
        });
        break;

      case 'name':
        tiles.sort((a,b)=>{
          const an = normalize(a.dataset.name), bn = normalize(b.dataset.name);
          if (an !== bn) return cmpLocale(an,bn);
          return cmpLocale(normalize(a.dataset.manufacturer), normalize(b.dataset.manufacturer));
        });
        break;

      case 'color':
        tiles.sort((a,b)=>{
          const ak = normalize(a.dataset.colorKey), bk = normalize(b.dataset.colorKey);
          const ra = COLOR_RANK.hasOwnProperty(ak) ? COLOR_RANK[ak] : COLOR_RANK[""];
          const rb = COLOR_RANK.hasOwnProperty(bk) ? COLOR_RANK[bk] : COLOR_RANK[""];
          if (ra !== rb) return ra - rb;
          // fallback: nom
          return cmpLocale(normalize(a.dataset.name), normalize(b.dataset.name));
        });
        break;

      default:
        // dÃ©faut = manufacturer
        return sortTiles('manufacturer');
    }

    // rÃ©injecte lâ€™ordre dans le DOM
    const frag = document.createDocumentFragment();
    tiles.forEach(t => frag.appendChild(t));
    $grid.appendChild(frag);
  }

  function apply(){
    const tokens = normalize($q.value).split(/\s+/).filter(Boolean);
    tiles.forEach(t => {
      t.style.display = matches(t, tokens) ? '' : 'none';
    });
    sortTiles($ord.value);
  }

  // init
  sortTiles($ord.value || 'manufacturer');

  // events (avec petit debounce cÃ´tÃ© input)
  let tId = null;
  $q && $q.addEventListener('input', () => {
    clearTimeout(tId); tId = setTimeout(apply, 120);
  });
  $ord && $ord.addEventListener('change', apply);
})();
</script>
{% endblock %}
