{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <div class="overview-grid" id="tiles">
    <!-- Tuile locale -->
    <div class="overview-tile card shadow-sm" data-overview="{{ local_overview_url }}">
      <div class="overview-header card-header p-2 d-flex align-items-center justify-content-between">
        <span class="overview-title text-truncate">üè† Installation locale</span>
        <span class="badge bg-primary">LOCAL</span>
      </div>
      <div class="overview-body card-body p-2 text-center">
        <img src="" alt="Snapshot local" class="overview-img rounded">
        <div class="overview-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tuiles distantes -->
    {% for inst in remote_installations %}
    <div class="overview-tile card shadow-sm" data-overview="{{ inst.overview_url }}">
      <div class="overview-header card-header p-2 d-flex align-items-center justify-content-between">
        <span class="overview-title text-truncate">üåê {{ inst.name }}</span>
        <span class="badge bg-secondary">DISTANT</span>
      </div>
      <div class="overview-body card-body p-2 text-center">
        <img src="" alt="Snapshot {{ inst.name }}" class="overview-img rounded">
        <div class="overview-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  .overview-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr); /* 3 colonnes par d√©faut */
    gap: 16px;
  }
  @media (max-width: 1200px) {
    .overview-grid { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 768px) {
    .overview-grid { grid-template-columns: 1fr; }
  }

  .overview-tile {
    border-radius: 12px;
    background: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,.08);
    overflow: hidden;
  }

  .overview-title {
    font-weight: 600;
    font-size: .95rem;
    max-width: 70%;
  }

  .overview-img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    display: block;
    background: #f5f5f5;
    border-bottom: 1px solid #eee;
  }

  .overview-info {
    font-size: .9rem;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="220" height="120">
      <rect width="100%" height="100%" fill="#f0f0f0"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="sans-serif" font-size="13" fill="#999">
        Snapshot indisponible
      </text>
    </svg>`);

  function pct(v){
    if(v==null || isNaN(v)) return 0;
    const n = Number(v);
    if(n<=1 && n>=0) return Math.round(n*100);  // accepte 0..1
    return Math.max(0, Math.min(100, Math.round(n)));
  }
  function absUrl(u, base){ try{ return new URL(u, base).toString(); }catch{ return u; } }

  function refreshTiles(){
    document.querySelectorAll('.overview-tile').forEach(tile=>{
      const overviewUrl = tile.dataset.overview;
      const img = tile.querySelector('.overview-img');
      const pbar = tile.querySelector('.progress-bar');
      fetch(overviewUrl, {cache:'no-store'})
        .then(r=>r.json())
        .then(data=>{
          // image
          if(data.snapshot_url){
            let snap = absUrl(data.snapshot_url, overviewUrl);
            snap += (snap.includes('?')?'&':'?') + '_=' + Date.now();
            img.src = snap;
          } else {
            img.src = FALLBACK_SVG;
          }
          // textes
          tile.querySelector('.printName').textContent = data.printName || '‚Äî';
          tile.querySelector('.estimated_end').textContent = data.estimated_end || '‚Äî';

          // progression
          const p = pct(data.progress);
          pbar.style.width = p + '%';
          pbar.textContent = p + '%';
          pbar.setAttribute('aria-valuenow', p);
        })
        .catch(()=>{
          img.src = FALLBACK_SVG;
          tile.querySelector('.printName').textContent = 'Erreur';
          tile.querySelector('.estimated_end').textContent = '‚Äî';
          pbar.style.width = '0%';
          pbar.textContent = '‚Äî';
          pbar.setAttribute('aria-valuenow', 0);
        });
    });
  }
  refreshTiles();
  setInterval(refreshTiles, 5000);
</script>
{% endblock %}
