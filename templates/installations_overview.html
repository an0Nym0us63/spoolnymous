{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <div class="tile-grid" id="tiles">
    <!-- Tuile locale -->
    <div class="tile card shadow-sm" data-overview="{{ local_overview_url }}">
      <div class="card-header p-2 d-flex align-items-center justify-content-between">
        <span class="tile-title text-truncate">üè† Installation locale</span>
        <span class="badge bg-primary">LOCAL</span>
      </div>
      <div class="card-body p-2 text-center">
        <img src="" alt="Snapshot local" class="tile-img rounded">
        <div class="tile-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tuiles distantes -->
    {% for inst in remote_installations %}
    <div class="tile card shadow-sm" data-overview="{{ inst.overview_url }}">
      <div class="card-header p-2 d-flex align-items-center justify-content-between">
        <span class="tile-title text-truncate">üåê {{ inst.name }}</span>
        <span class="badge bg-secondary">DISTANT</span>
      </div>
      <div class="card-body p-2 text-center">
        <img src="" alt="Snapshot {{ inst.name }}" class="tile-img rounded">
        <div class="tile-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}


{% block styles %}
<style>
  /* Grille de VRAIES petites tuiles, fixes et c√¥te √† c√¥te */
  .tile-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill, 220px);
    gap:12px;
    justify-content:start;
  }
  .tile{
    width:220px;               /* largeur fixe = mini tuile */
    border-radius:12px;
  }
  .tile-title{ font-weight:600; font-size:.95rem; max-width:150px; }
  /* Image contrainte, pas en plein √©cran */
  .tile-img{
    width:100%;
    height:120px;              /* hauteur fixe = vignette */
    object-fit:cover;          /* rendu "diaporama" */
    background:#f5f5f5;
    border:1px solid #eee;
  }
  .tile-info{ font-size:.85rem; }
  /* Barre de progression = pleine largeur, compacte */
  .progress{ height:10px; }
  .progress-bar{
    font-size:.7rem;
    line-height:10px;
    transition:width .25s ease;
  }

  /* Tr√®s petits √©crans : on autorise 180px */
  @media (max-width:480px){
    .tile-grid{ grid-template-columns:repeat(auto-fill, 180px); }
    .tile{ width:180px; }
    .tile-img{ height:100px; }
  }
</style>
{% endblock %}


{% block scripts %}
<script>
  const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="220" height="120">
      <rect width="100%" height="100%" fill="#f0f0f0"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="sans-serif" font-size="13" fill="#999">
        Snapshot indisponible
      </text>
    </svg>`);

  function pct(v){
    if(v==null || isNaN(v)) return 0;
    const n = Number(v);
    if(n<=1 && n>=0) return Math.round(n*100);  // accepte 0..1
    return Math.max(0, Math.min(100, Math.round(n)));
  }
  function absUrl(u, base){ try{ return new URL(u, base).toString(); }catch{ return u; } }

  function refreshTiles(){
    document.querySelectorAll('.tile').forEach(tile=>{
      const overviewUrl = tile.dataset.overview;
      const img = tile.querySelector('.tile-img');
      const pbar = tile.querySelector('.progress-bar');
      fetch(overviewUrl, {cache:'no-store'})
        .then(r=>r.json())
        .then(data=>{
          // image
          if(data.snapshot_url){
            let snap = absUrl(data.snapshot_url, overviewUrl);
            snap += (snap.includes('?')?'&':'?') + '_=' + Date.now();
            img.src = snap;
          } else {
            img.src = FALLBACK_SVG;
          }
          // textes
          tile.querySelector('.printName').textContent = data.printName || '‚Äî';
          tile.querySelector('.estimated_end').textContent = data.estimated_end || '‚Äî';

          // progression pleine largeur
          const p = pct(data.progress);
          pbar.style.width = p + '%';
          pbar.textContent = p + '%';
          pbar.setAttribute('aria-valuenow', p);
        })
        .catch(()=>{
          img.src = FALLBACK_SVG;
          tile.querySelector('.printName').textContent = 'Erreur';
          tile.querySelector('.estimated_end').textContent = '‚Äî';
          pbar.style.width = '0%';
          pbar.textContent = '‚Äî';
          pbar.setAttribute('aria-valuenow', 0);
        });
    });
  }
  refreshTiles();
  setInterval(refreshTiles, 5000);
</script>
{% endblock %}

