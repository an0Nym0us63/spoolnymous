{% extends "base.html" %}

{% block title %}Installations{% endblock %}

{% block content %}
<div class="container">
  <h1>Vue des installations</h1>
  <div class="grid" id="tiles">
    <!-- Tuile locale -->
    <div class="tile" data-name="Local" data-snapshot="{{ local_snapshot_url }}" data-status="{{ local_status_url }}">
      <h2>Installation locale</h2>
      <img src="{{ local_snapshot_url }}" alt="Snapshot local">
      <div class="status">Chargement...</div>
    </div>

    <!-- Tuiles distantes -->
    {% for inst in remote_installations %}
    <div class="tile" data-name="{{ inst.name }}" data-snapshot="{{ inst.snapshot_url }}" data-status="{{ inst.status_url }}">
      <h2>{{ inst.name }}</h2>
      <img src="{{ inst.snapshot_url }}" alt="Snapshot {{ inst.name }}">
      <div class="status">Chargement...</div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1em;
  }
  .tile {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .tile h2 {
    margin: 0;
    padding: 0.5em;
    background: #007BFF;
    color: white;
  }
  .tile img {
    width: 100%;
    height: auto;
    display: block;
  }
  .status {
    padding: 0.5em;
    font-family: monospace;
    white-space: pre-wrap;
    font-size: 0.9em;
    background: #f0f0f0;
    border-top: 1px solid #ccc;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function refreshTiles() {
    document.querySelectorAll('.tile').forEach(tile => {
      const snapshot = tile.dataset.snapshot;
      const status = tile.dataset.status;
      const img = tile.querySelector('img');
      const statusBox = tile.querySelector('.status');

      img.src = snapshot + "&_=" + Date.now();

      fetch(status)
        .then(resp => resp.json())
        .then(data => {
          statusBox.textContent = JSON.stringify(data, null, 2);
        })
        .catch(err => {
          statusBox.textContent = "Erreur de statut";
        });
    });
  }

  setInterval(refreshTiles, 5000);
  refreshTiles();
</script>
{% endblock %}
