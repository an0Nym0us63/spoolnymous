{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <div class="overview-grid" id="tiles">
    <!-- Tuile locale -->
    <div class="overview-tile card shadow-sm" data-overview="{{ local_overview_url }}">
      <div class="overview-header card-header p-2 d-flex align-items-center justify-content-between">
        <span class="overview-title text-truncate">üè† Installation locale</span>
        <span class="badge bg-primary">LOCAL</span>
      </div>
      <div class="overview-body card-body p-2 text-center">
        <img src="" alt="Snapshot local" class="overview-img rounded">
        <div class="overview-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tuiles distantes -->
    {% for inst in remote_installations %}
    <div class="overview-tile card shadow-sm" data-overview="{{ inst.overview_url }}">
      <div class="overview-header card-header p-2 d-flex align-items-center justify-content-between">
        <span class="overview-title text-truncate">üåê {{ inst.name }}</span>
        <span class="badge bg-secondary">DISTANT</span>
      </div>
      <div class="overview-body card-body p-2 text-center">
        <img src="" alt="Snapshot {{ inst.name }}" class="overview-img rounded">
		<div class="overview-sub mt-2">  <!-- üÜï -->
          <img src="" alt="Thumbnail {{ inst.name }}" class="overview-thumb rounded">  
        <div class="overview-info mt-2 text-start">
          <div class="small mb-1">üì¶ <strong>Impression</strong> : <span class="printName">‚Äî</span></div>
          <div class="small">üïí <strong>Fin estim√©e</strong> : <span class="estimated_end">‚Äî</span></div>
          <div class="progress mt-2" role="progressbar" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width:0%">0%</div>
          </div>
        </div>
        </div> 
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
/* Forcer le parent en GRID malgr√© les styles globaux */
#tiles.overview-grid {
  display: grid !important;
  grid-template-columns: repeat(3, minmax(0, 1fr)) !important; /* 3 tuiles par ligne */
  gap: 16px !important;  /* espace entre tuiles (horizontal + vertical) */
}

/* Responsive : 2 puis 1 colonne */
@media (max-width: 1200px) {
  #tiles.overview-grid { grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
}
@media (max-width: 768px) {
  #tiles.overview-grid { grid-template-columns: 1fr !important; }
}

/* S‚Äôassurer que la carte ne force pas la largeur pleine */
.overview-tile {
  width: auto !important;
  max-width: 100% !important;
}

/* Snapshot contraint (pas g√©ant) */
.overview-img {
  display: block;
  width: 100%;
  height: auto;          /* ajuste √† ton go√ªt (120‚Äì180) */
  object-fit: cover;      /* effet vignette propre */
  background: #f5f5f5;
  border-bottom: 1px solid #eee;
}

 /* Ligne "thumbnail + infos" */
  .overview-sub{ display:flex; gap:10px; align-items:flex-start; }
  .overview-thumb{
    width:80px; height:80px; object-fit:cover; background:#f5f5f5;
    border:1px solid #eee; border-radius:6px; flex:0 0 auto;
  }
  .overview-info{ font-size:.9rem; flex:1 1 auto; }

/* Petit espace suppl√©mentaire sous chaque tuile (en plus du gap de la grid) */
.overview-tile { margin-bottom: 8px; }
</style>
{% endblock %}

{% block scripts %}
<script>
  const FALLBACK_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="220" height="120">
      <rect width="100%" height="100%" fill="#f0f0f0"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="sans-serif" font-size="13" fill="#999">
        Snapshot indisponible
      </text>
    </svg>`);
	const FALLBACK_THUMB = 'data:image/svg+xml;utf8,'+encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80">
      <rect width="100%" height="100%" fill="#f0f0f0"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="sans-serif" font-size="11" fill="#999">Thumb</text>
    </svg>`);

  function pct(v){
    if(v==null || isNaN(v)) return 0;
    const n = Number(v);
    if(n<=1 && n>=0) return Math.round(n*100);  // accepte 0..1
    return Math.max(0, Math.min(100, Math.round(n)));
  }
  function absUrl(u, base){ try{ return new URL(u, base).toString(); }catch{ return u; } }

  function refreshTiles(){
    document.querySelectorAll('.overview-tile').forEach(tile=>{
      const overviewUrl = tile.dataset.overview;
      const img = tile.querySelector('.overview-img');
      const pbar = tile.querySelector('.progress-bar');
      fetch(overviewUrl, {cache:'no-store'})
        .then(r=>r.json())
        .then(data=>{
          // image
          if(data.snapshot_url){
            let snap = absUrl(data.snapshot_url, overviewUrl);
            snap += (snap.includes('?')?'&':'?') + '_=' + Date.now();
            img.src = snap;
          } else {
            img.src = FALLBACK_SVG;
          }
		  /* Thumbnail mini */
          if (data.thumbnail_data_url){
            th.src = data.thumbnail_data_url;
          } else if (data.thumbnail_url){
            let t = absUrl(data.thumbnail_url, overviewUrl);
            t += (t.includes('?')?'&':'?') + '_=' + Date.now();
            th.src = t;
          } else {
            th.src = FALLBACK_THUMB;
          }
          // textes
          tile.querySelector('.printName').textContent = data.printName || '‚Äî';
          tile.querySelector('.estimated_end').textContent = data.estimated_end || '‚Äî';

          // progression
          const p = pct(data.progress);
          pbar.style.width = p + '%';
          pbar.textContent = p + '%';
          pbar.setAttribute('aria-valuenow', p);
        })
        .catch(()=>{
          img.src = FALLBACK_SVG;
          th.src = FALLBACK_THUMB;
          tile.querySelector('.printName').textContent = 'Erreur';
          tile.querySelector('.estimated_end').textContent = '‚Äî';
          pbar.style.width = '0%';
          pbar.textContent = '‚Äî';
          pbar.setAttribute('aria-valuenow', 0);
        });
    });
  }
  refreshTiles();
  setInterval(refreshTiles, 5000);
</script>
{% endblock %}
