{# templates/fragments/object_row.html #}
{% import 'macros/hidden_args.jinja2' as macros %}
{% set collapse_id = "obj_" ~ o.id %}
  <div class="card shadow-sm object-card" id="object_{{ o.id }}">
    <div class="card-header obj-hdr"
     id="heading_{{ o.id }}" role="button"
     data-bs-toggle="collapse" data-bs-target="#{{ collapse_id }}"
     aria-expanded="false" aria-controls="{{ collapse_id }}">

  <div class="obj-grid">
    <!-- Colonne gauche : statut (vente / offert / dispo / indispo) -->
    <div class="obj-status d-flex align-items-center justify-content-start me-1 flex-shrink-0">
      {% if o.sold_price is not none %}
        {% if o.sold_price == 0 %}
			 {% if o.personal %}
				<i class="bi bi-house-door-fill text-purple" title="Objet personnel"></i>
			{% else %}
				<i class="bi bi-gift-fill text-info" title="Offert"></i>
			{% endif %}
        {% else %}
          <i class="bi bi-bag-check-fill text-success" title="Vendu"></i>
        {% endif %}
      {% else %}
        {% if o.available %}
          <i class="bi bi-box2-fill text-warning" title="Disponible (en stock)"></i>
        {% else %}
          <i class="bi bi-slash-circle-fill text-secondary" title="Indisponible"></i>
        {% endif %}
      {% endif %}
    </div>

    <!-- Colonne centre : titre + chips -->
<div class="obj-main d-flex flex-column align-items-center text-center px-1" style="max-width: 100%;">
  <div class="w-100" style="max-width: 200px;">
    {% if o.sold_price is not none %}
      {% if o.sold_price == 0 %}
		{% if o.personal %}
		<div class="badge bg-purple text-dark small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
    {% else %}
      <div class="badge bg-info text-dark small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
    {% endif %}
        
      {% else %}
        <div class="badge bg-success text-white small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% endif %}
    {% else %}
      {% if o.available %}
        <div class="badge bg-warning text-dark small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% else %}
        <div class="badge bg-secondary text-light small fw-semibold text-break w-100" style="white-space: normal; word-break: break-word;">{{ o.name }}</div>
      {% endif %}
    {% endif %}
  </div>

  <div class="chips justify-content-center flex-wrap mt-1 gap-1 w-100" style="max-width: 220px;">
    <span class="badge rounded-pill bg-light text-dark border border-secondary fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
      🛠️ {{ "%.2f"|format(o.cost_total or 0) }} {{ currencysymbol or '€' }}
    </span>

    {% if o.sold_price is not none %}
      {% if o.sold_price == 0 %}
		 {% if o.personal %}
			<span class="badge rounded-pill bg-purple text-white border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">🏠 Perso</span>
			{% else %}
      <span class="badge rounded-pill bg-info text-dark border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">🎁 Offert</span>
	  {% endif %}
      {% else %}
        <span class="badge rounded-pill bg-primary text-white border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
          💰 {{ "%.2f"|format(o.sold_price) }} {{ currencysymbol or '€' }}
        </span>
        {% set _total  = (o.cost_total or 0) %}
        {% set _margin = (o.margin if (o.margin is not none) else (o.sold_price - _total)) %}
        {% set _pos    = _margin >= 0 %}
        <span class="badge rounded-pill {{ 'bg-success text-white' if _pos else 'bg-danger text-white' }} border fw-normal" style="font-size: 0.65rem; padding: 0.2em 0.45em;">
          {{ '📈' if _pos else '📉' }} {{ '%.2f'|format(_margin) }} {{ currencysymbol or '€' }}
        </span>
      {% endif %}
    {% endif %}
	{# Affichage prix souhaité & marge théorique (si éligible) #}
{% if o.sold_price is none and o.available and o.desired_price is not none %}
  <span class="badge rounded-pill bg-purple-subtle border fw-normal"
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    🎯 {{ '%.2f'|format(o.desired_price) }} {{ currencysymbol or '€' }}
  </span>
  {% set _theo = (o.desired_price - (o.cost_total or 0)) %}
  {% set _pos_th = _theo >= 0 %}
  <span class="badge rounded-pill {{ 'bg-success text-white' if _pos_th else 'bg-danger text-white' }} border fw-normal"
        style="font-size: 0.65rem; padding: 0.2em 0.45em;">
    🧮 {{ '%.2f'|format(_theo) }} {{ currencysymbol or '€' }}
  </span>
{% endif %}
  </div>
</div>

    <!-- Colonne droite : thumbnail avec composant global `.thumb` -->
<div class="text-end flex-shrink-0">
  <div class="thumb position-relative" style="--thumb-size: 48px;">
    {% if o.thumbnail %}
      <img src="{{ o.thumbnail }}" alt="" class="thumb-img">
    {% else %}
      <div class="thumb-ph" title="Aucune image"></div>
    {% endif %}

    {% set acc_count = (obj_accessories.get(o.id, []) | length) if obj_accessories is defined else 0 %}
    {% if acc_count > 0 %}
      <span class="thumb-acc-flag" title="{{ acc_count }} accessoire{{ 's' if acc_count>1 else '' }}">🧰</span>
    {% endif %}
  </div>
</div>

  </div>
</div>

{% include 'fragments/modals_group_object.html' %}
    <div id="{{ collapse_id }}" class="collapse" aria-labelledby="heading_{{ o.id }}" data-bs-parent="#objectsAccordion">
      <div class="card-body">
		<div class="d-flex justify-content-end mb-2" style="z-index: 1;" data-requires-write>
  <div class="dropdown">
    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
      Actions
    </button>
    <ul class="dropdown-menu dropdown-menu-end">
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#renameModal_{{ o.id }}">
          📝 Renommer
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#sellModal_{{ o.id }}">
          💳 Vente / don
        </a>
      </li>
	  {% if o.sold_price is none and o.available %}
  <li>
    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#wishPriceModal_{{ o.id }}">
      🎯 Définir le prix souhaité
    </a>
  </li>
{% endif %}
      <li>
        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#commentModal_{{ o.id }}">
          💬 Modifier le commentaire
        </a>
      </li>
{% if not o.object_group_id %}
<li>
  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#objGroupModal_{{ o.id }}">
    ➕ Ajouter à un groupe
  </a>
</li>
{% else %}
<li>
  <form method="post" action="{{ url_for('objects_remove_from_group') }}">
    {{ macros.render_filtered_args(args) }}
    <input type="hidden" name="object_id" value="{{ o.id }}">
    <button type="submit" class="dropdown-item text-danger">
      ❌ Retirer du groupe
    </button>
  </form>
</li>
{% endif %}
	  <li>
  <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#addAccModal_{{ o.id }}">
    🧰 Ajouter accessoire
  </a>
</li>
      {% if o.parent_type == 'print' %}
        <li>
          <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_print_id={{ o.parent_id }}&focus_print_id={{ o.parent_id }}">
            🔎 Voir la référence
          </a>
        </li>
      {% else %}
        <li>
          <a class="dropdown-item" href="{{ url_for('print_history') }}?ref_group_id={{ o.parent_id }}&focus_group_id={{ o.parent_id }}">
            🔎 Voir la référence
          </a>
        </li>
      {% endif %}
	  <li>
  <a class="dropdown-item text-success" href="#"
     onclick="triggerPhotoUnified({ type: 'objects', id: {{ o.id }} }); return false;">
    📸 Uploader photo
  </a>
</li>
      <li>
        <a href="#"
           class="dropdown-item text-danger object-delete-btn"
           data-object-id="{{ o.id }}"
           data-object-name="{{ o.name|e }}">
          🗑 Supprimer
        </a>
        <form id="deleteForm_{{ o.id }}" class="d-none m-0 p-0"
              method="post" action="{{ url_for('objects_delete', object_id=o.id) }}">
          {{ macros.render_filtered_args(args) }}
        </form>
      </li>
    </ul>
  </div>
</div>
{% if o.thumbnail %}
	  <div class="text-center">{% set imgs = obj_images.get(o.id, []) if obj_images is defined else [] %}
{% if imgs %}
  <div id="carousel-object-{{ o.id }}"
       class="carousel slide print-carousel mb-3"
       data-bs-ride="false" data-bs-touch="true" data-bs-interval="false">

    <div class="carousel-inner rounded">
	
    {# Slide 0 : miniature (PNG) comme avant #}
    <div class="carousel-item active">
      <div class="preview-frame d-flex align-items-center justify-content-center">
          <img
            src="{{ o.thumbnail }}"
            alt="3mf"
            class="preview-img"
            loading="lazy"
          >
      </div>
<div class="text-center mt-1">
  <small class="caption-badge">3mf</small>
</div>
    </div>
      {% for img in imgs %}
        <div class="carousel-item {% if loop.first %}active{% endif %}">
		<button type="button"
          class="btn btn-sm btn-outline-light carousel-delete-btn js-del-photo"
          title="Supprimer cette photo"
          data-url="{{ img.url }}"
          {% if '.3mf' in img.url|lower %}style="display:none"{% endif %} data-requires-write>
    <i class="bi bi-x-lg"></i>
  </button>
          <div class="preview-frame d-flex align-items-center justify-content-center">
            <img src="{{ img.url }}" alt="{{ img.name }}" class="preview-img" loading="lazy">
          </div>
<div class="text-center mt-1">
  <small class="caption-badge">{{ img.name }}</small>
</div>
        </div>
      {% endfor %}
    </div>

    {% if imgs|length > 1 %}
      <button class="carousel-control-prev" type="button"
              data-bs-target="#carousel-object-{{ o.id }}" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Précédent</span>
      </button>
      <button class="carousel-control-next" type="button"
              data-bs-target="#carousel-object-{{ o.id }}" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Suivant</span>
      </button>

      <div class="carousel-indicators">
        {% for _ in imgs %}
          <button type="button" data-bs-target="#carousel-object-{{ o.id }}"
                  data-bs-slide-to="{{ loop.index0 }}"
                  class="{% if loop.first %}active{% endif %}"
                  aria-current="{% if loop.first %}true{% else %}false{% endif %}">
          </button>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endif %}
      </div>
      {% endif %}
	  {% if o.comment %}
	  <div class="text-center mt-2">
  <span class="badge d-inline-block bg-warning bg-opacity-10 border border-warning rounded-pill px-3 py-1"
        style="font-size: 0.65rem; max-width: 90vw; white-space: normal; word-break: break-word;">
    <span class="text-warning">📃</span> <span class="text-muted">{{ o.comment }}</span>
  </span>
  </div>
  {% endif %}
       <div class="row text-muted small gx-3 gy-2 mb-3 row-cols-2 row-cols-md-3">
  <div class="col">
    <strong>🛠️</strong>
    {{ '%.2f'|format(o.cost_fabrication or 0) }} {{ currencysymbol or '€' }}<span class="text-muted fst-italic" style="font-size: 0.6em;">
    ({{ '%.2f'|format(o.normal_cost_unit or 0)}})
  </span>
  </div>
  <div class="col">
    <strong>🧰</strong>
    {{ '%.2f'|format(o.cost_accessory or 0) }} {{ currencysymbol or '€' }}
  </div>
  <div class="col">
    <strong>📦</strong>
    {{ '%.2f'|format(o.cost_total or 0) }} {{ currencysymbol or '€' }}<span class="text-muted fst-italic" style="font-size: 0.6em;">
     ({{ '%.2f'|format((o.normal_cost_unit or 0) + (o.cost_accessory or 0)) }})
  </span>
  </div>
  <div class="col">
    <strong>💰</strong>
    {% if o.sold_price is not none %}
      {{ '%.2f'|format(o.sold_price) }} {{ currencysymbol or '€' }}
    {% else %}
      <span class="text-muted fst-italic">non vendu</span>
    {% endif %}
  </div>
  <div class="col">
    <strong>📈</strong>
    {% if o.sold_price %}
      {% set _margin = o.margin if o.margin is not none else (o.sold_price - (o.cost_total or 0)) %}
      {{ '%.2f'|format(_margin) }} {{ currencysymbol or '€' }}
    {% else %}
      <span class="text-muted fst-italic">n/a</span>
    {% endif %}
  </div>
  <div class="col">
    <strong>🗓️</strong>
    {% if o.created_at %}
      {{ o.created_at[:10].split('-') | reverse | join('/') }}
    {% else %}
      ?
    {% endif %}
  </div>
  <div class="col">
    <strong>🛍️</strong>
    {% if o.sold_date %}
      {{ o.sold_date[:10].split('-') | reverse | join('/') }}
    {% else %}
      <span class="text-muted fst-italic">non vendu</span>
    {% endif %}
  </div>
</div>

{% set accs = obj_accessories.get(o.id, []) %}
{% if accs %}
  <div class="mb-3">
    <div class="fw-semibold mb-2">🧰 Accessoires</div>
    <div class="d-flex flex-wrap gap-3">
      {% for a in accs %}
        <div class="text-center" style="width:86px;">
          <div class="position-relative">
            <div class="rounded border overflow-hidden d-flex align-items-center justify-content-center"
     style="width: 86px; height: 86px;">
  <img
    src="{{ url_for('static', filename=a.image_path) if a.image_path else url_for('static', filename='placeholder.png') }}"
    alt="{{ a.accessory_name }}"
    style="max-width: 100%; max-height: 100%; object-fit: contain;">
</div>
            <button type="button"
                    class="btn-close position-absolute top-0 end-0 bg-white rounded-circle shadow-sm acc-remove-btn"
                    title="Retirer"
                    data-object-id="{{ o.id }}"
                    data-accessory-id="{{ a.accessory_id }}"
                    data-qty="{{ a.quantity }}"
                    style="transform: scale(.8);">
            </button>
          </div>
          <div class="small mt-1 text-truncate" title="{{ a.accessory_name }}">{{ a.accessory_name }}</div>
          <div class="small text-muted">× {{ a.quantity }}</div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<!-- Tags -->
<div class="mt-2">
  <strong>Tags :</strong>
  {% set tags = _obj_tags.get(o.id, []) %}
  <div class="d-flex flex-wrap gap-1 align-items-center">
    {% if tags and tags|length > 0 %}
      {% for tag in tags %}
        <span class="badge bg-primary">
          {{ tag }}
          <button
            class="btn-close btn-close-white btn-sm ms-1 obj-remove-tag"
            data-object-id="{{ o.id }}"
            data-tag="{{ tag }}"
            data-requires-write
            aria-label="Supprimer le tag « {{ tag }} »"></button>
        </span>
      {% endfor %}
    {% else %}
      <span class="text-muted">Aucun</span>
    {% endif %}
  </div>

  <div class="input-group mt-1" style="max-width: 300px;" data-requires-write>
    <input type="text" class="form-control form-control-sm obj-add-tag-input"
           placeholder="Nouveau tag… (sépare par , ou ;)">
    <button class="btn btn-sm btn-success obj-add-tag-btn" data-object-id="{{ o.id }}">✚ Ajouter</button>
  </div>
</div>
      </div>
    </div>
  </div>
  {% if o.sold_price is none and o.available %}
<div class="modal fade" id="wishPriceModal_{{ o.id }}" tabindex="-1" aria-labelledby="wishPriceLabel_{{ o.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_set_desired_price_route', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
      <div class="modal-header">
        <h5 class="modal-title" id="wishPriceLabel_{{ o.id }}">🎯 Prix de vente souhaité — Objet #{{ o.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Prix souhaité ({{ currencysymbol or '€' }})</label>
        <input type="number" step="0.01" min="0" name="desired_price" class="form-control"
               value="{{ o.desired_price is not none and ('%.2f'|format(o.desired_price)) or '' }}"
               placeholder="Laisser vide pour supprimer">
        <div class="form-text">
          Coût actuel : <strong>{{ '%.2f'|format(o.cost_total or 0) }} {{ currencysymbol or '€' }}</strong>
          {% if o.desired_price is not none %}
            — Marge théorique si inchangé :
            <strong>{{ '%.2f'|format((o.desired_price - (o.cost_total or 0))) }} {{ currencysymbol or '€' }}</strong>
          {% endif %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
{% endif %}
  <div class="modal fade" id="addAccModal_{{ o.id }}" tabindex="-1" aria-labelledby="addAccLabel_{{ o.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <form class="modal-content" method="post" action="{{ url_for('objects_add_accessory', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
	  <input type="hidden" name="focus_object_id" value="{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="addAccLabel_{{ o.id }}">➕ Ajouter un accessoire à « {{ o.name }} »</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <div class="modal-body">
        <!-- Recherche + liste -->
        <div class="mb-3">
          <label class="form-label">Accessoire</label>
          <input type="text" class="form-control" id="accSearch_{{ o.id }}" placeholder="Rechercher un accessoire (nom)…">
          <div class="list-group mt-2" id="accResults_{{ o.id }}" style="max-height: 240px; overflow:auto;"></div>
          <input type="hidden" name="accessory_id" id="accId_{{ o.id }}">
        </div>

        <!-- Sélection courante -->
        <div id="accSelected_{{ o.id }}" class="d-none">
          <div class="d-flex align-items-center gap-2">
            <img id="accSelectedImg_{{ o.id }}" src="{{ url_for('static', filename='placeholder.png') }}" alt="" width="40" height="40" class="rounded border" style="object-fit:cover;">
            <div class="flex-grow-1">
              <div class="fw-semibold" id="accSelectedName_{{ o.id }}"></div>
              <div class="text-muted small">Stock dispo : <span id="accAvail_{{ o.id }}">0</span></div>
            </div>
          </div>
        </div>

        <!-- Quantité -->
        <div class="mt-3">
          <label class="form-label">Quantité</label>
          <input type="number" class="form-control" name="qty" id="accQty_{{ o.id }}" min="1" value="1" required>
          <div class="form-text">La quantité ne peut pas dépasser le stock disponible.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary" id="accSubmitBtn_{{ o.id }}" disabled>Ajouter</button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="rmAccModal_{{ o.id }}" tabindex="-1" aria-labelledby="rmAccLabel_{{ o.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_remove_accessory', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
	  <input type="hidden" name="focus_object_id" value="{{ o.id }}">
      <input type="hidden" name="accessory_id" id="rmAccId_{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="rmAccLabel_{{ o.id }}">Retirer l’accessoire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <p id="rmAccText_{{ o.id }}" class="mb-3"></p>
        <div id="rmAccQtyWrap_{{ o.id }}" class="d-none">
          <label class="form-label">Quantité à retirer</label>
          <input type="number" class="form-control" name="qty" id="rmAccQty_{{ o.id }}" min="1" value="1">
          <div class="form-text">Vous ne pouvez pas dépasser la quantité liée à l’objet.</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-danger">Retirer</button>
      </div>
    </form>
  </div>
</div>
  <div class="modal fade" id="renameModal_{{ o.id }}" tabindex="-1" aria-labelledby="renameLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_rename', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
	  <input type="hidden" name="focus_object_id" value="{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="renameLabel_{{ o.id }}">Renommer l’objet</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" name="name" value="{{ o.name }}" required>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
<div class="modal fade" id="sellModal_{{ o.id }}" tabindex="-1" aria-labelledby="sellLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_sell', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
	  <input type="hidden" name="focus_object_id" value="{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="sellLabel_{{ o.id }}">Vente / don</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Prix de vente</label>
          <div class="input-group">
            <input type="number" name="sold_price" class="form-control" min="0" step="0.01"
       value="{% if o.sold_price is not none %}{{ '%.2f'|format(o.sold_price) }}{% endif %}"
       placeholder="0.00">
            <span class="input-group-text">{{ currencysymbol or '€' }}</span>
          </div>
          <div class="form-text">Mettre <strong>0</strong> pour un don / cadeau.</div>
        </div>
		<div class="form-check mt-2">
  <input class="form-check-input"
         type="checkbox"
         id="sold_personal_{{ o.id }}"
         name="sold_personal"
         value="1"
         {% if o.sold_price == 0 and o.personal %}checked{% endif %}>
  <label class="form-check-label" for="sold_personal_{{ o.id }}">
    Objet personnel (non offert)
  </label>
  <div class="form-text">Activable uniquement si le prix est 0.</div>
</div>
        <div class="mb-3">
          <label class="form-label">Date de vente</label>
          <input type="date" name="sold_date" class="form-control"
       value="{{ (o.sold_date[:10]) if o.sold_date else '' }}">
          <div class="form-text">Par défaut : aujourd’hui.</div>
        </div>

        <div class="mb-0">
          <label class="form-label">Commentaire (optionnel)</label>
          <textarea name="sold_comment" class="form-control" rows="3"
          placeholder="Détails de la vente / du don…">{{ o.comment or '' }}</textarea>
        </div>
      </div>
      <div class="modal-footer">
  <!-- Soumet le même formulaire vers la route d'annulation -->
  <button type="submit"
          class="btn btn-outline-danger me-auto"
          formmethod="post"
          formaction="{{ url_for('objects_unsell', object_id=o.id) }}">
    ❌ Annuler la vente
  </button>

  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
  <button type="submit" class="btn btn-primary">Enregistrer</button>
</div>
    </form>
  </div>
</div>

<div class="modal fade" id="commentModal_{{ o.id }}" tabindex="-1" aria-labelledby="commentLabel_{{ o.id }}">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('objects_update_comment', object_id=o.id) }}">
      {{ macros.render_filtered_args(args) }}
	  <input type="hidden" name="focus_object_id" value="{{ o.id }}">
      <div class="modal-header">
        <h5 class="modal-title" id="commentLabel_{{ o.id }}">Modifier le commentaire</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <textarea name="comment" class="form-control" rows="5"
                  placeholder="Saisissez un commentaire pour cet objet…">{{ o.comment or '' }}</textarea>
        <div class="form-text">Laissez vide pour effacer le commentaire.</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="submit" class="btn btn-primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>