<div class="modal fade" id="spoolModal" tabindex="-1" aria-labelledby="spoolModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="spoolModalLabel">Créer une bobine</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        <form id="spoolForm">
          <input type="hidden" id="spool_id">

          <div class="mb-3">
            <label class="form-label">Filament</label>
            <select id="spool_filament_id" class="form-select" placeholder="Choisir un filament…"></select>
            <div class="form-text">Tape pour rechercher (fabricant, matériau, nom).</div>
          </div>

          <div class="row g-3">
            <div class="mb-3" id="spool_field_price">
  <label class="form-label">Prix (€)</label>
  <input type="number" step="0.01" class="form-control" id="spool_price" name="price">
</div>
<div class="mb-3" id="spool_field_initial_weight">
  <label class="form-label">Poids (g)</label>
  <input type="number" min="0" step="1" class="form-control"
         id="spool_remaining_weight_g" name="remaining_weight_g">
</div>
            <div class="mb-3" id="spool_field_ams_tray">
  <label class="form-label">AMS / Tray</label>
  <input type="text" class="form-control" id="spool_ams_tray" name="ams_tray">
</div>
          </div>

          <div class="row g-3 mt-1">
            <div class="mb-3" id="spool_field_location">
  <label class="form-label">Localisation</label>
  <input type="text" class="form-control" id="spool_location" name="location">
</div>
            <div class="col-md-6">
              <label class="form-label">Tag NFC / UID</label>
              <input type="text" class="form-control" id="spool_tag_number" placeholder="ex: 04A3…">
            </div>
          </div>

          <div class="form-check mb-3" id="spool_field_archived">
  <input class="form-check-input" type="checkbox" id="spool_archived" name="archived" value="1">
  <label class="form-check-label" for="spool_archived">Archivé</label>
</div>

          <div class="mt-3">
            <label class="form-label">Commentaire</label>
            <textarea class="form-control" id="spool_comment" rows="3"></textarea>
          </div>

          <div class="alert alert-danger mt-3 d-none" id="spoolError"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <button class="btn btn-primary" id="spoolSaveBtn" onclick="saveSpool()">Enregistrer</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  let spoolModal = null;
  let filamentTS = null;

  function ensureTomSelect(selector, options){
    if (window.TomSelect){
      const el = document.querySelector(selector);
      if (!el) return null;
      if (el.tomselect) el.tomselect.destroy();
      return new TomSelect(selector, {
        create: false,
        persist: false,
        maxItems: 1,
        searchField: ['text', 'value'],
        sortField: { field: 'text', direction: 'asc' },
        options: options || [],
        render: {
          option: function(data, escape){ return `<div>${escape(data.text)}</div>`; },
          item:   function(data, escape){ return `<div>${escape(data.text)}</div>`; }
        }
      });
    } else {
      const sel = document.querySelector(selector);
      sel.innerHTML = '';
      (options || []).forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        sel.appendChild(opt);
      });
      return null;
    }
  }

  async function loadFilamentChoices(){
    const res = await fetch('/api/filaments/choices');
    const data = await res.json();
    if (!data.ok) throw new Error(data.message || 'Erreur /api/filaments/choices');
    return data.choices || [];
  }

  function showSpoolError(msg){
    const el = document.getElementById('spoolError');
    if (!el) return;
    el.textContent = msg || 'Erreur.';
    el.classList.remove('d-none');
  }
  function clearSpoolError(){
    const el = document.getElementById('spoolError');
    if (!el) return;
    el.textContent = '';
    el.classList.add('d-none');
  }

  function hideBlock(id, hidden = true){
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.toggle('d-none', hidden);
}

window.openSpoolModal = async function(spool, opts){
  clearSpoolError();
  opts = opts || {};

  if (!spoolModal){
    const el = document.getElementById('spoolModal');
    if (!el) return;
    spoolModal = bootstrap.Modal.getOrCreateInstance(el);
  }

  const form = document.getElementById('spoolForm');
  if (form) form.reset();
  (document.getElementById('spool_id') || {}).value = (spool && spool.id) || '';

  const isEdit = !!(spool && spool.id);

  // Charger les choix + sélectionner le filament si donné
  try {
    const choices = await loadFilamentChoices();
    filamentTS = ensureTomSelect('#spool_filament_id', choices);
    const selected = isEdit ? spool.filament_id : (opts.filament_id || null);
    if (filamentTS){
      filamentTS.clear();
      if (selected != null) filamentTS.addItem(String(selected), true);
    } else {
      const sel = document.getElementById('spool_filament_id');
      if (sel) sel.value = selected || '';
    }
  } catch (e){
    return showSpoolError(e?.message || e);
  }

  // Helpers set
  const set = (id, val) => {
    const el = document.getElementById(id);
    if (el != null && val != null && val !== '') el.value = val;
  };

  // Valeurs communes (édition)
  set('spool_price', (spool && spool.price) || '');
  set('spool_remaining_weight_g', (spool && spool.remaining_weight) || '');
  set('spool_ams_tray', (spool && spool.ams_tray) || '');
  set('spool_location', (spool && spool.location) || '');
  set('spool_tag_number', (spool && spool.tag_number) || '');
  set('spool_comment', (spool && spool.comment) || '');
  const arch = document.getElementById('spool_archived');
  if (arch) arch.checked = !!(spool && spool.archived);

  // Cas création : defaults depuis le filament
  if (!isEdit) {
    set('spool_price', opts.filament_price);
    set('spool_remaining_weight_g', opts.filament_weight_g);

    // location par défaut
    const loc = document.getElementById('spool_location');
    if (loc && !loc.value) loc.value = 'Tiroirs';

    // cacher blocs
    hideBlock('spool_field_ams_tray', true);
    hideBlock('spool_field_location', true);
    hideBlock('spool_field_archived', true);
    hideBlock('spool_field_initial_weight', true);
  } else {
    // en édition : toujours visibles
    hideBlock('spool_field_ams_tray', false);
    hideBlock('spool_field_location', false);
    hideBlock('spool_field_archived', false);
    hideBlock('spool_field_initial_weight', false);
  }

  // titre
  const title = document.getElementById('spoolModalLabel');
  if (title) title.textContent = isEdit ? 'Modifier la bobine' : 'Créer une bobine';

  spoolModal.show();
};

// Appelé quand on clique "Créer une bobine" depuis un filament
window.openSpoolModalForFilament = function (filament) {
  try {
    // Tolère qu’on te passe une string JSON
    if (typeof filament === 'string') {
      try { filament = JSON.parse(filament); } catch (_) {}
    }
  } catch(_) {}

  // Ouverture création
  if (typeof openSpoolModal === 'function') openSpoolModal();

  // Pré-remplissages (seulement si objet)
  if (filament && typeof filament === 'object') {
    const p = filament.price ?? null;
    if (document.getElementById('spool_price') && p != null) {
      document.getElementById('spool_price').value = p;
    }

    const w = filament.filament_weight_g ?? null;
    const elInit = document.getElementById('spool_initial_weight');
    if (elInit && w != null) elInit.value = w;
  }

  // Defaults
  const loc = document.getElementById('spool_location');
  if (loc) loc.value = 'Tiroirs';
  const arch = document.getElementById('spool_archived');
  if (arch) arch.checked = false;

  hideBlock('spool_field_ams_tray', true);
  hideBlock('spool_field_location', true);
  hideBlock('spool_field_archived', true);
  hideBlock('spool_field_initial_weight', true);
};

  function numOrNull(raw){
  if (raw == null) return null;
  const s = String(raw).trim().replace(',', '.');
  if (s === '') return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

window.saveSpool = async function(){
  clearSpoolError();
  const id = (document.getElementById('spool_id') || {}).value || null;

  const filament_id = (filamentTS && filamentTS.getValue)
    ? filamentTS.getValue()
    : (document.getElementById('spool_filament_id') || {}).value;

  if (!filament_id) return showSpoolError("Choisis un filament.");

  const payload = {
    filament_id: Number(filament_id),
    price_override: numOrNull(document.getElementById('spool_price')?.value),
    initial_weight_g: numOrNull(document.getElementById('spool_initial_weight')?.value),
    remaining_weight_g: numOrNull(document.getElementById('spool_remaining_weight_g')?.value),
    location: (document.getElementById('spool_location') || {}).value || null,
    tag_number: (document.getElementById('spool_tag_number') || {}).value || null,
    ams_tray: (document.getElementById('spool_ams_tray') || {}).value || null,
    archived: !!((document.getElementById('spool_archived') || {}).checked),
    comment: (document.getElementById('spool_comment') || {}).value || null,
  };

  // garde ton check de prix si tu veux un message plus précis :
  const p = document.getElementById('spool_price')?.value ?? '';
  if (p.trim() && numOrNull(p) == null) {
    return showSpoolError('Le prix doit être un nombre (ex: 24.90).');
  }

  try{
    const resp = await fetch(id ? `/api/spools/${id}` : '/api/spools', {
      method: id ? 'PUT' : 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
    });
    const data = await resp.json();
    if (!resp.ok || !data.ok){
      return showSpoolError((data && data.message) || "Erreur lors de l'enregistrement.");
    }
    window.location.reload();
  } catch (e){
    showSpoolError("Erreur réseau : " + (e?.message || e));
  }
};
})();
</script>