<div
  class="rounded-xl overflow-hidden border border-gray-700 shadow-md transition hover:border-warning backdrop-blur-sm"
  style="background: linear-gradient(135deg, rgba(35,35,35,0.9), rgba(45,45,45,0.85));"
  data-tray-id="{{ ams_id|string }}_{{ tray_data.id|string }}"
  id="tray-card-{{ ams_id|string }}_{{ tray_data.id|string }}"
>
  <!-- Header cliquable -->
  <div
    class="px-4 py-2 cursor-pointer text-sm bg-gray-800 hover:bg-gray-700 transition flex justify-between items-start"
    data-bs-toggle="collapse"
    data-bs-target="#trayDetails_{{ ams_id|string }}_{{ tray_data.id|string }}"
    aria-expanded="false"
    aria-controls="trayDetails_{{ ams_id|string }}_{{ tray_data.id|string }}"
  >
    <div class="flex-1">
      <div class="font-semibold text-white">
        {% if ams_id|int != EXTERNAL_SPOOL_AMS_ID %}
          {{ (tray_data.id|int + 1) }}
        {% else %}
          Externe
        {% endif %}
        {% if tray_data.name %}
          - <span id="tray-name-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] name -->
            {{ tray_data.name }}
          </span>
        {% else %}
          {% if tray_data.tray_type %}
            - {{ '<i class="bi bi-exclamation-circle text-danger me-2"></i>' | safe }}
          {% endif %}
        {% endif %}
      </div>

      <!-- Ligne meta type / subbrand / vendor -->
      <div class="text-gray-400 text-xs" id="tray-meta-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] meta -->
        {% if tray_data.tray_type %}
          {{ tray_data.tray_type }}
          {% if tray_data.tray_sub_brands %} - {{ tray_data.tray_sub_brands }}{% endif %}
          - {{ tray_data.vendor }}
        {% else %}
          Vide
        {% endif %}
      </div>
    </div>

    <div class="text-end text-white text-sm">
      {% if tray_data.tray_type %}
        <!-- Couleur(s) -->
        <div>
          {% if tray_data.tray_color is iterable and tray_data.tray_color is not string %}
            <div class="spool-icon small d-inline-block" id="tray-color-{{ ams_id|string }}_{{ tray_data.id|string }}" data-mode="multi"><!-- [LIVE-ID] color multi -->
              {% for color in tray_data.tray_color %}
                <div style="background-color:#{{ color }}" title="#{{ color }}"></div>
              {% endfor %}
            </div>
          {% else %}
            <span class="inline-block rounded w-6 h-5 shadow border"
                  id="tray-color-{{ ams_id|string }}_{{ tray_data.id|string }}" data-mode="mono"  <!-- [LIVE-ID] color mono -->
                  style="background-color: #{{ tray_data.tray_color }};">
            </span>
          {% endif %}
        </div>

        <!-- Poids restant (si AUTO_SPEND & matched) -->
        {% if AUTO_SPEND and tray_data.matched %}
          <div class="text-xs mt-1 text-gray-300" data-remaining-weight-wrapper><!-- [LIVE-ID] wrapper -->
            <span id="tray-remaining-weight-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] remaining_weight -->
              {{ tray_data.remaining_weight|round }}g
            </span>
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>

  <!-- DÃ©tails -->
  <div class="collapse" id="trayDetails_{{ ams_id|string }}_{{ tray_data.id|string }}">
    <div class="px-4 py-3"
         style="background-color: rgba(45, 50, 60, 0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border-top: 1px solid rgba(255,255,255,.06)">

      {% if tray_data.tray_type %}
        <div class="flex gap-4">
          <div class="min-w-[5.5rem]">
            {% if tray_data.tray_color is iterable and tray_data.tray_color is not string %}
              <div class="spool-icon"><!-- palette multiple -->
                {% for color in tray_data.tray_color %}
                  <div style="background-color:#{{ color }}" title="#{{ color }}"></div>
                {% endfor %}
              </div>
            {% else %}
              <span class="inline-block mt-2 rounded px-2 py-1 text-xs font-bold shadow"
                    style="background-color: #{{ tray_data.tray_color }};
                           color: {% if color_is_dark(tray_data.tray_color) %}#fff{% else %}#000{% endif %}">
                #{{ tray_data.tray_color|upper }}
              </span>
            {% endif %}
          </div>

          <div class="flex-1 space-y-2">

            <div class="flex items-center justify-between">
              <span class="text-gray-400 flex items-center gap-1">
                <span>ğŸ•“</span>
              </span>
              <span class="font-semibold text-right" id="tray-last-used-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] last_used -->
                {{ tray_data.last_used }}
              </span>
            </div>

            {% if AUTO_SPEND and tray_data.matched %}
            <div class="flex items-center justify-between" data-remaining-weight-wrapper><!-- [LIVE-ID] wrapper -->
              <span class="text-gray-400 flex items-center gap-1">
                <span>âš–ï¸</span>
              </span>
              <span class="font-semibold text-right" id="tray-remaining-weight-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] remaining_weight -->
                {{ tray_data.remaining_weight|round }}g
              </span>
            </div>
            {% endif %}

            {% if tray_data.remain != -1 %}
            <div class="flex items-center justify-between" data-remain-wrapper><!-- [LIVE-ID] wrapper -->
              <span class="text-gray-400 flex items-center gap-1">
                <span>â³ï¸</span>
              </span>
              <span class="font-semibold text-right" id="tray-remain-{{ ams_id|string }}_{{ tray_data.id|string }}"><!-- [LIVE-ID] remain % -->
                {{ tray_data.remain }}%
              </span>
            </div>
            {% endif %}

          </div>
        </div>
      {% endif %}

      <div class="text-xs text-gray-400 flex justify-center gap-2 flex-wrap">
        {% if tray_data.tray_uuid != "00000000000000000000000000000000" %}
          <div class="flex items-center gap-1">
            <span class="text-[0.85rem]">ğŸ·ï¸</span>
            <span class="truncate max-w-[10rem]">{{ tray_data.tray_uuid }}</span>
          </div>
        {% endif %}
        <div class="flex items-center gap-1">
          <span class="text-[0.65rem] opacity-60">ğŸ§µ</span>
          <span>{{ tray_data.tray_info_idx }}</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="px-4 py-2 bg-gray-800 border-t border-gray-700 text-center">
      <a class="btn btn-primary"
         href="{{ url_for('filaments',
                          ams=ams_id,
                          tray=tray_id,
                          tray_uuid=tray_data.tray_uuid,
                          tray_info_idx=tray_data.tray_info_idx,
                          tray_color=tray_data.tray_color,
                          search=tray_data.tray_type) }}" data-requires-write>
        ğŸ§µ Assigner
      </a>
    </div>
  </div>
</div>
