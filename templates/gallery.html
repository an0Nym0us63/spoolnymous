{% extends "base.html" %}

{% block page_styles %}
<style>
    :root { --thumb-size: 180px; }
    html, body { height: 100%; }
    body { margin: 0; overflow-y: auto; background: var(--bs-body-bg); }
    .gallery-header {
      position: sticky; top: 0; z-index: 1030;
      backdrop-filter: blur(6px);
      background: color-mix(in oklab, var(--bs-body-bg) 85%, transparent);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .gallery-title {
      font-size: 1rem; margin: 0; line-height: 1;
    }
     /* au lieu de .grid / .thumb */
.g-grid {
  --g-thumb-size: 180px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(var(--g-thumb-size), 1fr));
  gap: .75rem;
}

.g-thumb {
  position: relative;
  border-radius: .75rem;
  overflow: hidden;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.06);
  aspect-ratio: 1 / 1;
  cursor: zoom-in;
  min-width: var(--g-thumb-size);
  min-height: var(--g-thumb-size);
}

.g-thumb img {
  width: 100%; height: 100%;
  object-fit: cover; object-position: center; display: block;
}

.g-thumb .name {
  position: absolute; left: .5rem; bottom: .5rem;
  background: rgba(0,0,0,.55); color: #fff;
  padding: .15rem .5rem; border-radius: .35rem;
  font-size: .8rem; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  pointer-events: none;
}

.g-thumb .del { position: absolute; top: .35rem; right: .35rem; z-index: 2; }

    /* Lightbox */
    .lightbox {
      position: fixed; inset: 0; z-index: 2000; display: none;
      background: rgba(0,0,0,.92);
    }
    .lightbox.open { display: grid; place-items: center; }
    .lightbox img {
      max-width: 92vw; max-height: 86vh; object-fit: contain; box-shadow: 0 0 0 1px rgba(255,255,255,.08);
      border-radius: .5rem;
    }
    .lb-toolbar {
      position: fixed; top: .5rem; left: .5rem; right: .5rem; display: flex; align-items: center; justify-content: space-between; gap: .5rem;
    }
    .lb-actions { display: flex; gap: .5rem; }
    .lb-index { color: #fff; opacity: .8; font-size: .9rem; }
    .lb-nav {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: space-between; pointer-events: none;
    }
    .lb-nav .btn {
      pointer-events: all; border-radius: 999px;
    }
    @media (max-width: 576px) {
      :root { --thumb-size: 140px; }
      .lb-index { display: none; }
    }
  </style>
{% endblock %}

{% block content %}


    <div class="text-end small text-body-secondary">
      <span id="jsCount">0</span> photo(s)
    </div>

<main class="container py-3">
  <div id="grid" class="g-grid"></div>
</main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" aria-hidden="true">
  <div class="lb-toolbar">
    <div class="lb-actions">
      <button id="lbClose" class="btn btn-light btn-sm" title="Fermer (Esc)"><i class="bi bi-x-lg"></i></button>
      <button id="lbDelete" class="btn btn-danger btn-sm" title="Supprimer" data-requires-write><i class="bi bi-trash3"></i></button>
      <span id="lbName" class="badge text-bg-dark"></span>
    </div>
    <div class="lb-index"><span id="lbIdx">1</span> / <span id="lbTotal">1</span></div>
  </div>
  <img id="lbImg" alt="">
  <div class="lb-nav px-2">
    <button id="lbPrev" class="btn btn-outline-light"><i class="bi bi-chevron-left"></i></button>
    <button id="lbNext" class="btn btn-outline-light"><i class="bi bi-chevron-right"></i></button>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}

{# Injection serveur facultative quand on POST /gallery #}
{% if images %}
<script>
  window.__IMAGES__ = {{ images|tojson }};
  {% if title %}window.__TITLE__ = {{ title|tojson }};{% endif %}
</script>
{% endif %}

<script>
(function () {
  'use strict';

  // --- Source des images ---
  function parseImagesFromQuery() {
    try {
      var p   = new URLSearchParams(location.search);
      var raw = p.get('images') || p.get('imgs');
      if (!raw) return null;

      // URLSearchParams renvoie déjà décodé ; on tente JSON direct
      var arr = null;
      try { arr = JSON.parse(raw); }
      catch(e1) {
        try { arr = JSON.parse(decodeURIComponent(raw)); }
        catch(e2) {
          console.error('parseImagesFromQuery failed', e1, e2);
          return null;
        }
      }
      if (!Array.isArray(arr)) return null;
      var out = [];
      for (var i=0;i<arr.length;i++) {
        var it = arr[i] || {};
        var url = it.url || it.href || it.src || '';
        if (url) out.push({ url: url, name: it.name || '' });
      }
      return out;
    } catch (e) {
      console.error('parseImagesFromQuery exception', e);
      return null;
    }
  }

  var images = (window.__IMAGES__ && Array.isArray(window.__IMAGES__)) ? window.__IMAGES__ : (parseImagesFromQuery() || []);
  var title  = (typeof window.__TITLE__ === 'string' && window.__TITLE__) ? window.__TITLE__ : (new URLSearchParams(location.search).get('title') || '');

  // --- Header (protégé si l’élément n’existe pas) ---
  var titleEl = document.getElementById('jsTitle');
  if (titleEl) titleEl.textContent = title ? '— ' + title : '';
  var countEl = document.getElementById('jsCount');
  if (countEl) countEl.textContent = images.length;

  // --- Grille ---
  var grid = document.getElementById('grid');
  if (!grid) {
    console.error('[gallery] #grid introuvable');
    return; // <- dans l’IIFE, donc légal
  }

  function makeThumb(img, i) {
    var card = document.createElement('div');
    card.className = 'g-thumb';
    card.setAttribute('data-url', img.url);

    var del = document.createElement('button');
    del.type  = 'button';
    del.className = 'btn btn-sm btn-outline-light del js-del-photo';
    del.title = 'Supprimer';
    del.setAttribute('data-url', img.url);
    if (/\.3mf$/i.test(img.url)) del.style.display = 'none';
    del.setAttribute('data-requires-write','');
    del.innerHTML = '<i class="bi bi-x-lg"></i>';

    var im = document.createElement('img');
    im.src = img.url;
    im.alt = (img.name || '');

    var name = document.createElement('div');
    name.className = 'name';
    name.textContent = img.name || '';

    card.appendChild(del);
    card.appendChild(im);
    card.appendChild(name);

    card.addEventListener('click', function(e){
      if (e.target.closest('.js-del-photo')) return;
      openLightbox(i);
    });

    return card;
  }

  for (var i=0;i<images.length;i++) {
    grid.appendChild(makeThumb(images[i], i));
  }

  // --- Lightbox ---
  var lb      = document.getElementById('lightbox');
  var lbImg   = document.getElementById('lbImg');
  var lbName  = document.getElementById('lbName');
  var lbIdx   = document.getElementById('lbIdx');
  var lbTot   = document.getElementById('lbTotal');
  var lbPrev  = document.getElementById('lbPrev');
  var lbNext  = document.getElementById('lbNext');
  var lbDel   = document.getElementById('lbDelete');
  var lbClose = document.getElementById('lbClose');
  var index   = 0;

  if (lbTot) lbTot.textContent = String(images.length);

  function render() {
    var it = images[index] || null;
    if (lbImg)  lbImg.src        = it ? it.url  : '';
    if (lbName) lbName.textContent = it ? (it.name || '') : '';
    if (lbIdx)  lbIdx.textContent  = String(index + 1);
    if (lbDel)  lbDel.style.display = (it && !/\.3mf$/i.test(it.url)) ? '' : 'none';
  }

  function openLightbox(i) {
    index = i;
    render();
    lb.classList.add('open');
    lb.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox() {
    lb.classList.remove('open');
    lb.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
  }
  function prev() { index = (index - 1 + images.length) % images.length; render(); }
  function next() { index = (index + 1) % images.length; render(); }

  if (lbPrev)  lbPrev.addEventListener('click', prev);
  if (lbNext)  lbNext.addEventListener('click', next);
  if (lbClose) lbClose.addEventListener('click', closeLightbox);

  document.addEventListener('keydown', function(e){
    if (!lb.classList.contains('open')) return;
    if (e.key === 'Escape')    closeLightbox();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight')next();
  });

  // --- Suppression ---
  async function deleteByUrl(fileUrl) {
    try {
      var u = new URL(fileUrl, window.location.origin);
      var parts = u.pathname.split('/').filter(Boolean);
      var upIdx = parts.indexOf('uploads');
      if (upIdx < 0 || parts.length < upIdx + 4) return false;

      var entity   = parts[upIdx + 1];
      var entityId = parts[upIdx + 2];
      var filename = parts[upIdx + 3];
      if (filename.toLowerCase().endsWith('.3mf')) return false;

      const ask = await Swal.fire({
        title: 'Supprimer la photo ?',
        text: filename,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d'
      });
      if (!ask.isConfirmed) return false;

      var fd = new FormData();
      fd.append('filename', filename);
      var resp = await fetch('/delete_photo/' + encodeURIComponent(entity) + '/' + encodeURIComponent(entityId), {
        method: 'POST',
        body: fd
      });
      if (!resp.ok) {
        Swal.fire('Erreur', 'La suppression a échoué.', 'error');
        return false;
      }

      // MAJ locale
      var idx = -1;
      for (var j=0;j<images.length;j++) if (images[j].url === fileUrl) { idx = j; break; }
      if (idx >= 0) {
        images.splice(idx, 1);
        // retire la vignette sans template literal
        var sel = '.g-thumb[data-url="' + fileUrl.replace(/"/g, '\\"') + '"]';
        var tile = grid.querySelector(sel);
        if (tile) tile.remove();
        if (countEl) countEl.textContent = images.length;
        if (lbTot)   lbTot.textContent   = String(images.length);
        if (images.length === 0) closeLightbox();
        else {
          if (index >= images.length) index = images.length - 1;
          render();
        }
      }

      Swal.fire('Supprimé', 'La photo a été supprimée.', 'success');
      return true;
    } catch (err) {
      Swal.fire('Erreur', 'Une erreur est survenue.', 'error');
      return false;
    }
  }

  document.addEventListener('click', function(e){
    var btn = e.target.closest('.js-del-photo');
    if (!btn) return;
    var url = btn.getAttribute('data-url') || '';
    deleteByUrl(url);
    e.stopPropagation();
  });

  if (lbDel) lbDel.addEventListener('click', function(){
    var it = images[index];
    if (it) deleteByUrl(it.url);
  });

})();
</script>
{% endblock %}
